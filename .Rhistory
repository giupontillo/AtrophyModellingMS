knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/data/anw/knw-work/g.pontillo/predictive_modelling/code/stats/AtrophyModelling")
packages <- c("dplyr", "ggplot2", "here", "nlme", "mgcv", "MuMIn", "gratia", "rsample", "gamclass", "purrr", "broom", "mgcViz", "Metrics")
lapply(packages, library, character.only = TRUE)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/data/anw/knw-work/g.pontillo/predictive_modelling/code/stats/AtrophyModelling")
packages <- c("dplyr", "ggplot2", "here", "nlme", "mgcv", "MuMIn", "gratia", "rsample", "gamclass", "purrr", "broom", "mgcViz", "Metrics")
lapply(packages, library, character.only = TRUE)
## import and transform
df_GAM <- read.csv(here::here("data/df_GAM.csv"), header = TRUE, sep = ",")
# add age and sex
df_baseline <- read.csv(here::here("data/df_baseline.csv"), header = TRUE, sep = ",")
View(df_baseline)
df_long <- read.csv(here::here("data/df_long.csv"), header = TRUE, sep = ",")
View(df_long)
df_long <- df_long %>% group_by(id) %>% mutate(total_fu_time = fu_time[which.max(fu_time)]) %>% ungroup()
View(df_long)
# atrophy rates
atrophy_long <- read.csv(here::here("data/atrophy_long/atrophy_long_SchaeferSubcortex114Parcels_individual_slopes.csv"), header = TRUE, sep = ",")
df <- data.frame(matrix(nrow = 0, ncol = 3))
colnames(df) <- c("atrophy_rate", "node", "id")
for (i in 1:dim(atrophy_long)[1]){
rates <- as.data.frame(t(atrophy_long[i,-1]))
rates <- tibble::rownames_to_column(rates)
rates$id <- rep(atrophy_long[i,1],114)
colnames(rates) <- c("node", "atrophy_rate", "id")
rates$node <- gsub("_slope", "", rates$node)
df <- rbind(df, rates)
}
# baseline atrophy
atrophy_cross <- read.csv(here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex114Parcels_individuals_wscore.csv"), header = TRUE, sep = ",")
df_atrophy_bl <- data.frame(matrix(nrow = 0, ncol = 3))
colnames(df_atrophy_bl) <- c("atrophy_bl", "node", "id")
for (i in 1:dim(atrophy_cross)[1]){
atrophy_bl <- as.data.frame(t(atrophy_cross[i,-1]))
atrophy_bl <- tibble::rownames_to_column(atrophy_bl)
atrophy_bl$id <- rep(atrophy_cross[i,1],114)
colnames(atrophy_bl) <- c("node", "atrophy_bl", "id")
atrophy_bl$node <- gsub("_wscore", "", atrophy_bl$node)
df_atrophy_bl <- rbind(df_atrophy_bl, atrophy_bl)
}
df <- merge(df, df_atrophy_bl, by = c("node", "id"))
# structural centrality
sc_matrix_ctx <- read.csv(here::here("data/hcp_connectivity/strucMatrix_ctx_schaefer_100.csv"), header = FALSE, sep = ",")
sc_centrality_ctx <- rowSums(sc_matrix_ctx)
sc_matrix_sctx <- read.csv(here::here("data/hcp_connectivity/strucMatrix_sctx_schaefer_100.csv"), header = FALSE, sep = ",")
sc_matrix_sctx <- sc_matrix_sctx[,1:100]
sc_centrality_sctx <- rowSums(sc_matrix_sctx)
sc_centrality <- as.data.frame(c(sc_centrality_ctx, sc_centrality_sctx))
colnames(sc_centrality) <- "sc_centrality"
sc_centrality$node <- gsub("_slope", "", colnames(atrophy_long[,-1]))
df <- merge(df, sc_centrality, by = c("node"))
# functional centrality
fc_matrix_ctx <- read.csv(here::here("data/hcp_connectivity/funcMatrix_ctx_schaefer_100.csv"), header = FALSE, sep = ",")
fc_centrality_ctx <- rowSums(fc_matrix_ctx)
fc_matrix_sctx <- read.csv(here::here("data/hcp_connectivity/funcMatrix_sctx_schaefer_100.csv"), header = FALSE, sep = ",")
fc_centrality_sctx <- rowSums(fc_matrix_sctx)
fc_centrality <- as.data.frame(c(fc_centrality_ctx, fc_centrality_sctx))
colnames(fc_centrality) <- "fc_centrality"
fc_centrality$node <- gsub("_slope", "", colnames(atrophy_long[,-1]))
df <- merge(df, fc_centrality, by = c("node"))
# parcel disconnection
disc_vector_ctx <- read.csv(here::here("data/disc/disc_SchaeferSubcortex114Parcels_individuals_ctx.csv"), header = TRUE, sep = ",")
disc_vector_sctx <- read.csv(here::here("data/disc/disc_SchaeferSubcortex114Parcels_individuals_sctx.csv"), header = TRUE, sep = ",")
df_disc <- as.data.frame(matrix(nrow = 0, ncol = 3))
colnames(df_disc) <- c("id","node","disc")
for (i in 1: dim(disc_vector_ctx)[1]){
disc_matrix <- matrix(0,nrow = 100, ncol = 100)
disc_matrix[upper.tri(disc_matrix)] <- unlist(disc_vector_ctx[i,-1])
disc_matrix[lower.tri(disc_matrix)] <- t(disc_matrix[lower.tri(disc_matrix)])
disc_ctx <- rowSums(disc_matrix)
disc_matrix_sctx <- matrix(unlist(disc_vector_sctx[i,-1]), 14, 100)
disc_sctx <- rowSums(disc_matrix_sctx)
disc <- data.frame(matrix(nrow = 114, ncol = 3))
colnames(disc) <- c("id","node","disc")
disc$disc <- c(disc_ctx, disc_sctx)
disc$id <- rep(gsub("_ses-01|_ses-Y05", "",disc_vector_ctx[i,1]),114)
disc$node <- gsub("_slope", "", colnames(atrophy_long[,-1]))
df_disc <- rbind(df_disc, disc)
}
# atrophy rates
atrophy_long <- read.csv(here::here("data/atrophy_long/atrophy_long_SchaeferSubcortex114Parcels_individual_slopes.csv"), header = TRUE, sep = ",")
df <- data.frame(matrix(nrow = 0, ncol = 3))
colnames(df) <- c("atrophy_rate", "node", "id")
for (i in 1:dim(atrophy_long)[1]){
rates <- as.data.frame(t(atrophy_long[i,-1]))
rates <- tibble::rownames_to_column(rates)
rates$id <- rep(atrophy_long[i,1],114)
colnames(rates) <- c("node", "atrophy_rate", "id")
rates$node <- gsub("_slope", "", rates$node)
df <- rbind(df, rates)
}
# baseline atrophy
atrophy_cross <- read.csv(here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex114Parcels_individuals_wscore.csv"), header = TRUE, sep = ",")
df_atrophy_bl <- data.frame(matrix(nrow = 0, ncol = 3))
colnames(df_atrophy_bl) <- c("atrophy_bl", "node", "id")
for (i in 1:dim(atrophy_cross)[1]){
atrophy_bl <- as.data.frame(t(atrophy_cross[i,-1]))
atrophy_bl <- tibble::rownames_to_column(atrophy_bl)
atrophy_bl$id <- rep(atrophy_cross[i,1],114)
colnames(atrophy_bl) <- c("node", "atrophy_bl", "id")
atrophy_bl$node <- gsub("_wscore", "", atrophy_bl$node)
df_atrophy_bl <- rbind(df_atrophy_bl, atrophy_bl)
}
df <- merge(df, df_atrophy_bl, by = c("node", "id"))
# structural centrality
sc_matrix_ctx <- read.csv(here::here("data/hcp_connectivity/strucMatrix_ctx_schaefer_100.csv"), header = FALSE, sep = ",")
sc_centrality_ctx <- rowSums(sc_matrix_ctx)
sc_matrix_sctx <- read.csv(here::here("data/hcp_connectivity/strucMatrix_sctx_schaefer_100.csv"), header = FALSE, sep = ",")
sc_matrix_sctx <- sc_matrix_sctx[,1:100]
sc_centrality_sctx <- rowSums(sc_matrix_sctx)
sc_centrality <- as.data.frame(c(sc_centrality_ctx, sc_centrality_sctx))
colnames(sc_centrality) <- "sc_centrality"
sc_centrality$node <- gsub("_slope", "", colnames(atrophy_long[,-1]))
df <- merge(df, sc_centrality, by = c("node"))
# functional centrality
fc_matrix_ctx <- read.csv(here::here("data/hcp_connectivity/funcMatrix_ctx_schaefer_100.csv"), header = FALSE, sep = ",")
fc_centrality_ctx <- rowSums(fc_matrix_ctx)
fc_matrix_sctx <- read.csv(here::here("data/hcp_connectivity/funcMatrix_sctx_schaefer_100.csv"), header = FALSE, sep = ",")
fc_centrality_sctx <- rowSums(fc_matrix_sctx)
fc_centrality <- as.data.frame(c(fc_centrality_ctx, fc_centrality_sctx))
colnames(fc_centrality) <- "fc_centrality"
fc_centrality$node <- gsub("_slope", "", colnames(atrophy_long[,-1]))
df <- merge(df, fc_centrality, by = c("node"))
# parcel disconnection
disc_vector_ctx <- read.csv(here::here("data/disc/disc_SchaeferSubcortex114Parcels_individuals_ctx.csv"), header = TRUE, sep = ",")
disc_vector_sctx <- read.csv(here::here("data/disc/disc_SchaeferSubcortex114Parcels_individuals_sctx.csv"), header = TRUE, sep = ",")
df_disc <- as.data.frame(matrix(nrow = 0, ncol = 3))
colnames(df_disc) <- c("id","node","disc")
for (i in 1: dim(disc_vector_ctx)[1]){
disc_matrix <- matrix(0,nrow = 100, ncol = 100)
disc_matrix[upper.tri(disc_matrix)] <- unlist(disc_vector_ctx[i,-1])
disc_matrix[lower.tri(disc_matrix)] <- t(disc_matrix[lower.tri(disc_matrix)])
disc_ctx <- rowSums(disc_matrix)
disc_matrix_sctx <- matrix(unlist(disc_vector_sctx[i,-1]), 14, 100)
disc_sctx <- rowSums(disc_matrix_sctx)
disc <- data.frame(matrix(nrow = 114, ncol = 3))
colnames(disc) <- c("id","node","disc")
disc$disc <- c(disc_ctx, disc_sctx)
disc$id <- rep(gsub("_ses-01|_ses-Y05", "",disc_vector_ctx[i,1]),114)
disc$node <- gsub("_slope", "", colnames(atrophy_long[,-1]))
df_disc <- rbind(df_disc, disc)
}
df <- merge(df, df_disc, by = c("id", "node"))
# structural neighbourhood atrophy
neighbourhood_atrophy_sc_ctx <- read.csv(here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_individuals_sc_ctx.csv"), header = TRUE, sep = ",")
neighbourhood_atrophy_sc_sctx <- read.csv(here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_individuals_sc_sctx.csv"), header = TRUE, sep = ",")
neighbourhood_atrophy_sc <- merge(neighbourhood_atrophy_sc_ctx,neighbourhood_atrophy_sc_sctx, by = "id")
df_neighbourhood_atrophy_sc <- data.frame(matrix(nrow = 0, ncol = 3))
colnames(df_neighbourhood_atrophy_sc) <- c("neighbourhood_atrophy_sc", "node", "id")
for (i in 1:dim(neighbourhood_atrophy_sc)[1]){
atrophy_sc <- as.data.frame(t(neighbourhood_atrophy_sc[i,-1]))
atrophy_sc <- tibble::rownames_to_column(atrophy_sc)
atrophy_sc$id <- rep(neighbourhood_atrophy_sc[i,1],114)
colnames(atrophy_sc) <- c("node", "neighbourhood_atrophy_sc", "id")
atrophy_sc$node <- gsub("_wscore_neighbours", "", atrophy_sc$node)
df_neighbourhood_atrophy_sc <- rbind(df_neighbourhood_atrophy_sc, atrophy_sc)
}
df <- merge(df, df_neighbourhood_atrophy_sc, by = c("node", "id"))
# functional neighbourhood atrophy
neighbourhood_atrophy_fc_ctx <- read.csv(here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_individuals_fc_ctx.csv"), header = TRUE, sep = ",")
neighbourhood_atrophy_fc_sctx <- read.csv(here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_individuals_fc_sctx.csv"), header = TRUE, sep = ",")
neighbourhood_atrophy_fc <- merge(neighbourhood_atrophy_fc_ctx,neighbourhood_atrophy_fc_sctx, by = "id")
df_neighbourhood_atrophy_fc <- data.frame(matrix(nrow = 0, ncol = 3))
colnames(df_neighbourhood_atrophy_fc) <- c("neighbourhood_atrophy_fc", "node", "id")
for (i in 1:dim(neighbourhood_atrophy_fc)[1]){
atrophy_fc <- as.data.frame(t(neighbourhood_atrophy_fc[i,-1]))
atrophy_fc <- tibble::rownames_to_column(atrophy_fc)
atrophy_fc$id <- rep(neighbourhood_atrophy_fc[i,1],114)
colnames(atrophy_fc) <- c("node", "neighbourhood_atrophy_fc", "id")
atrophy_fc$node <- gsub("_wscore_neighbours", "", atrophy_fc$node)
df_neighbourhood_atrophy_fc <- rbind(df_neighbourhood_atrophy_fc, atrophy_fc)
}
df <- merge(df, df_neighbourhood_atrophy_fc, by = c("node", "id"))
# GE neighbour atrophy
neighbourhood_atrophy_cge_ctx <- read.csv(here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_individuals_cge_ctx.csv"), header = TRUE, sep = ",")
neighbourhood_atrophy_cge_sctx <- read.csv(here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_individuals_cge_sctx.csv"), header = TRUE, sep = ",")
neighbourhood_atrophy_cge <- merge(neighbourhood_atrophy_cge_ctx,neighbourhood_atrophy_cge_sctx, by = "id")
df_neighbourhood_atrophy_cge <- data.frame(matrix(nrow = 0, ncol = 3))
colnames(df_neighbourhood_atrophy_cge) <- c("neighbourhood_atrophy_cge", "node", "id")
for (i in 1:dim(neighbourhood_atrophy_cge)[1]){
atrophy_cge <- as.data.frame(t(neighbourhood_atrophy_cge[i,-1]))
atrophy_cge <- tibble::rownames_to_column(atrophy_cge)
atrophy_cge$id <- rep(neighbourhood_atrophy_cge[i,1],114)
colnames(atrophy_cge) <- c("node", "neighbourhood_atrophy_cge", "id")
atrophy_cge$node <- gsub("_wscore_neighbours", "", atrophy_cge$node)
df_neighbourhood_atrophy_cge <- rbind(df_neighbourhood_atrophy_cge, atrophy_cge)
}
df <- merge(df, df_neighbourhood_atrophy_cge, by = c("node", "id"))
# coordinates
coords <- read.csv(here::here("data/Schaefer100_Subcortex_coords.csv"), header = FALSE, sep = ",")
df_coords <- data.frame(matrix(nrow = 114, ncol = 4))
colnames(df_coords) <- c("node", "x", "y", "z")
df_coords$node <- gsub("_slope", "", colnames(atrophy_long[,-1]))
df_coords[,2:4] <- coords[,3:5]
df <- merge(df, df_coords, by = "node")
# cortical/subcortical
df <- df %>% mutate(subcortical = case_when (
grepl("network", node) ~ "0",
!grepl("network", node) ~ "1"))
# add age and sex
df_baseline <- read.csv(here::here("data/df_baseline.csv"), header = TRUE, sep = ",")
age_sex <- df_baseline[,c("id", "age", "sex")]
df <- merge(df, age_sex, by = "id")
# fu time duration and site
df_long <- read.csv(here::here("data/df_long.csv"), header = TRUE, sep = ",")
df_long <- df_long %>% group_by(id) %>% mutate(fu_time_duration = fu_time[which.max(fu_time)]) %>% ungroup()
fu_time_duration_site <- df_long[,c("id", "fu_time_duration", "site")]
df <- merge(df, fu_time_duration, by = "id")
df <- merge(df, fu_time_duration_site, by = "id")
View(df)
# write out
write.csv(df, here::here("data/df_GAM.csv"), row.names = FALSE)
## import and transform
df_GAM <- read.csv(here::here("data/df_GAM.csv"), header = TRUE, sep = ",")
## model fitting and comparison
model_gam <- bam(atrophy_rate ~ s(atrophy_bl) + s(sc_centrality) + s(fc_centrality) + s(disc) + s(neighbourhood_atrophy_sc) + s(neighbourhood_atrophy_fc) + s(neighbourhood_atrophy_cge) + s(x,y,z) + s(age) + s(fu_time_duration) + sex + subcortical + site + s(id, bs = 're') + s(node, bs = 're') + s(atrophy_bl, node, bs = 're'), data = df_GAM, na.action = na.fail, method = "fREML", select = TRUE)
View(df_GAM)
## model fitting and comparison
model_gam <- bam(atrophy_rate ~ s(atrophy_bl) + s(sc_centrality) + s(fc_centrality) + s(disc) + s(neighbourhood_atrophy_sc) + s(neighbourhood_atrophy_fc) + s(neighbourhood_atrophy_cge) + s(x,y,z) + s(age) + s(fu_time_duration) + sex + subcortical + s(id, bs = 're') + s(node, bs = 're') + s(atrophy_bl, node, bs = 're'), data = df_GAM, na.action = na.fail, method = "fREML", select = TRUE)
## model fitting and comparison
model_gam <- bam(atrophy_rate ~ s(atrophy_bl) + s(sc_centrality) + s(fc_centrality) + s(disc) + s(neighbourhood_atrophy_sc) + s(neighbourhood_atrophy_fc) + s(neighbourhood_atrophy_cge) + s(x,y,z) + s(age) + sex + subcortical + s(id, bs = 're') + s(node, bs = 're') + s(atrophy_bl, node, bs = 're'), data = df_GAM, na.action = na.fail, method = "fREML", select = TRUE)
View(df_GAM)
df_GAM$node <- as.factor(df_GAM$node)
df_GAM$id <- as.factor(df_GAM$id)
df_GAM$subcortical <- as.factor(df_GAM$subcortical)
df_GAM$sex <- as.factor(df_GAM$sex)
df_GAM$site <- as.factor(df_GAM$site)
## model fitting and comparison
model_gam <- bam(atrophy_rate ~ s(atrophy_bl) + s(sc_centrality) + s(fc_centrality) + s(disc) + s(neighbourhood_atrophy_sc) + s(neighbourhood_atrophy_fc) + s(neighbourhood_atrophy_cge) + s(x,y,z) + s(age) + sex + subcortical + s(id, bs = 're') + s(node, bs = 're') + s(atrophy_bl, node, bs = 're'), data = df_GAM, na.action = na.fail, method = "fREML", select = TRUE)
## model fitting and comparison
model_gam <- bam(atrophy_rate ~ s(atrophy_bl) + s(sc_centrality) + s(fc_centrality) + s(disc) + s(neighbourhood_atrophy_sc) + s(neighbourhood_atrophy_fc) + s(neighbourhood_atrophy_cge) + s(x,y,z) + s(age) + s(fu_time_duration) + sex + subcortical + site + s(id, bs = 're') + s(node, bs = 're') + s(atrophy_bl, node, bs = 're'), data = df_GAM, na.action = na.fail, method = "fREML", select = TRUE)
summary(model_gam)
b <- getViz(model_gam)
plot_GAM <- plot(b, allTerms = TRUE)
plot_GAM
plot_GAM_new <- plot_GAM
# load data
load(here("data/GAM_modelling.RData"))
# model diagnostics
check_GAM <- appraise(model_gam)
check_GAM
plot_GAM <- plot(b, allTerms = TRUE)
b <- getViz(model_gam)
plot_GAM <- plot(b, allTerms = TRUE)
plot_GAM
## model fitting and comparison
model_gam <- bam(atrophy_rate ~ s(atrophy_bl) + s(sc_centrality) + s(fc_centrality) + s(disc) + s(neighbourhood_atrophy_sc) + s(neighbourhood_atrophy_fc) + s(neighbourhood_atrophy_cge) + s(x,y,z) + s(age) + s(fu_time_duration) + sex + subcortical + site + s(id, bs = 're') + s(node, bs = 're') + s(atrophy_bl, node, bs = 're'), data = df_GAM, na.action = na.fail, method = "fREML", select = TRUE, discrete = TRUE)
summary(model_gam)
b <- getViz(model_gam)
plot_GAM <- plot(b, allTerms = TRUE)
plot_GAM
model_gam_bl <- bam(atrophy_rate ~ s(atrophy_bl) + s(x,y,z) + s(age) + s(fu_time_duration) + sex + subcortical + site + s(id, bs = 're') + s(node, bs = 're') + s(atrophy_bl, node, bs = 're'), data = df_GAM, na.action = na.fail, method = "fREML", select = TRUE, discrete = TRUE, nthreads = 2)
summary(model_gam_bl)
?anova()
anova_test <- anova(model_gam_bl, model_gam)
anova_test
anova_test1 <- anova(model_gam_bl, model_gam, test = "LRT")
anova_test1
## LOOCV
custom_cvparts <- group_vfold_cv(df_GAM, group = id)
mod_form <- as.formula(atrophy_rate ~ s(atrophy_bl) + s(sc_centrality) + s(fc_centrality) + s(disc) + s(neighbourhood_atrophy_sc) + s(neighbourhood_atrophy_fc) + s(neighbourhood_atrophy_cge) + s(x,y,z) + s(age) + s(fu_time_duration) + sex + subcortical + site + s(id, bs = 're') + s(node, bs = 're') + s(atrophy_bl, node, bs = 're'))
mod_form_bl <- as.formula(atrophy_rate ~ s(atrophy_bl) + s(x,y,z) + s(age) + s(fu_time_duration) + sex + subcortical + site + sex + subcortical + s(id, bs = 're') + s(node, bs = 're') + s(atrophy_bl, node, bs = 're'))
holdout_results <- function(splits, ...){
# fit the model
mod <- bam(..., data = analysis(splits), na.action = na.fail, method = "fREML", select = TRUE, discrete = TRUE, nthreads = 2)
# apply the model and assess performance
holdout <- assessment(splits)
res <- broom::augment(mod, newdata = holdout)
performance <- data.frame(matrix(nrow = 1, ncol = 3))
colnames(performance) <- c("pearsonr", "RMSE", "MAE")
performance$pearsonr <- cor(res$.fitted, holdout$atrophy_rate, method = "pearson")
performance$RMSE <- rmse(holdout$atrophy_rate, res$.fitted)
performance$MAE <- mae(holdout$atrophy_rate, res$.fitted)
output <- list(res, performance)
# return output
return(output)
}
LOOCV <- purrr::map(custom_cvparts$splits, holdout_results, mod_form)
knitr::purl(here("scripts/GAM_modelling.Rmd"))
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/data/anw/knw-work/g.pontillo/predictive_modelling/code/stats/AtrophyModelling")
packages <- c("dplyr", "ggplot2", "here", "nlme", "mgcv", "MuMIn", "gratia", "rsample", "gamclass", "purrr", "broom", "mgcViz", "Metrics")
lapply(packages, library, character.only = TRUE)
# load data
load(here("data/GAM_LOOCV.RData"))
mean_pearsonr <- mean(unlist(lapply(lapply(LOOCV_bl, '[[', 2), '[[', "pearsonr")))
mean_pearsonr <- mean(unlist(lapply(lapply(LOOCV, '[[', 2), '[[', "pearsonr")))
mean_rmse <- mean(unlist(lapply(lapply(LOOCV, '[[', 2), '[[', "RMSE")))
mean_rmse <- mean(unlist(lapply(lapply(LOOCV_bl, '[[', 2), '[[', "RMSE")))
hist(unlist(lapply(lapply(LOOCV, '[[', 2), '[[', "pearsonr")))
hist(unlist(lapply(lapply(LOOCV, '[[', 2), '[[', "rmse")))
hist(unlist(lapply(lapply(LOOCV, '[[', 2), '[[', "RMSE")))
hist(unlist(lapply(lapply(LOOCV, '[[', 2), '[[', "pearsonr")))
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/data/anw/knw-work/g.pontillo/predictive_modelling/code/stats/AtrophyModelling")
packages <- c("dplyr", "ggplot2", "here", "nlme", "mgcv", "MuMIn", "gratia", "rsample", "gamclass", "purrr", "broom", "mgcViz", "Metrics", "cowplot")
lapply(packages, library, character.only = TRUE)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/data/anw/knw-work/g.pontillo/predictive_modelling/code/stats/AtrophyModelling")
packages <- c("dplyr", "ggplot2", "here", "nlme", "mgcv", "MuMIn", "gratia", "rsample", "gamclass", "purrr", "broom", "mgcViz", "Metrics", "cowplot")
lapply(packages, library, character.only = TRUE)
# load data
load(here("data/GAM_modelling.RData"))
summary(model_gam)
plot_GAM <- draw(model_gam, residuals = TRUE)
plot_GAM
b <- getViz(model_gam)
plot_GAM <- print(plot(b, allTerms = TRUE), pages = 1)
plot_GAM
plot_GAM <-
print(plot(b, allTerms = TRUE), pages = 1)
png(file=here("data/plot_GAM.png"))
print(plot(b, allTerms = TRUE), pages = 1)
dev.off()
?print
png(file=here("data/plot_GAM.png"), width = 2000, height = 2000, dpi = 600)
?png
png(file=here("data/plot_GAM.png"), width = 2000, height = 2000, res = 600)
print(plot(b, allTerms = TRUE), pages = 1)
dev.off()
png(file=here("data/plot_GAM.png"), width = 10000, height = 10000, res = 600)
print(plot(b, allTerms = TRUE), pages = 1)
dev.off()
png(file=here("data/plot_GAM.png"), width = 8000, height = 8000, res = 600)
print(plot(b, allTerms = TRUE), pages = 1)
dev.off()
summary(model_gam)
summary(model_gam_bl)
summary(model_gam)
## import and transform
df_GAM <- read.csv(here::here("data/df_GAM.csv"), header = TRUE, sep = ",")
View(df_GAM)
mean(df_GAM$atrophy_rate)
summary(model_gam)
df_GAM$node <- as.factor(df_GAM$node)
df_GAM$id <- as.factor(df_GAM$id)
df_GAM$subcortical <- as.factor(df_GAM$subcortical)
df_GAM$sex <- as.factor(df_GAM$sex)
df_GAM$site <- as.factor(df_GAM$site)
model_gam <- bam(atrophy_rate ~ s(atrophy_bl) + s(sc_centrality) + s(fc_centrality) + s(disc) + s(neighbourhood_atrophy_sc) + s(neighbourhood_atrophy_fc) + s(neighbourhood_atrophy_cge) + s(x,y,z) + s(age) + sex + subcortical + s(id, bs = 're') + s(node, bs = 're') + s(atrophy_bl, node, bs = 're'), data = df_GAM, na.action = na.fail, method = "fREML", select = TRUE, discrete = TRUE,nthreads = 8)
summary(model_gam)
?bam()
model_gam <- bam(atrophy_rate ~ s(atrophy_bl) + s(sc_centrality) + s(fc_centrality) + s(disc) + s(neighbourhood_atrophy_sc) + s(neighbourhood_atrophy_fc) + s(neighbourhood_atrophy_cge) + s(x,y,z) + s(age) + sex + subcortical + s(id, bs = 're') + s(node, bs = 're') + s(atrophy_bl, node, bs = 're'), data = df_GAM, na.action = na.fail, method = "fREML", select = TRUE, discrete = FALSE,nthreads = 8)
summary(model_gam)
## import and transform
df_GAM <- read.csv(here::here("data/df_GAM.csv"), header = TRUE, sep = ",")
df_GAM$node <- as.factor(df_GAM$node)
df_GAM$id <- as.factor(df_GAM$id)
df_GAM$subcortical <- as.factor(df_GAM$subcortical)
df_GAM$sex <- as.factor(df_GAM$sex)
df_GAM$site <- as.factor(df_GAM$site)
## model fitting and comparison
model_gam <- bam(atrophy_rate ~ s(atrophy_bl) + s(sc_centrality) + s(fc_centrality) + s(disc) + s(neighbourhood_atrophy_sc) + s(neighbourhood_atrophy_fc) + s(neighbourhood_atrophy_cge) + s(x,y,z) + s(age) + s(fu_time_duration) + sex + subcortical + site + s(id, bs = 're') + s(node, bs = 're') + s(atrophy_bl, node, bs = 're'), data = df_GAM, na.action = na.fail, method = "fREML", select = TRUE, discrete = FALSE,nthreads = 8)
model_gam_bl <- bam(atrophy_rate ~ s(atrophy_bl) + s(x,y,z) + s(age) + s(fu_time_duration) + sex + subcortical + site + s(id, bs = 're') + s(node, bs = 're') + s(atrophy_bl, node, bs = 're'), data = df_GAM, na.action = na.fail, method = "fREML", select = TRUE, discrete = FALSE, nthreads = 8)
anova_test <- anova(model_gam_bl, model_gam, test = "LRT")
AIC_test <- AIC(model_gam_bl, model_gam)
# save
save(model_gam, model_gam_bl, anova_test, AIC_test, file = here("data/GAM_modelling.RData"))
# load data
load(here("data/GAM_modelling.RData"))
# model diagnostics
check_GAM <- appraise(model_gam)
ggsave(here("data/check_GAM.png"), plot = check_GAM, dpi = 300)
b <- getViz(model_gam)
png(file=here("data/plot_GAM.png"), width = 8000, height = 8000, res = 600)
print(plot(b, allTerms = TRUE), pages = 1)
dev.off()
summary(model_gam)
model_gam <- bam(atrophy_rate ~ s(atrophy_bl) + s(sc_centrality) + s(fc_centrality) + s(disc) + s(neighbourhood_atrophy_sc) + s(neighbourhood_atrophy_fc) + s(neighbourhood_atrophy_cge) + s(x,y,z) + s(age) + s(fu_time_duration) + sex + subcortical + site + s(id, bs = 're') + s(node, bs = 're') + s(atrophy_bl, node, bs = 're'), data = df_GAM, na.action = na.fail, method = "fREML", select = FALSE, discrete = FALSE,nthreads = 8)
summary(model_gam)
model_gam <- bam(atrophy_rate ~ s(atrophy_bl) + s(sc_centrality) + s(fc_centrality) + s(disc) + s(neighbourhood_atrophy_sc) + s(neighbourhood_atrophy_fc) + s(neighbourhood_atrophy_cge) + s(x,y,z) + s(age) + sex + subcortical + s(id, bs = 're') + s(node, bs = 're') + s(atrophy_bl, node, bs = 're'), data = df_GAM, na.action = na.fail, method = "fREML", select = FALSE, discrete = FALSE,nthreads = 8)
summary(model_gam)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/data/anw/knw-work/g.pontillo/predictive_modelling/code/stats/AtrophyModelling")
packages <- c("dplyr", "ggplot2", "here", "nlme", "mgcv", "MuMIn", "gratia", "rsample", "gamclass", "purrr", "broom", "mgcViz", "Metrics", "cowplot")
lapply(packages, library, character.only = TRUE)
## import and transform
df_GAM <- read.csv(here::here("data/df_GAM.csv"), header = TRUE, sep = ",")
df_GAM$node <- as.factor(df_GAM$node)
df_GAM$id <- as.factor(df_GAM$id)
df_GAM$subcortical <- as.factor(df_GAM$subcortical)
df_GAM$sex <- as.factor(df_GAM$sex)
df_GAM$site <- as.factor(df_GAM$site)
model_gam <- bam(atrophy_rate ~ s(atrophy_bl) + s(sc_centrality) + s(fc_centrality) + s(disc) + s(neighbourhood_atrophy_sc) + s(neighbourhood_atrophy_fc) + s(neighbourhood_atrophy_cge) + s(x,y,z) + s(age) + sex + subcortical + s(id, bs = 're') + s(node, bs = 're') + s(atrophy_bl, node, bs = 're'), data = df_GAM, na.action = na.fail, method = "fREML", select = FALSE, discrete = FALSE,nthreads = 8)
model_gam_select <- bam(atrophy_rate ~ s(atrophy_bl) + s(sc_centrality) + s(fc_centrality) + s(disc) + s(neighbourhood_atrophy_sc) + s(neighbourhood_atrophy_fc) + s(neighbourhood_atrophy_cge) + s(x,y,z) + s(age) + sex + subcortical + s(id, bs = 're') + s(node, bs = 're') + s(atrophy_bl, node, bs = 're'), data = df_GAM, na.action = na.fail, method = "fREML", select = TRUE, discrete = FALSE,nthreads = 8)
model_gam_bl <- bam(atrophy_rate ~ s(atrophy_bl) + s(x,y,z) + s(age) + sex + subcortical + s(id, bs = 're') + s(node, bs = 're') + s(atrophy_bl, node, bs = 're'), data = df_GAM, na.action = na.fail, method = "fREML", select = FALSE, discrete = FALSE, nthreads = 8)
model_gam_bl_select <- bam(atrophy_rate ~ s(atrophy_bl) + s(x,y,z) + s(age) + sex + subcortical + s(id, bs = 're') + s(node, bs = 're') + s(atrophy_bl, node, bs = 're'), data = df_GAM, na.action = na.fail, method = "fREML", select = TRUE, discrete = FALSE, nthreads = 8)
anova_test <- anova(model_gam_bl, model_gam, test = "LRT")
anova_test_select <- anova(model_gam_bl_select, model_gam_slect, test = "LRT")
anova_test_select <- anova(model_gam_bl_select, model_gam_select, test = "LRT")
AIC_test <- AIC(model_gam_bl, model_gam)
AIC_test_select <- AIC(model_gam_bl_select, model_gam_select)
# save
save(model_gam, model_gam_bl, anova_test, AIC_test, model_gam_select, model_gam_bl_select, anova_test_select, AIC_test_select, file = here("data/GAM_modelling.RData"))
# load data
load(here("data/GAM_modelling.RData"))
# model diagnostics
check_GAM <- appraise(model_gam)
ggsave(here("data/check_GAM.png"), plot = check_GAM, dpi = 300)
check_GAM_select <- appraise(model_gam_select)
ggsave(here("data/check_GAM_select.png"), plot = check_GAM_select, dpi = 300)
b <- getViz(model_gam)
png(file=here("data/plot_GAM.png"), width = 8000, height = 8000, res = 600)
print(plot(b, allTerms = TRUE), pages = 1)
dev.off()
b_select <- getViz(model_gam_select)
png(file=here("data/plot_GAM_select.png"), width = 8000, height = 8000, res = 600)
print(plot(b_select, allTerms = TRUE), pages = 1)
dev.off()
summary_model_gam
summary(model_gam)
summary(model_gam_select)
View(anova_test)
View(anova_test_select)
View(AIC_test_select)
View(AIC_test)
View(AIC_test_select)
View(AIC_test)
summary(model_gam_bl_select)
summary(model_gam_select)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/data/anw/knw-work/g.pontillo/predictive_modelling/code/stats/AtrophyModelling")
system("export LD_LIBRARY_PATH=/opt/aumc-apps-eb/software/Anaconda3/2024.02-1/lib")
packages <- c("dplyr", "ggplot2", "here", "corrplot", "nlme", "psych", "effsize", "janitor", "R.matlab", "reticulate","rstudioapi")
lapply(packages, library, character.only = TRUE)
## SchaeferSubcortex 114 parcels
hydra_labels <- read.csv(here::here("output/old/output/hydra_SchaeferSubcortex114Parcels/clustering/clustering_assignment.tsv"), sep = "\t")
hydra_labels$assignment_2 <- factor(hydra_labels$assignment_2, levels = c("-1", "1", "2"))
hydra_ARI <- as.data.frame(t(read.csv(here::here("output/old/output/hydra_SchaeferSubcortex114Parcels/clustering/adjusted_rand_index.tsv"), sep = "\t", header = FALSE)))
colnames(hydra_ARI) <- c("N_subtypes", "ARI")
hydra_ARI$ARI <- as.numeric(hydra_ARI$ARI)
ggplot(data=hydra_ARI, aes(x=N_subtypes, y=ARI, group=1)) +
geom_line()+
geom_point()+
ylim(0,0.8)
ARI_plot <- ggplot(data=hydra_ARI, aes(x=N_subtypes, y=ARI, group=1)) +
geom_line()+
geom_point()+
ylim(0,0.8)
ggsave(here("data/ARI_plot.png"), plot = ARI_plot, dpi = 300)
ARI_plot <- ggplot(data=hydra_ARI, aes(x=N_subtypes, y=ARI, group=1)) +
geom_line()+
geom_point()+
ylim(0,0.8) +
theme_minimal()
ggsave(here("data/ARI_plot.png"), plot = ARI_plot, dpi = 300)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/data/anw/knw-work/g.pontillo/predictive_modelling/code/stats/AtrophyModelling")
system("export LD_LIBRARY_PATH=/opt/aumc-apps-eb/software/Anaconda3/2024.02-1/lib")
packages <- c("dplyr", "ggplot2", "here", "corrplot", "nlme", "psych", "effsize", "janitor", "R.matlab", "reticulate","rstudioapi")
lapply(packages, library, character.only = TRUE)
hydra_ARI <- as.data.frame(t(read.csv(here::here("output/old/output/hydra_SchaeferSubcortex114Parcels/clustering/adjusted_rand_index.tsv"), sep = "\t", header = FALSE)))
hydra_ARI
colnames(hydra_ARI) <- c("N_subtypes", "ARI")
hydra_ARI$N_subtypes <- c("1", "2", "3", "4", "5")
hydra_ARI
ARI_plot <- ggplot(data=hydra_ARI, aes(x=N_subtypes, y=ARI, group=1)) +
geom_line(color="black", linetype = "solid") +
geom_point(shape=19, color="black") +
ylim(0,0.8) +
labs(title = "HYDRA", x = "K", y = "ARI") +
theme_minimal()
ggsave(here("data/ARI_plot.png"), plot = ARI_plot, dpi = 300)
hydra_ARI
class(hydra_ARI$N_subtypes)
class(hydra_ARI$ARI)
hydra_ARI$ARI <- as.numeric(hydra_ARI$ARI)
ARI_plot <- ggplot(data=hydra_ARI, aes(x=N_subtypes, y=ARI, group=1)) +
geom_line(color="black", linetype = "solid") +
geom_point(shape=19, color="black") +
ylim(0,0.8) +
labs(title = "HYDRA", x = "K", y = "ARI") +
theme_minimal()
ggsave(here("data/ARI_plot.png"), plot = ARI_plot, dpi = 300)
ARI_plot <- ggplot(data=hydra_ARI, aes(x=N_subtypes, y=ARI, group=1)) +
geom_line(color="black", linetype = "solid") +
geom_point(shape=19, color="black") +
ylim(0,0.8) +
labs(title = "HYDRA", x = "K", y = "ARI") +
theme_minimal(base_size = 18)
ggsave(here("data/ARI_plot.png"), plot = ARI_plot, dpi = 300)
ARI_plot <- ggplot(data=hydra_ARI, aes(x=N_subtypes, y=ARI, group=1)) +
geom_line(color="black", linetype = "solid") +
geom_point(shape=19, color="black") +
ylim(0,0.8) +
labs(title = "HYDRA", x = "k", y = "ARI") +
theme_minimal(base_size = 18)
ggsave(here("data/ARI_plot.png"), plot = ARI_plot, dpi = 300)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/data/anw/knw-work/g.pontillo/predictive_modelling/code/stats/AtrophyModelling")
packages <- c("dplyr", "ggplot2", "here", "nlme", "mgcv", "MuMIn", "gratia", "rsample", "gamclass", "purrr", "broom", "mgcViz", "Metrics", "cowplot")
lapply(packages, library, character.only = TRUE)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/data/anw/knw-work/g.pontillo/predictive_modelling/code/stats/AtrophyModelling")
packages <- c("dplyr", "ggplot2", "here", "nlme", "mgcv", "MuMIn", "gratia", "rsample", "gamclass", "purrr", "broom", "mgcViz", "Metrics", "cowplot")
lapply(packages, library, character.only = TRUE)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/data/anw/knw-work/g.pontillo/predictive_modelling/code/stats/AtrophyModelling")
packages <- c("dplyr", "ggplot2", "here", "nlme", "mgcv", "gratia", "rsample", "gamclass", "purrr", "broom", "mgcViz", "Metrics", "cowplot")
lapply(packages, library, character.only = TRUE)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/data/anw/knw-work/g.pontillo/predictive_modelling/code/stats/AtrophyModelling")
packages <- c("dplyr", "ggplot2", "here", "nlme", "mgcv", "MuMIn", "gratia", "rsample", "gamclass", "purrr", "broom", "mgcViz", "Metrics", "cowplot")
lapply(packages, library, character.only = TRUE)
# load data
load(here("data/GAM_modelling.RData"))
View(model_gam)
summary(model_gam)
summary(model_gam_select)
summary(model_gam_bl)
summary(model_gam_bl_select)
