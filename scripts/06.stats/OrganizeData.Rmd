---
title: "Organize Data"
author: "Giuseppe Pontillo"
date: '2024-11'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/data/anw/knw-work/g.pontillo/predictive_modelling/code/stats/AtrophyModelling")
system("export LD_LIBRARY_PATH=/opt/aumc-apps-eb/software/Anaconda3/2024.02-1/lib")
packages <- c("dplyr", "ggplot2", "here", "corrplot", "nlme", "psych", "effsize", "janitor", "R.matlab", "reticulate","rstudioapi")
lapply(packages, library, character.only = TRUE)
```

```{r atrophy mapping}
### baseline atrophy
df_baseline <- readRDS(here::here("data/df_baseline.Rds"))
## SchaeferSubcortex 114 parcels
sctx <- c(paste("left", c("accumbens_area",
                          "amygdala",
                          "caudate",
                          "hippocampus",
                          "pallidum",
                          "putamen",
                          "thalamus"),
                sep = "_"),
          paste("right", c("accumbens_area",
                          "amygdala",
                          "caudate",
                          "hippocampus",
                          "pallidum",
                          "putamen",
                          "thalamus"),
                sep = "_"))
ctx <- colnames(df_baseline)[grep("^schaefer100.*.wscore$", colnames(df_baseline))]
list <- append(ctx, paste0(sctx, "_wscore"))
atrophy_mapping_individuals_wscore <- df_baseline[df_baseline$group=="MS", c("id",list)]
column_index <- 2:(length(list)+1)
atrophy_mapping_individuals_wscore[column_index] <- -1*atrophy_mapping_individuals_wscore[column_index] # flip so that more positive values correspond to greater atrophy
atrophy_mapping_group_cohend <- atrophy_mapping_group_long_cohend <- atrophy_mapping_group_pvalue <- atrophy_mapping_group_long_pvalue <- data.frame(matrix(nrow = 1, ncol = length(list)))
colnames(atrophy_mapping_group_cohend) <- colnames(atrophy_mapping_group_long_cohend) <- gsub(pattern = "_wscore", replacement = "_cohend", list)
colnames(atrophy_mapping_group_pvalue) <- colnames(atrophy_mapping_group_long_pvalue) <- gsub(pattern = "_wscore", replacement = "_pvalue", list)
df_long <- readRDS(here::here("data/df_long.Rds"))
df_long <- df_long %>%
  dplyr::group_by(id) %>%
  dplyr::mutate(n_scans=n()) # add number of scans
df_long <- df_long[(df_long$n_scans>1 & df_long$group == "MS") | df_long$group == "HC",]
df_baseline_long <- df_baseline[df_baseline$full_id %in% df_long$full_id,]
for (i in 1:length(list)) {
  d <- df_baseline[, list[i]]
  f <- df_baseline[, "group"]
  cohend <- effsize::cohen.d(d, f)
  ttest <- t.test(df_baseline[df_baseline$group=="MS", list[i]], df_baseline[df_baseline$group=="HC", list[i]])
  atrophy_mapping_group_cohend[,i] <- cohend$estimate
  atrophy_mapping_group_pvalue[,i] <- ttest$p.value
  }
for (i in 1:length(list)) {
  d <- df_baseline_long[, list[i]]
  f <- df_baseline_long[, "group"]
  cohend <- effsize::cohen.d(d, f)
  ttest <- t.test(df_baseline_long[df_baseline_long$group=="MS", list[i]], df_baseline_long[df_baseline_long$group=="HC", list[i]])
  atrophy_mapping_group_long_cohend[,i] <- cohend$estimate
  atrophy_mapping_group_long_pvalue[,i] <- ttest$p.value
  }
atrophy_mapping_group_pvalue[1,] <- p.adjust(atrophy_mapping_group_pvalue[1,], method = "fdr")
atrophy_mapping_group_long_pvalue[1,] <- p.adjust(atrophy_mapping_group_long_pvalue[1,], method = "fdr")
# write out
write.csv(atrophy_mapping_individuals_wscore, here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex114Parcels_individuals_wscore.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_cohend, here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex114Parcels_group_cohend.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_long_cohend, here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex114Parcels_group_long_cohend.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_pvalue, here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex114Parcels_group_pfdr.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_long_pvalue, here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex114Parcels_group_long_pfdr.csv"), row.names = FALSE)
## SchaferSubcortex 414 parcels
sctx <- c(paste("left", c("accumbens_area",
                          "amygdala",
                          "caudate",
                          "hippocampus",
                          "pallidum",
                          "putamen",
                          "thalamus"),
                sep = "_"),
          paste("right", c("accumbens_area",
                          "amygdala",
                          "caudate",
                          "hippocampus",
                          "pallidum",
                          "putamen",
                          "thalamus"),
                sep = "_"))
ctx <- colnames(df_baseline)[grep("^schaefer400.*.wscore$", colnames(df_baseline))]
list <- append(ctx, paste0(sctx, "_wscore"))
atrophy_mapping_individuals_wscore <- df_baseline[df_baseline$group=="MS", c("id",list)]
column_index <- 2:(length(list)+1)
atrophy_mapping_individuals_wscore[column_index] <- -1*atrophy_mapping_individuals_wscore[column_index] # flip so that more positive values correspond to greater atrophy
atrophy_mapping_group_cohend <- atrophy_mapping_group_long_cohend <- atrophy_mapping_group_pvalue <- atrophy_mapping_group_long_pvalue <- data.frame(matrix(nrow = 1, ncol = length(list)))
colnames(atrophy_mapping_group_cohend) <- colnames(atrophy_mapping_group_long_cohend) <- gsub(pattern = "_wscore", replacement = "_cohend", list)
colnames(atrophy_mapping_group_pvalue) <- colnames(atrophy_mapping_group_long_pvalue) <- gsub(pattern = "_wscore", replacement = "_pvalue", list)
df_long <- readRDS(here::here("data/df_long.Rds"))
df_long <- df_long %>%
dplyr::group_by(id) %>%
  dplyr::mutate(n_scans=n()) # add number of scans
df_long <- df_long[(df_long$n_scans>1 & df_long$group == "MS") | df_long$group == "HC",]
df_baseline_long <- df_baseline[df_baseline$full_id %in% df_long$full_id,]
for (i in 1:length(list)) {
  d <- df_baseline[, list[i]]
  f <- df_baseline[, "group"]
  cohend <- effsize::cohen.d(d, f)
  ttest <- t.test(df_baseline[df_baseline$group=="MS", list[i]], df_baseline[df_baseline$group=="HC", list[i]])
  atrophy_mapping_group_cohend[,i] <- cohend$estimate
  atrophy_mapping_group_pvalue[,i] <- ttest$p.value
  }
for (i in 1:length(list)) {
  d <- df_baseline_long[, list[i]]
  f <- df_baseline_long[, "group"]
  cohend <- effsize::cohen.d(d, f)
  ttest <- t.test(df_baseline_long[df_baseline_long$group=="MS", list[i]], df_baseline_long[df_baseline_long$group=="HC", list[i]])
  atrophy_mapping_group_long_cohend[,i] <- cohend$estimate
  atrophy_mapping_group_long_pvalue[,i] <- ttest$p.value
  }
atrophy_mapping_group_pvalue[1,] <- p.adjust(atrophy_mapping_group_pvalue[1,], method = "fdr")
atrophy_mapping_group_long_pvalue[1,] <- p.adjust(atrophy_mapping_group_long_pvalue[1,], method = "fdr")
# write out
write.csv(atrophy_mapping_individuals_wscore, here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex414Parcels_individuals_wscore.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_cohend, here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex414Parcels_group_cohend.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_long_cohend, here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex414Parcels_group_long_cohend.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_pvalue, here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex414Parcels_group_pfdr.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_long_pvalue, here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex414Parcels_group_long_pfdr.csv"), row.names = FALSE)

### longitudinal atrophy
df_long <- readRDS(here::here("data/df_long.Rds"))
## SchaeferSubcortex 114 parcels
sctx <- c(paste("left", c("accumbens_area",
                          "amygdala",
                          "caudate",
                          "hippocampus",
                          "pallidum",
                          "putamen",
                          "thalamus"),
                sep = "_"),
          paste("right", c("accumbens_area",
                           "amygdala",
                           "caudate",
                           "hippocampus",
                           "pallidum",
                           "putamen",
                           "thalamus"),
                sep = "_"))
ctx <- colnames(df_long)[grep("^schaefer100.*.ct$", colnames(df_long))]
ctx_wscore <- colnames(df_long)[grep("^schaefer100.*.ct_wscore$", colnames(df_long))]
list <- append(ctx, sctx)
list_wscore <- append(ctx_wscore, paste0(sctx, "_wscore"))
# growth models
df_long <- df_long %>%
  dplyr::group_by(id) %>%
  dplyr::mutate(n_scans=n()) # add number of scans
atrophy_mapping_individuals_slope <- data.frame(matrix(nrow = length(unique(df_long$id[df_long$group=="MS" & df_long$n_scans!=1])), ncol = length(list)+1))
colnames(atrophy_mapping_individuals_slope) = c("id", paste0(list, "_slope")) # individual slopes of atrophy over time
atrophy_mapping_individuals_slope$id <- unique(df_long$id[df_long$group=="MS" & df_long$n_scans!=1])
atrophy_mapping_group_tvalue <- atrophy_mapping_group_pvalue <- data.frame(matrix(nrow = 1, ncol = length(list)))
colnames(atrophy_mapping_group_tvalue) <- paste0(list, "_tvalue") # test statistic of the effect of time on volumes/CT
colnames(atrophy_mapping_group_pvalue) <- paste0(list, "_pvalue") # p value of the effect of time on volumes/CT
atrophy_mapping_individuals_slope_wscore <- atrophy_mapping_individuals_slope
colnames(atrophy_mapping_individuals_slope_wscore) = c("id", paste0(list_wscore, "_slope")) # individual slopes of atrophy over time
atrophy_mapping_group_tvalue_wscore <- atrophy_mapping_group_tvalue
atrophy_mapping_group_pvalue_wscore <- atrophy_mapping_group_pvalue
colnames(atrophy_mapping_group_tvalue_wscore) <- paste0(list_wscore, "_tvalue")
colnames(atrophy_mapping_group_pvalue_wscore) <- paste0(list_wscore, "_pvalue")
for (i in list){
  MDL_group <- lme(as.formula(paste0(i, " ~ fu_time")),
                   data = df_long[df_long$group=="MS" & df_long$n_scans!=1,],
                   random = ~1|id, method="ML", 
                   na.action = na.exclude,
                   correlation = corCAR1(form = ~fu_time|id),
                   control = list(msMaxIter = 1000, msMaxEval = 1000, opt = "optim", returnObject = TRUE))
  atrophy_mapping_group_tvalue[,paste0(i, "_tvalue")] <- coef(summary(MDL_group))["fu_time", "t-value"]
  atrophy_mapping_group_pvalue[,paste0(i, "_pvalue")] <- coef(summary(MDL_group))["fu_time", "p-value"]
  for (l in atrophy_mapping_individuals_slope$id){
    MDL_individual <- lm(get(i) ~ fu_time, data = df_long[df_long$id==l,])
    atrophy_mapping_individuals_slope[atrophy_mapping_individuals_slope$id==l, paste0(i, "_slope")] <- (MDL_individual$coefficients[[2]] / df_long[df_long$id==l & (df_long$session=="ses-Y05" | df_long$session=="ses-01"),i])*100
  }
}
for (i in list_wscore){
  MDL_group <- lme(as.formula(paste0(i, " ~ fu_time")),
                   data = df_long[df_long$group=="MS" & df_long$n_scans!=1,],
                   random = ~1|id, method="ML", 
                   na.action = na.exclude,
                   correlation = corCAR1(form = ~fu_time|id),
                   control = list(msMaxIter = 1000, msMaxEval = 1000, opt = "optim", returnObject = TRUE))
  atrophy_mapping_group_tvalue_wscore[,paste0(i, "_tvalue")] <- coef(summary(MDL_group))["fu_time", "t-value"]
  atrophy_mapping_group_pvalue_wscore[,paste0(i, "_pvalue")] <- coef(summary(MDL_group))["fu_time", "p-value"]
  for (l in atrophy_mapping_individuals_slope_wscore$id){
    MDL_individual <- lm(get(i) ~ fu_time, data = df_long[df_long$id==l,])
    atrophy_mapping_individuals_slope_wscore[atrophy_mapping_individuals_slope_wscore$id==l, paste0(i, "_slope")] <- MDL_individual$coefficients[[2]]
  }
}
column_index <- 2:(length(list)+1)
atrophy_mapping_individuals_slope[column_index] <- -1*atrophy_mapping_individuals_slope[column_index] # flip so that more positive values correspond to greater atrophy
atrophy_mapping_group_tvalue[1,] <- -1*atrophy_mapping_group_tvalue[1,] # flip so that more positive values correspond to greater atrophy
atrophy_mapping_group_pvalue[1,] <- p.adjust(atrophy_mapping_group_pvalue[1,], method = "fdr")
atrophy_mapping_group_pvalue_wscore[1,] <- p.adjust(atrophy_mapping_group_pvalue_wscore[1,], method = "fdr")
# write out
write.csv(atrophy_mapping_individuals_slope, here::here("data/atrophy_long/atrophy_long_SchaeferSubcortex114Parcels_individual_slopes.csv"), row.names = FALSE)
write.csv(atrophy_mapping_individuals_slope_wscore, here::here("data/atrophy_long/atrophy_long_SchaeferSubcortex114Parcels_individual_slopes_wscore.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_tvalue, here::here("data/atrophy_long/atrophy_long_SchaeferSubcortex114Parcels_group_t-values.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_tvalue_wscore, here::here("data/atrophy_long/atrophy_long_SchaeferSubcortex114Parcels_group_t-values_wscore.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_pvalue, here::here("data/atrophy_long/atrophy_long_SchaeferSubcortex114Parcels_group_pfdr.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_pvalue_wscore, here::here("data/atrophy_long/atrophy_long_SchaeferSubcortex114Parcels_group_pfdr_wscore.csv"), row.names = FALSE)

## SchaeferSubcortex 414 parcels
sctx <- c(paste("left", c("accumbens_area",
                          "amygdala",
                          "caudate",
                          "hippocampus",
                          "pallidum",
                          "putamen",
                          "thalamus"),
                sep = "_"),
          paste("right", c("accumbens_area",
                           "amygdala",
                           "caudate",
                           "hippocampus",
                           "pallidum",
                           "putamen",
                           "thalamus"),
                sep = "_"))
ctx <- colnames(df_long)[grep("^schaefer400.*.ct$", colnames(df_long))]
ctx_wscore <- colnames(df_long)[grep("^schaefer400.*.ct_wscore$", colnames(df_long))]
list <- append(ctx, sctx)
list_wscore <- append(ctx_wscore, paste0(sctx, "_wscore"))
# growth models
df_long <- df_long %>%
  dplyr::group_by(id) %>%
  dplyr::mutate(n_scans=n()) # add number of scans
atrophy_mapping_individuals_slope <- data.frame(matrix(nrow = length(unique(df_long$id[df_long$group=="MS" & df_long$n_scans!=1])), ncol = length(list)+1))
colnames(atrophy_mapping_individuals_slope) = c("id", paste0(list, "_slope")) # individual slopes of atrophy over time
atrophy_mapping_individuals_slope$id <- unique(df_long$id[df_long$group=="MS" & df_long$n_scans!=1])
atrophy_mapping_group_tvalue <- atrophy_mapping_group_pvalue <- data.frame(matrix(nrow = 1, ncol = length(list)))
colnames(atrophy_mapping_group_tvalue) <- paste0(list, "_tvalue") # test statistic of the effect of time on volumes/CT
colnames(atrophy_mapping_group_pvalue) <- paste0(list, "_pvalue") # p value of the effect of time on volumes/CT
atrophy_mapping_individuals_slope_wscore <- atrophy_mapping_individuals_slope
colnames(atrophy_mapping_individuals_slope_wscore) = c("id", paste0(list_wscore, "_slope")) # individual slopes of atrophy over time
atrophy_mapping_group_tvalue_wscore <- atrophy_mapping_group_tvalue
atrophy_mapping_group_pvalue_wscore <- atrophy_mapping_group_pvalue
colnames(atrophy_mapping_group_tvalue_wscore) <- paste0(list_wscore, "_tvalue")
colnames(atrophy_mapping_group_pvalue_wscore) <- paste0(list_wscore, "_pvalue")
for (i in list){
  MDL_group <- lme(as.formula(paste0(i, " ~ fu_time")),
                   data = df_long[df_long$group=="MS" & df_long$n_scans!=1,],
                   random = ~1|id, method="ML", 
                   na.action = na.exclude,
                   correlation = corCAR1(form = ~fu_time|id),
                   control = list(msMaxIter = 1000, msMaxEval = 1000, opt = "optim", returnObject = TRUE))
  atrophy_mapping_group_tvalue[,paste0(i, "_tvalue")] <- coef(summary(MDL_group))["fu_time", "t-value"]
  atrophy_mapping_group_pvalue[,paste0(i, "_pvalue")] <- coef(summary(MDL_group))["fu_time", "p-value"]
  for (l in atrophy_mapping_individuals_slope$id){
    MDL_individual <- lm(get(i) ~ fu_time, data = df_long[df_long$id==l,])
    atrophy_mapping_individuals_slope[atrophy_mapping_individuals_slope$id==l, paste0(i, "_slope")] <- (MDL_individual$coefficients[[2]] / df_long[df_long$id==l & (df_long$session=="ses-Y05" | df_long$session=="ses-01"),i])*100
  }
}
for (i in list_wscore){
  MDL_group <- lme(as.formula(paste0(i, " ~ fu_time")),
                   data = df_long[df_long$group=="MS" & df_long$n_scans!=1,],
                   random = ~1|id, method="ML", 
                   na.action = na.exclude,
                   correlation = corCAR1(form = ~fu_time|id),
                   control = list(msMaxIter = 1000, msMaxEval = 1000, opt = "optim", returnObject = TRUE))
  atrophy_mapping_group_tvalue_wscore[,paste0(i, "_tvalue")] <- coef(summary(MDL_group))["fu_time", "t-value"]
  atrophy_mapping_group_pvalue_wscore[,paste0(i, "_pvalue")] <- coef(summary(MDL_group))["fu_time", "p-value"]
  for (l in atrophy_mapping_individuals_slope_wscore$id){
    MDL_individual <- lm(get(i) ~ fu_time, data = df_long[df_long$id==l,])
    atrophy_mapping_individuals_slope_wscore[atrophy_mapping_individuals_slope_wscore$id==l, paste0(i, "_slope")] <- MDL_individual$coefficients[[2]]
  }
}
column_index <- 2:(length(list)+1)
atrophy_mapping_individuals_slope[column_index] <- -1*atrophy_mapping_individuals_slope[column_index] # flip so that more positive values correspond to greater atrophy
atrophy_mapping_group_tvalue[1,] <- -1*atrophy_mapping_group_tvalue[1,] # flip so that more positive values correspond to greater atrophy
atrophy_mapping_group_pvalue[1,] <- p.adjust(atrophy_mapping_group_pvalue[1,], method = "fdr")
atrophy_mapping_group_pvalue_wscore[1,] <- p.adjust(atrophy_mapping_group_pvalue_wscore[1,], method = "fdr")
# write out
write.csv(atrophy_mapping_individuals_slope, here::here("data/atrophy_long/atrophy_long_SchaeferSubcortex414Parcels_individual_slopes.csv"), row.names = FALSE)
write.csv(atrophy_mapping_individuals_slope_wscore, here::here("data/atrophy_long/atrophy_long_SchaeferSubcortex414Parcels_individual_slopes_wscore.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_tvalue, here::here("data/atrophy_long/atrophy_long_SchaeferSubcortex414Parcels_group_t-values.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_tvalue_wscore, here::here("data/atrophy_long/atrophy_long_SchaeferSubcortex414Parcels_group_t-values_wscore.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_pvalue, here::here("data/atrophy_long/atrophy_long_SchaeferSubcortex414Parcels_group_pfdr.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_pvalue_wscore, here::here("data/atrophy_long/atrophy_long_SchaeferSubcortex414Parcels_group_pfdr_wscore.csv"), row.names = FALSE)
```

```{r disconnection maps}
df_baseline <- readRDS(here::here("data/df_baseline.Rds"))
df_baseline <- df_baseline[df_baseline$group == "MS",]
df_long <- readRDS(here::here("data/df_long.Rds"))
df_long <- df_long %>%
  dplyr::group_by(id) %>%
  dplyr::mutate(n_scans=n()) # add number of scans
df_long <- df_long[(df_long$n_scans>1 & df_long$group == "MS"),]
list_baseline <- df_baseline$full_id
list_baseline_long <- df_baseline$full_id[df_baseline$full_id %in% df_long$full_id]

## SchaeferSubcortex 114 parcels
disc_dir <- "/data/anw/knw-work/g.pontillo/predictive_modelling/atrophy_long/derivatives/lst/disconnectome_SchaeferSubcortex114Parcels/"
atlas <- read.csv("/data/anw/knw-work/g.pontillo/predictive_modelling/code/MRI_processing/atlases/CortexSubcortex/atlas-SchaeferSubcortex114Parcels_dseg.tsv", header = TRUE, sep = "\t") # atlas
labels <- as.character(atlas[,"label"]) # atlas labels
labels_ctx <- labels[1:100]
labels_sctx <- labels[101:114]
roi <- length(labels)
df_disc <- data.frame(matrix(nrow = length(list_baseline), ncol = ((roi*(roi-1))/2)+1))
df_disc_ctx <- data.frame(matrix(nrow = length(list_baseline), ncol = ((100*(100-1))/2)+1))
df_disc_sctx <- data.frame(matrix(nrow = length(list_baseline), ncol = (14*100)+1))
df_parcel_disc_ctx <- data.frame(matrix(nrow = length(list_baseline), ncol = 101))
df_parcel_disc_sctx <- data.frame(matrix(nrow = length(list_baseline), ncol = 15))
colnames(df_disc)[1] <- colnames(df_disc_ctx)[1] <- colnames(df_disc_sctx)[1] <- colnames(df_parcel_disc_ctx)[1] <- colnames(df_parcel_disc_sctx)[1] <- "ID"
colnames(df_parcel_disc_ctx)[2:ncol(df_parcel_disc_ctx)] <- labels_ctx
colnames(df_parcel_disc_sctx)[2:ncol(df_parcel_disc_sctx)] <- labels_sctx
for (i in 1:length(list_baseline)) {
  # disc
  disc <- readMat(paste0(disc_dir, list_baseline[i],  "/Parcel_Disconnection/", list_baseline[i], "_SchaeferSubcortex114Parcels_percent_parcel_SDC.mat"))[[1]]
  disc_ctx <- disc[1:100, 1:100]
  disc_sctx <- disc[101:114, 1:100]
  disc_flat <- disc[upper.tri(disc, diag = FALSE)] # this equals to using numpy.tril as R is column-major
  disc_flat_ctx <- disc_ctx[upper.tri(disc_ctx, diag = FALSE)] # this equals to using numpy.tril as R is column-major
  disc_flat_sctx <- as.vector(t(disc_sctx))
  df_disc[i,1] <- df_disc_ctx[i,1] <- df_disc_sctx[i,1] <- list_baseline[i]
  df_disc[i,2:ncol(df_disc)] <- disc_flat
  df_disc_ctx[i,2:ncol(df_disc_ctx)] <- disc_flat_ctx
  df_disc_sctx[i,2:ncol(df_disc_sctx)] <- disc_flat_sctx
  # parcel
  parcel_disc <- read.csv(paste0(disc_dir, list_baseline[i],  "/Parcel_Disconnection/", list_baseline[i], "_SchaeferSubcortex114Parcels_percent_parcel_SDC.node"), header = FALSE, sep = "\t")
  parcel_disc_ctx <- parcel_disc[1:100, 5]
  parcel_disc_sctx <- parcel_disc[101:114, 5]
  df_parcel_disc_ctx[i,1] <- df_parcel_disc_sctx[i,1] <- list_baseline[i]
  df_parcel_disc_ctx[i,2:ncol(df_parcel_disc_ctx)] <- parcel_disc_ctx
  df_parcel_disc_sctx[i,2:ncol(df_parcel_disc_sctx)] <- parcel_disc_sctx
}
index <- which(upper.tri(disc, diag = FALSE), arr.ind=TRUE)
for (i in 1:dim(index)[1]){
  colnames(df_disc)[1+i] <- paste0(labels_ctx[index[i,1]],
                                   "_to_",
                                   labels_ctx[index[i,2]])
  }
index_ctx <- which(upper.tri(disc_ctx, diag = FALSE), arr.ind=TRUE)
for (i in 1:dim(index_ctx)[1]){
  colnames(df_disc_ctx)[1+i] <- paste0(labels_ctx[index_ctx[i,1]],
                                       "_to_",
                                       labels_ctx[index_ctx[i,2]])
  }
index_sctx <- which((t(disc_sctx) == t(disc_sctx)), arr.ind=TRUE)
for (i in 1:dim(index_sctx)[1]){
  colnames(df_disc_sctx)[1+i] <- paste0(labels_sctx[index_sctx[i,1]],
                                        "_to_",
                                        labels_ctx[index_sctx[i,2]])
  }
# average disconnectome
average_disc_MS <- colMeans(df_disc[,-1], na.rm = TRUE)
mat_MS <- matrix(nrow = roi, ncol = roi)
mat_MS[upper.tri(mat_MS)] <- as.matrix(average_disc_MS)
mat_MS <- as.matrix(Matrix::forceSymmetric(mat_MS, uplo = "U"))
diag(mat_MS) <- 0
mat_MS_ctx <- mat_MS[1:100, 1:100]
mat_MS_sctx <- mat_MS[101:114, 1:100]
average_parcel_disc_ctx <- colMeans(df_parcel_disc_ctx[,-1], na.rm = TRUE)
average_parcel_disc_sctx <- colMeans(df_parcel_disc_sctx[,-1], na.rm = TRUE)
# average disconnectome long
df_disc_long <- df_disc[df_disc$ID %in% list_baseline_long,]
average_disc_MS_long <- colMeans(df_disc_long[,-1], na.rm = TRUE)
mat_MS_long <- matrix(nrow = roi, ncol = roi)
mat_MS_long[upper.tri(mat_MS_long)] <- as.matrix(average_disc_MS_long)
mat_MS_long <- as.matrix(Matrix::forceSymmetric(mat_MS_long, uplo = "U"))
diag(mat_MS_long) <- 0
mat_MS_long_ctx <- mat_MS[1:100, 1:100]
mat_MS_long_sctx <- mat_MS[101:114, 1:100]
df_parcel_disc_ctx_long <- df_parcel_disc_ctx[df_parcel_disc_ctx$ID %in% list_baseline_long,]
df_parcel_disc_sctx_long <- df_parcel_disc_sctx[df_parcel_disc_sctx$ID %in% list_baseline_long,]
average_parcel_disc_ctx_long <- colMeans(df_parcel_disc_ctx_long[,-1], na.rm = TRUE)
average_parcel_disc_sctx_long <- colMeans(df_parcel_disc_sctx_long[,-1], na.rm = TRUE)
# write average and individuals disconnectomes
write.table(mat_MS, here::here("data/disc/disc_SchaeferSubcortex114Parcels_group.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(labels, here::here("data/disc/disc_SchaeferSubcortex114Parcels_labels.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_ctx, here::here("data/disc/disc_SchaeferSubcortex114Parcels_group_ctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_sctx, here::here("data/disc/disc_SchaeferSubcortex114Parcels_group_sctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_long, here::here("data/disc/disc_SchaeferSubcortex114Parcels_group_long.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_long_ctx, here::here("data/disc/disc_SchaeferSubcortex114Parcels_group_long_ctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_long_sctx, here::here("data/disc/disc_SchaeferSubcortex114Parcels_group_long_sctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.csv(df_disc_ctx, here::here("data/disc/disc_SchaeferSubcortex114Parcels_individuals_ctx.csv"), row.names = FALSE)
write.csv(df_disc_sctx, here::here("data/disc/disc_SchaeferSubcortex114Parcels_individuals_sctx.csv"), row.names = FALSE)
write.table(average_parcel_disc_ctx, here::here("data/disc/parcel_disc_SchaeferSubcortex114Parcels_group_ctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(average_parcel_disc_sctx, here::here("data/disc/parcel_disc_SchaeferSubcortex114Parcels_group_sctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(average_parcel_disc_ctx_long, here::here("data/disc/parcel_disc_SchaeferSubcortex114Parcels_group_long_ctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(average_parcel_disc_sctx_long, here::here("data/disc/parcel_disc_SchaeferSubcortex114Parcels_group_long_sctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.csv(df_parcel_disc_ctx, here::here("data/disc/parcel_disc_SchaeferSubcortex114Parcels_individuals_ctx.csv"), row.names = FALSE)
write.csv(df_parcel_disc_sctx, here::here("data/disc/parcel_disc_SchaeferSubcortex114Parcels_individuals_sctx.csv"), row.names = FALSE)

## SchaeferSubcortex 414 parcels
disc_dir <- "/data/anw/knw-work/g.pontillo/predictive_modelling/atrophy_long/derivatives/lst/disconnectome_SchaeferSubcortex414Parcels/"
atlas <- read.csv("/data/anw/knw-work/g.pontillo/predictive_modelling/code/MRI_processing/atlases/CortexSubcortex/atlas-SchaeferSubcortex414Parcels_dseg.tsv", header = TRUE, sep = "\t") # atlas
labels <- as.character(atlas[,"label"]) # atlas labels
labels_ctx <- labels[1:400]
labels_sctx <- labels[401:414]
roi <- length(labels)
df_disc <- data.frame(matrix(nrow = length(list_baseline), ncol = ((roi*(roi-1))/2)+1))
df_disc_ctx <- data.frame(matrix(nrow = length(list_baseline), ncol = ((400*(400-1))/2)+1))
df_disc_sctx <- data.frame(matrix(nrow = length(list_baseline), ncol = (14*400)+1))
df_parcel_disc_ctx <- data.frame(matrix(nrow = length(list_baseline), ncol = 401))
df_parcel_disc_sctx <- data.frame(matrix(nrow = length(list_baseline), ncol = 15))
colnames(df_disc)[1] <- colnames(df_disc_ctx)[1] <- colnames(df_disc_sctx)[1] <- colnames(df_parcel_disc_ctx)[1] <- colnames(df_parcel_disc_sctx)[1] <- "ID"
colnames(df_parcel_disc_ctx)[2:ncol(df_parcel_disc_ctx)] <- labels_ctx
colnames(df_parcel_disc_sctx)[2:ncol(df_parcel_disc_sctx)] <- labels_sctx
for (i in 1:length(list_baseline)) {
  # disc
  disc <- readMat(paste0(disc_dir, list_baseline[i],  "/Parcel_Disconnection/", list_baseline[i], "_SchaeferSubcortex414Parcels_percent_parcel_SDC.mat"))[[1]]
  disc_ctx <- disc[1:400, 1:400]
  disc_sctx <- disc[401:414, 1:400]
  disc_flat <- disc[upper.tri(disc, diag = FALSE)] # this equals to using numpy.tril as R is column-major
  disc_flat_ctx <- disc_ctx[upper.tri(disc_ctx, diag = FALSE)] # this equals to using numpy.tril as R is column-major
  disc_flat_sctx <- as.vector(t(disc_sctx))
  df_disc[i,1] <- df_disc_ctx[i,1] <- df_disc_sctx[i,1] <- list_baseline[i]
  df_disc[i,2:ncol(df_disc)] <- disc_flat
  df_disc_ctx[i,2:ncol(df_disc_ctx)] <- disc_flat_ctx
  df_disc_sctx[i,2:ncol(df_disc_sctx)] <- disc_flat_sctx
  # parcel
  parcel_disc <- read.csv(paste0(disc_dir, list_baseline[i],  "/Parcel_Disconnection/", list_baseline[i], "_SchaeferSubcortex414Parcels_percent_parcel_SDC.node"), header = FALSE, sep = "\t")
  parcel_disc_ctx <- parcel_disc[1:400, 5]
  parcel_disc_sctx <- parcel_disc[401:414, 5]
  df_parcel_disc_ctx[i,1] <- df_parcel_disc_sctx[i,1] <- list_baseline[i]
  df_parcel_disc_ctx[i,2:ncol(df_parcel_disc_ctx)] <- parcel_disc_ctx
  df_parcel_disc_sctx[i,2:ncol(df_parcel_disc_sctx)] <- parcel_disc_sctx
}
index <- which(upper.tri(disc, diag = FALSE), arr.ind=TRUE)
for (i in 1:dim(index)[1]){
  colnames(df_disc)[1+i] <- paste0(labels_ctx[index[i,1]],
                                   "_to_",
                                   labels_ctx[index[i,2]])
  }
index_ctx <- which(upper.tri(disc_ctx, diag = FALSE), arr.ind=TRUE)
for (i in 1:dim(index_ctx)[1]){
  colnames(df_disc_ctx)[1+i] <- paste0(labels_ctx[index_ctx[i,1]],
                                       "_to_",
                                       labels_ctx[index_ctx[i,2]])
  }
index_sctx <- which((t(disc_sctx) == t(disc_sctx)), arr.ind=TRUE)
for (i in 1:dim(index_sctx)[1]){
  colnames(df_disc_sctx)[1+i] <- paste0(labels_sctx[index_sctx[i,1]],
                                        "_to_",
                                        labels_ctx[index_sctx[i,2]])
  }
# average disconnectome
average_disc_MS <- colMeans(df_disc[,-1], na.rm = TRUE)
mat_MS <- matrix(nrow = roi, ncol = roi)
mat_MS[upper.tri(mat_MS)] <- as.matrix(average_disc_MS)
mat_MS <- as.matrix(Matrix::forceSymmetric(mat_MS, uplo = "U"))
diag(mat_MS) <- 0
mat_MS_ctx <- mat_MS[1:400, 1:400]
mat_MS_sctx <- mat_MS[401:414, 1:400]
average_parcel_disc_ctx <- colMeans(df_parcel_disc_ctx[,-1], na.rm = TRUE)
average_parcel_disc_sctx <- colMeans(df_parcel_disc_sctx[,-1], na.rm = TRUE)
# average disconnectome long
df_disc_long <- df_disc[df_disc$ID %in% list_baseline_long,]
average_disc_MS_long <- colMeans(df_disc_long[,-1], na.rm = TRUE)
mat_MS_long <- matrix(nrow = roi, ncol = roi)
mat_MS_long[upper.tri(mat_MS_long)] <- as.matrix(average_disc_MS_long)
mat_MS_long <- as.matrix(Matrix::forceSymmetric(mat_MS_long, uplo = "U"))
diag(mat_MS_long) <- 0
mat_MS_long_ctx <- mat_MS[1:400, 1:400]
mat_MS_long_sctx <- mat_MS[401:414, 1:400]
df_parcel_disc_ctx_long <- df_parcel_disc_ctx[df_parcel_disc_ctx$ID %in% list_baseline_long,]
df_parcel_disc_sctx_long <- df_parcel_disc_sctx[df_parcel_disc_sctx$ID %in% list_baseline_long,]
average_parcel_disc_ctx_long <- colMeans(df_parcel_disc_ctx_long[,-1], na.rm = TRUE)
average_parcel_disc_sctx_long <- colMeans(df_parcel_disc_sctx_long[,-1], na.rm = TRUE)
# write average and individuals disconnectomes
write.table(mat_MS, here::here("data/disc/disc_SchaeferSubcortex414Parcels_group.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(labels, here::here("data/disc/disc_SchaeferSubcortex414Parcels_labels.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_ctx, here::here("data/disc/disc_SchaeferSubcortex414Parcels_group_ctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_sctx, here::here("data/disc/disc_SchaeferSubcortex414Parcels_group_sctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_long, here::here("data/disc/disc_SchaeferSubcortex414Parcels_group_long.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_long_ctx, here::here("data/disc/disc_SchaeferSubcortex414Parcels_group_long_ctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_long_sctx, here::here("data/disc/disc_SchaeferSubcortex414Parcels_group_long_sctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.csv(df_disc_ctx, here::here("data/disc/disc_SchaeferSubcortex414Parcels_individuals_ctx.csv"), row.names = FALSE)
write.csv(df_disc_sctx, here::here("data/disc/disc_SchaeferSubcortex414Parcels_individuals_sctx.csv"), row.names = FALSE)
write.table(average_parcel_disc_ctx, here::here("data/disc/parcel_disc_SchaeferSubcortex414Parcels_group_ctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(average_parcel_disc_sctx, here::here("data/disc/parcel_disc_SchaeferSubcortex414Parcels_group_sctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(average_parcel_disc_ctx_long, here::here("data/disc/parcel_disc_SchaeferSubcortex414Parcels_group_long_ctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(average_parcel_disc_sctx_long, here::here("data/disc/parcel_disc_SchaeferSubcortex414Parcels_group_long_sctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.csv(df_parcel_disc_ctx, here::here("data/disc/parcel_disc_SchaeferSubcortex414Parcels_individuals_ctx.csv"), row.names = FALSE)
write.csv(df_parcel_disc_sctx, here::here("data/disc/parcel_disc_SchaeferSubcortex414Parcels_individuals_sctx.csv"), row.names = FALSE)
```

```{r correlated gene expression matrix, purl = FALSE}
## SchaeferSubcortex 114 parcels
# load gene expression vectors
GE_vectors <- read.csv(here::here("data/ge/allgenes_stable_r0.2_schaefer_100.csv"), header = TRUE, sep = ",")
tGE_vectors <- t(GE_vectors[,-1])
colnames(tGE_vectors) <- GE_vectors$label
CGE <- cor(t(GE_vectors[,-1]))
# corrplot(CGE, method="color")
mat_CGE <- as.matrix(Matrix::forceSymmetric(CGE, uplo = "U"))
diag(mat_CGE) <- 0
mat_CGE_ctx <- mat_CGE[1:100, 1:100]
mat_CGE_sctx <- mat_CGE[101:114,1:100]
# write average matrices
write.table(mat_CGE, here::here("data/ge/CGE_SchaeferSubcortex114Parcels.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_CGE_ctx, here::here("data/ge/CGE_SchaeferSubcortex114Parcels_ctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_CGE_sctx, here::here("data/ge/CGE_SchaeferSubcortex114Parcels_sctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(GE_vectors$label, here::here("data/ge/SchaeferSubcortex114Parcels_labels.csv"), sep = ',', row.names = FALSE, col.names = FALSE)

## SchaeferSubcortex 414 parcels
# load gene expression vectors
GE_vectors <- read.csv(here::here("data/ge/allgenes_stable_r0.2_schaefer_400.csv"), header = TRUE, sep = ",")
tGE_vectors <- t(GE_vectors[,-1])
colnames(tGE_vectors) <- GE_vectors$label
CGE <- cor(t(GE_vectors[,-1]))
# corrplot(CGE, method="color")
mat_CGE <- as.matrix(Matrix::forceSymmetric(CGE, uplo = "U"))
diag(mat_CGE) <- 0
mat_CGE_ctx <- mat_CGE[1:400, 1:400]
mat_CGE_sctx <- mat_CGE[401:414,1:400]
# write average matrices
write.table(mat_CGE, here::here("data/ge/CGE_SchaeferSubcortex414Parcels.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_CGE_ctx, here::here("data/ge/CGE_SchaeferSubcortex414Parcels_ctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_CGE_sctx, here::here("data/ge/CGE_SchaeferSubcortex414Parcels_sctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(GE_vectors$label, here::here("data/ge/SchaeferSubcortex414Parcels_labels.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
```

```{r compute baseline neighbour atrophy weighted by SC/FC/CGE}
### SchaeferSubcortex 114 parcels
## load normative functional/structural/CGE matrices
sc_ctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/strucMatrix_ctx_schaefer_100.csv"), header = FALSE, sep = ","))
sc_sctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/strucMatrix_sctx_schaefer_100.csv"), header = FALSE, sep = ","))
sc_sctx <- sc_sctx[,1:100] # the sctx matrix contains also subcortico-subcortical connections
fc_ctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/funcMatrix_ctx_schaefer_100.csv"), header = FALSE, sep = ","))
fc_sctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/funcMatrix_sctx_schaefer_100.csv"), header = FALSE, sep = ","))
cge_ctx <- as.matrix(read.csv(here::here("data/ge/CGE_SchaeferSubcortex114Parcels_ctx.csv"), header = FALSE, sep = ","))
cge_sctx <- as.matrix(read.csv(here::here("data/ge/CGE_SchaeferSubcortex114Parcels_sctx.csv"), header = FALSE, sep = ","))
## group-level
# load atrophy map
atrophy_mapping <- read.csv(here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex114Parcels_group_cohend.csv"), header = TRUE, sep = ",")
atrophy_ctx <- atrophy_mapping[,1:100]
atrophy_sctx <- atrophy_mapping[,101:114]
# compute neighbourhood atrophy sc ctx
neighbourhood_atrophy_sc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_sc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(sc_ctx[i,]!=0)
  weight_vec <- sc_ctx[i,c(neighbours)]
  neighbourhood_atrophy_sc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# compute neighbourhood atrophy sc sctx
neighbourhood_atrophy_sc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_sc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(sc_sctx[i,]!=0)
  weight_vec <- sc_sctx[i,c(neighbours)]
  neighbourhood_atrophy_sc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# compute neighbourhood atrophy fc ctx
neighbourhood_atrophy_fc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_fc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(fc_ctx[i,]!=0)
  weight_vec <- fc_ctx[i,c(neighbours)]
  neighbourhood_atrophy_fc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# compute neighbourhood atrophy fc sctx
neighbourhood_atrophy_fc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_fc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(fc_sctx[i,]!=0)
  weight_vec <- fc_sctx[i,c(neighbours)]
  neighbourhood_atrophy_fc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# compute neighbourhood atrophy cge ctx
neighbourhood_atrophy_cge_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_cge_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(cge_ctx[i,]!=0 & !is.na(cge_ctx[i,]))
  weight_vec <- cge_ctx[i,c(neighbours)]
  neighbourhood_atrophy_cge_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# compute neighbourhood atrophy cge sctx
neighbourhood_atrophy_cge_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_cge_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(cge_sctx[i,]!=0 & !is.na(cge_sctx[i,]))
  weight_vec <- cge_sctx[i,c(neighbours)]
  neighbourhood_atrophy_cge_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# write out
write.csv(neighbourhood_atrophy_sc_ctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_sc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_sc_sctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_sc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_ctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_fc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_sctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_fc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_ctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_cge_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_sctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_cge_sctx.csv"), row.names = FALSE)
## group-level long
# load atrophy map
atrophy_mapping <- read.csv(here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex114Parcels_group_long_cohend.csv"), header = TRUE, sep = ",")
atrophy_ctx <- atrophy_mapping[,1:100]
atrophy_sctx <- atrophy_mapping[,101:114]
# compute neighbourhood atrophy sc ctx
neighbourhood_atrophy_sc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_sc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(sc_ctx[i,]!=0)
  weight_vec <- sc_ctx[i,c(neighbours)]
  neighbourhood_atrophy_sc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# compute neighbourhood atrophy sc sctx
neighbourhood_atrophy_sc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_sc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(sc_sctx[i,]!=0)
  weight_vec <- sc_sctx[i,c(neighbours)]
  neighbourhood_atrophy_sc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# compute neighbourhood atrophy fc ctx
neighbourhood_atrophy_fc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_fc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(fc_ctx[i,]!=0)
  weight_vec <- fc_ctx[i,c(neighbours)]
  neighbourhood_atrophy_fc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# compute neighbourhood atrophy fc sctx
neighbourhood_atrophy_fc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_fc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(fc_sctx[i,]!=0)
  weight_vec <- fc_sctx[i,c(neighbours)]
  neighbourhood_atrophy_fc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# compute neighbourhood atrophy cge ctx
neighbourhood_atrophy_cge_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_cge_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(cge_ctx[i,]!=0 & !is.na(cge_ctx[i,]))
  weight_vec <- cge_ctx[i,c(neighbours)]
  neighbourhood_atrophy_cge_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# compute neighbourhood atrophy cge sctx
neighbourhood_atrophy_cge_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_cge_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(cge_sctx[i,]!=0 & !is.na(cge_sctx[i,]))
  weight_vec <- cge_sctx[i,c(neighbours)]
  neighbourhood_atrophy_cge_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# write out
write.csv(neighbourhood_atrophy_sc_ctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_long_sc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_sc_sctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_long_sc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_ctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_long_fc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_sctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_long_fc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_ctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_long_cge_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_sctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_long_cge_sctx.csv"), row.names = FALSE)
## individual-level
# load atrophy map
atrophy_mapping <- read.csv(here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex114Parcels_individuals_wscore.csv"), header = TRUE, sep = ",")
atrophy_ctx <- atrophy_mapping[,2:101]
atrophy_sctx <- atrophy_mapping[,102:115]
# compute neighbourhood atrophy sc ctx
neighbourhood_atrophy_sc_ctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_ctx))))
colnames(neighbourhood_atrophy_sc_ctx) <- append("id", paste0(colnames(atrophy_ctx), "_neighbours"))
neighbourhood_atrophy_sc_ctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_ctx)){
    neighbours <- which(sc_ctx[i,]!=0)
    weight_vec <- sc_ctx[i,c(neighbours)]
    neighbourhood_atrophy_sc_ctx[neighbourhood_atrophy_sc_ctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
  }
# compute neighbourhood atrophy sc sctx
neighbourhood_atrophy_sc_sctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_sctx))))
colnames(neighbourhood_atrophy_sc_sctx) <- append("id", paste0(colnames(atrophy_sctx), "_neighbours"))
neighbourhood_atrophy_sc_sctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_sctx)){
    neighbours <- which(sc_sctx[i,]!=0)
    weight_vec <- sc_sctx[i,c(neighbours)]
    neighbourhood_atrophy_sc_sctx[neighbourhood_atrophy_sc_sctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
  }
# compute neighbourhood atrophy fc ctx
neighbourhood_atrophy_fc_ctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_ctx))))
colnames(neighbourhood_atrophy_fc_ctx) <- append("id", paste0(colnames(atrophy_ctx), "_neighbours"))
neighbourhood_atrophy_fc_ctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_ctx)){
    neighbours <- which(fc_ctx[i,]!=0)
    weight_vec <- fc_ctx[i,c(neighbours)]
    neighbourhood_atrophy_fc_ctx[neighbourhood_atrophy_fc_ctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
  }
# compute neighbourhood atrophy fc sctx
neighbourhood_atrophy_fc_sctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_sctx))))
colnames(neighbourhood_atrophy_fc_sctx) <- append("id", paste0(colnames(atrophy_sctx), "_neighbours"))
neighbourhood_atrophy_fc_sctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_sctx)){
    neighbours <- which(fc_sctx[i,]!=0)
    weight_vec <- fc_sctx[i,c(neighbours)]
    neighbourhood_atrophy_fc_sctx[neighbourhood_atrophy_fc_sctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
  }
# compute neighbourhood atrophy cge ctx
neighbourhood_atrophy_cge_ctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_ctx))))
colnames(neighbourhood_atrophy_cge_ctx) <- append("id", paste0(colnames(atrophy_ctx), "_neighbours"))
neighbourhood_atrophy_cge_ctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_ctx)){
    neighbours <- which(cge_ctx[i,]!=0 & !is.na(cge_ctx[i,]))
    weight_vec <- cge_ctx[i,c(neighbours)]
    neighbourhood_atrophy_cge_ctx[neighbourhood_atrophy_cge_ctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
  }
# compute neighbourhood atrophy cge sctx
neighbourhood_atrophy_cge_sctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_sctx))))
colnames(neighbourhood_atrophy_cge_sctx) <- append("id", paste0(colnames(atrophy_sctx), "_neighbours"))
neighbourhood_atrophy_cge_sctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_sctx)){
    neighbours <- which(cge_sctx[i,]!=0 & !is.na(cge_sctx[i,]))
    weight_vec <- cge_sctx[i,c(neighbours)]
    neighbourhood_atrophy_cge_sctx[neighbourhood_atrophy_cge_sctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
  }
# write out
write.csv(neighbourhood_atrophy_sc_ctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_individuals_sc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_sc_sctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_individuals_sc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_ctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_individuals_fc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_sctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_individuals_fc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_ctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_individuals_cge_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_sctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_individuals_cge_sctx.csv"), row.names = FALSE)

### SchaeferSubcortex 414 parcels
## load normative functional/structural/CGE matrices
sc_ctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/strucMatrix_ctx_schaefer_400.csv"), header = FALSE, sep = ","))
sc_sctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/strucMatrix_sctx_schaefer_400.csv"), header = FALSE, sep = ","))
sc_sctx <- sc_sctx[,1:400] # the sctx matrix contains also subcortico-subcortical connections
fc_ctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/funcMatrix_ctx_schaefer_400.csv"), header = FALSE, sep = ","))
fc_sctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/funcMatrix_sctx_schaefer_400.csv"), header = FALSE, sep = ","))
cge_ctx <- as.matrix(read.csv(here::here("data/ge/CGE_SchaeferSubcortex414Parcels_ctx.csv"), header = FALSE, sep = ","))
cge_sctx <- as.matrix(read.csv(here::here("data/ge/CGE_SchaeferSubcortex414Parcels_sctx.csv"), header = FALSE, sep = ","))
## group-level
# load atrophy map
atrophy_mapping <- read.csv(here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex414Parcels_group_cohend.csv"), header = TRUE, sep = ",")
atrophy_ctx <- atrophy_mapping[,1:400]
atrophy_sctx <- atrophy_mapping[,401:414]
# compute neighbourhood atrophy sc ctx
neighbourhood_atrophy_sc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_sc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(sc_ctx[i,]!=0)
  weight_vec <- sc_ctx[i,c(neighbours)]
  neighbourhood_atrophy_sc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# compute neighbourhood atrophy sc sctx
neighbourhood_atrophy_sc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_sc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(sc_sctx[i,]!=0)
  weight_vec <- sc_sctx[i,c(neighbours)]
  neighbourhood_atrophy_sc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# compute neighbourhood atrophy fc ctx
neighbourhood_atrophy_fc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_fc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(fc_ctx[i,]!=0)
  weight_vec <- fc_ctx[i,c(neighbours)]
  neighbourhood_atrophy_fc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# compute neighbourhood atrophy fc sctx
neighbourhood_atrophy_fc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_fc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(fc_sctx[i,]!=0)
  weight_vec <- fc_sctx[i,c(neighbours)]
  neighbourhood_atrophy_fc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# compute neighbourhood atrophy cge ctx
neighbourhood_atrophy_cge_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_cge_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(cge_ctx[i,]!=0 & !is.na(cge_ctx[i,]))
  weight_vec <- cge_ctx[i,c(neighbours)]
  neighbourhood_atrophy_cge_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# compute neighbourhood atrophy cge sctx
neighbourhood_atrophy_cge_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_cge_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(cge_sctx[i,]!=0 & !is.na(cge_sctx[i,]))
  weight_vec <- cge_sctx[i,c(neighbours)]
  neighbourhood_atrophy_cge_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# write out
write.csv(neighbourhood_atrophy_sc_ctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_sc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_sc_sctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_sc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_ctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_fc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_sctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_fc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_ctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_cge_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_sctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_cge_sctx.csv"), row.names = FALSE)
## group-level long
# load atrophy map
atrophy_mapping <- read.csv(here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex414Parcels_group_long_cohend.csv"), header = TRUE, sep = ",")
atrophy_ctx <- atrophy_mapping[,1:400]
atrophy_sctx <- atrophy_mapping[,401:414]
# compute neighbourhood atrophy sc ctx
neighbourhood_atrophy_sc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_sc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(sc_ctx[i,]!=0)
  weight_vec <- sc_ctx[i,c(neighbours)]
  neighbourhood_atrophy_sc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# compute neighbourhood atrophy sc sctx
neighbourhood_atrophy_sc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_sc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(sc_sctx[i,]!=0)
  weight_vec <- sc_sctx[i,c(neighbours)]
  neighbourhood_atrophy_sc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# compute neighbourhood atrophy fc ctx
neighbourhood_atrophy_fc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_fc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(fc_ctx[i,]!=0)
  weight_vec <- fc_ctx[i,c(neighbours)]
  neighbourhood_atrophy_fc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# compute neighbourhood atrophy fc sctx
neighbourhood_atrophy_fc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_fc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(fc_sctx[i,]!=0)
  weight_vec <- fc_sctx[i,c(neighbours)]
  neighbourhood_atrophy_fc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# compute neighbourhood atrophy cge ctx
neighbourhood_atrophy_cge_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_cge_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(cge_ctx[i,]!=0 & !is.na(cge_ctx[i,]))
  weight_vec <- cge_ctx[i,c(neighbours)]
  neighbourhood_atrophy_cge_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# compute neighbourhood atrophy cge sctx
neighbourhood_atrophy_cge_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_cge_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(cge_sctx[i,]!=0 & !is.na(cge_sctx[i,]))
  weight_vec <- cge_sctx[i,c(neighbours)]
  neighbourhood_atrophy_cge_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
  }
# write out
write.csv(neighbourhood_atrophy_sc_ctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_long_sc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_sc_sctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_long_sc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_ctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_long_fc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_sctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_long_fc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_ctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_long_cge_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_sctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_long_cge_sctx.csv"), row.names = FALSE)
## individual-level
# load atrophy map
atrophy_mapping <- read.csv(here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex414Parcels_individuals_wscore.csv"), header = TRUE, sep = ",")
atrophy_ctx <- atrophy_mapping[,2:401]
atrophy_sctx <- atrophy_mapping[,402:415]
# compute neighbourhood atrophy sc ctx
neighbourhood_atrophy_sc_ctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_ctx))))
colnames(neighbourhood_atrophy_sc_ctx) <- append("id", paste0(colnames(atrophy_ctx), "_neighbours"))
neighbourhood_atrophy_sc_ctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_ctx)){
    neighbours <- which(sc_ctx[i,]!=0)
    weight_vec <- sc_ctx[i,c(neighbours)]
    neighbourhood_atrophy_sc_ctx[neighbourhood_atrophy_sc_ctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
  }
# compute neighbourhood atrophy sc sctx
neighbourhood_atrophy_sc_sctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_sctx))))
colnames(neighbourhood_atrophy_sc_sctx) <- append("id", paste0(colnames(atrophy_sctx), "_neighbours"))
neighbourhood_atrophy_sc_sctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_sctx)){
    neighbours <- which(sc_sctx[i,]!=0)
    weight_vec <- sc_sctx[i,c(neighbours)]
    neighbourhood_atrophy_sc_sctx[neighbourhood_atrophy_sc_sctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
  }
# compute neighbourhood atrophy fc ctx
neighbourhood_atrophy_fc_ctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_ctx))))
colnames(neighbourhood_atrophy_fc_ctx) <- append("id", paste0(colnames(atrophy_ctx), "_neighbours"))
neighbourhood_atrophy_fc_ctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_ctx)){
    neighbours <- which(fc_ctx[i,]!=0)
    weight_vec <- fc_ctx[i,c(neighbours)]
    neighbourhood_atrophy_fc_ctx[neighbourhood_atrophy_fc_ctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
  }
# compute neighbourhood atrophy fc sctx
neighbourhood_atrophy_fc_sctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_sctx))))
colnames(neighbourhood_atrophy_fc_sctx) <- append("id", paste0(colnames(atrophy_sctx), "_neighbours"))
neighbourhood_atrophy_fc_sctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_sctx)){
    neighbours <- which(fc_sctx[i,]!=0)
    weight_vec <- fc_sctx[i,c(neighbours)]
    neighbourhood_atrophy_fc_sctx[neighbourhood_atrophy_fc_sctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
  }
# compute neighbourhood atrophy cge ctx
neighbourhood_atrophy_cge_ctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_ctx))))
colnames(neighbourhood_atrophy_cge_ctx) <- append("id", paste0(colnames(atrophy_ctx), "_neighbours"))
neighbourhood_atrophy_cge_ctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_ctx)){
    neighbours <- which(cge_ctx[i,]!=0 & !is.na(cge_ctx[i,]))
    weight_vec <- cge_ctx[i,c(neighbours)]
    neighbourhood_atrophy_cge_ctx[neighbourhood_atrophy_cge_ctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
  }
# compute neighbourhood atrophy cge sctx
neighbourhood_atrophy_cge_sctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_sctx))))
colnames(neighbourhood_atrophy_cge_sctx) <- append("id", paste0(colnames(atrophy_sctx), "_neighbours"))
neighbourhood_atrophy_cge_sctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_sctx)){
    neighbours <- which(cge_sctx[i,]!=0 & !is.na(cge_sctx[i,]))
    weight_vec <- cge_sctx[i,c(neighbours)]
    neighbourhood_atrophy_cge_sctx[neighbourhood_atrophy_cge_sctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
  }
# write out
write.csv(neighbourhood_atrophy_sc_ctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_individuals_sc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_sc_sctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_individuals_sc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_ctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_individuals_fc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_sctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_individuals_fc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_ctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_individuals_cge_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_sctx, here::here("data/neighbourhood_atrophy/neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_individuals_cge_sctx.csv"), row.names = FALSE)
```

```{r prepare data for clustering}
df_baseline <- readRDS(here::here("data/df_baseline.Rds"))
df_baseline_stage <- df_baseline %>% mutate(stage = case_when(clinical_phenotype == "SP" ~ "SP",
                             clinical_phenotype == "PP"  ~ "PP",
                             clinical_phenotype == "CIS" | (clinical_phenotype == "RR" & disease_duration < 5) ~ "ER",
                             clinical_phenotype == "RR" & disease_duration >= 5 ~ "LR"))
df_baseline_stage <- df_baseline_stage[df_baseline_stage$group=="MS",]
df_baseline_stage$stage <- factor(df_baseline_stage$stage, levels = c("PP", "SP", "ER", "LR"))
MDL <- lm(brain_seg_not_vent ~ age + sex + estimated_total_intra_cranial_vol + site, data = df_baseline[df_baseline$group=="HC",], na.action = na.exclude)
df_baseline[, "brain_wscore"] <- (df_baseline[, "brain_seg_not_vent"] - predict(MDL, df_baseline)) / sd(MDL$residuals)
df_baseline_globalatrophy <- df_baseline %>% mutate(globalatrophy = case_when(brain_wscore <= -1.5  ~ 1, brain_wscore > -1.5 ~ 0))
df_baseline_globalatrophy <- df_baseline_globalatrophy[df_baseline_globalatrophy$group=="MS",]
df_baseline_globalatrophy$globalatrophy <- factor(df_baseline_globalatrophy$globalatrophy, levels = c(0, 1))
stages <- df_baseline_stage[, c("id", "session", "stage")]
globalatrophy <- df_baseline_globalatrophy[, c("id", "session", "globalatrophy")]
write.csv(stages, here::here("data/stages.csv"), row.names = FALSE)
write.csv(globalatrophy, here::here("data/globalatrophy.csv"), row.names = FALSE)
## SchaeferSubcortex 114 parcels
sctx <- c(paste("left", c("accumbens_area",
                          "amygdala",
                          "caudate",
                          "hippocampus",
                          "pallidum",
                          "putamen",
                          "thalamus"),
                sep = "_"),
          paste("right", c("accumbens_area",
                          "amygdala",
                          "caudate",
                          "hippocampus",
                          "pallidum",
                          "putamen",
                          "thalamus"),
                sep = "_"))
ctx <- colnames(df_baseline)[grep("^schaefer100.*.wscore$", colnames(df_baseline))]
list <- append(ctx, paste0(sctx, "_wscore"))
feature_tsv <- df_baseline[, c("id", "session", "group", list)]
colnames(feature_tsv) <- c("participant_id", "session_id", "diagnosis", list)
column_index <- 4:(length(list)+3)
feature_tsv[column_index] <- -1*feature_tsv[column_index] # flip so that more positive values correspond to greater atrophy
levels(feature_tsv$diagnosis) <- c("-1", "1")
write.table(feature_tsv, here::here("data/feature_SchaeferSubcortex114Parcels.tsv"), sep = '\t', row.names = FALSE)
## SchaeferSubcortex 414 parcels
sctx <- c(paste("left", c("accumbens_area",
                          "amygdala",
                          "caudate",
                          "hippocampus",
                          "pallidum",
                          "putamen",
                          "thalamus"),
                sep = "_"),
          paste("right", c("accumbens_area",
                          "amygdala",
                          "caudate",
                          "hippocampus",
                          "pallidum",
                          "putamen",
                          "thalamus"),
                sep = "_"))
ctx <- colnames(df_baseline)[grep("^schaefer400.*.wscore$", colnames(df_baseline))]
list <- append(ctx, paste0(sctx, "_wscore"))
feature_tsv <- df_baseline[, c("id", "session", "group", list)]
colnames(feature_tsv) <- c("participant_id", "session_id", "diagnosis", list)
column_index <- 4:(length(list)+3)
feature_tsv[column_index] <- -1*feature_tsv[column_index] # flip so that more positive values correspond to greater atrophy
levels(feature_tsv$diagnosis) <- c("-1", "1")
write.table(feature_tsv, here::here("data/feature_SchaeferSubcortex414Parcels.tsv"), sep = '\t', row.names = FALSE)
```

```{r explore clusters}
df_baseline <- readRDS(here::here("data/df_baseline.Rds"))
## SchaeferSubcortex 114 parcels
hydra_labels <- read.csv(here::here("output/old/output/hydra_SchaeferSubcortex114Parcels/clustering/clustering_assignment.tsv"), sep = "\t")
hydra_labels$assignment_2 <- factor(hydra_labels$assignment_2, levels = c("-1", "1", "2"))
hydra_ARI <- as.data.frame(t(read.csv(here::here("output/old/output/hydra_SchaeferSubcortex114Parcels/clustering/adjusted_rand_index.tsv"), sep = "\t", header = FALSE)))
colnames(hydra_ARI) <- c("N_subtypes", "ARI")
hydra_ARI$N_subtypes <- c("1", "2", "3", "4", "5")
hydra_ARI$ARI <- as.numeric(hydra_ARI$ARI)
ARI_plot <- ggplot(data=hydra_ARI, aes(x=N_subtypes, y=ARI, group=1)) +
  geom_line(color="black", linetype = "solid") +
  geom_point(shape=19, color="black") +
  ylim(0,0.8) +
  labs(title = "HYDRA", x = "k", y = "ARI") +
  theme_minimal(base_size = 18)
ggsave(here("data/ARI_plot.png"), plot = ARI_plot, dpi = 300)
# write optimal clustering
hydra_labels_2subtypes <- hydra_labels[, c("participant_id", "session_id", "diagnosis", "assignment_2")]
write.csv(hydra_labels_2subtypes, here::here("data/hydra_SchaeferSubcortex114Parcels_2subtypes.csv"), row.names = FALSE)
# explore atrophy patterns
df_baseline_hydra <- merge(df_baseline, hydra_labels, by.x = "id", by.y = "participant_id")
sctx <- c(paste("left", c("accumbens_area",
                          "amygdala",
                          "caudate",
                          "hippocampus",
                          "pallidum",
                          "putamen",
                          "thalamus"),
                sep = "_"),
          paste("right", c("accumbens_area",
                          "amygdala",
                          "caudate",
                          "hippocampus",
                          "pallidum",
                          "putamen",
                          "thalamus"),
                sep = "_"))
ctx <- colnames(df_baseline)[grep("^schaefer100.*.wscore$", colnames(df_baseline))]
list <- append(ctx, paste0(sctx, "_wscore"))
atrophy_mapping_group1_cohend <- atrophy_mapping_group2_cohend <- atrophy_mapping_group1_pvalue <- atrophy_mapping_group2_pvalue <- data.frame(matrix(nrow = 1, ncol = length(list)))
colnames(atrophy_mapping_group1_cohend) <- colnames(atrophy_mapping_group2_cohend) <- gsub(pattern = "_wscore", replacement = "_cohend", list)
colnames(atrophy_mapping_group1_pvalue) <- colnames(atrophy_mapping_group2_pvalue) <- gsub(pattern = "_wscore", replacement = "_pvalue", list)
for (i in 1:length(list)) {
  d <- df_baseline_hydra[df_baseline_hydra$assignment_2=="1" | df_baseline_hydra$assignment_2=="-1", list[i]]
  f <- df_baseline_hydra[df_baseline_hydra$assignment_2=="1" | df_baseline_hydra$assignment_2=="-1", "assignment_2"]
  f <- factor(f, levels = c("-1", "1"))
  cohend <- effsize::cohen.d(d, f)
  ttest <- t.test(df_baseline_hydra[df_baseline_hydra$assignment_2=="1", list[i]], df_baseline_hydra[df_baseline_hydra$assignment_2=="-1", list[i]])
  atrophy_mapping_group1_cohend[,i] <- cohend$estimate
  atrophy_mapping_group1_pvalue[,i] <- ttest$p.value
}
for (i in 1:length(list)) {
  d <- df_baseline_hydra[df_baseline_hydra$assignment_2=="2" | df_baseline_hydra$assignment_2=="-1", list[i]]
  f <- df_baseline_hydra[df_baseline_hydra$assignment_2=="2" | df_baseline_hydra$assignment_2=="-1", "assignment_2"]
  f <- factor(f, levels = c("-1", "2"))
  cohend <- effsize::cohen.d(d, f)
  ttest <- t.test(df_baseline_hydra[df_baseline_hydra$assignment_2=="2", list[i]], df_baseline_hydra[df_baseline_hydra$assignment_2=="-1", list[i]])
  atrophy_mapping_group2_cohend[,i] <- cohend$estimate
  atrophy_mapping_group2_pvalue[,i] <- ttest$p.value
}
atrophy_mapping_group1_pvalue[1,] <- p.adjust(atrophy_mapping_group1_pvalue[1,], method = "fdr")
atrophy_mapping_group2_pvalue[1,] <- p.adjust(atrophy_mapping_group2_pvalue[1,], method = "fdr")
# write out
write.csv(atrophy_mapping_group1_cohend, here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex114Parcels_group1_cohend.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group1_pvalue, here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex114Parcels_group1_pfdr.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group2_cohend, here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex114Parcels_group2_cohend.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group2_pvalue, here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex114Parcels_group2_pfdr.csv"), row.names = FALSE)

## SchaeferSubcortex 414 parcels
hydra_labels <- read.csv(here::here("output/hydra_SchaeferSubcortex414Parcels/clustering/clustering_assignment.tsv"), sep = "\t")
hydra_labels$assignment_2 <- factor(hydra_labels$assignment_2, levels = c("-1", "1", "2"))
hydra_ARI <- as.data.frame(t(read.csv(here::here("output/hydra_SchaeferSubcortex414Parcels/clustering/adjusted_rand_index.tsv"), sep = "\t", header = FALSE)))
colnames(hydra_ARI) <- c("N_subtypes", "ARI")
hydra_ARI$ARI <- as.numeric(hydra_ARI$ARI)
ggplot(data=hydra_ARI, aes(x=N_subtypes, y=ARI, group=1)) +
  geom_line()+
  geom_point()+
  ylim(0,0.8)
# write optimal clustering
hydra_labels_2subtypes <- hydra_labels[, c("participant_id", "session_id", "diagnosis", "assignment_2")]
write.csv(hydra_labels_2subtypes, here::here("data/hydra_SchaeferSubcortex414Parcels_2subtypes.csv"), row.names = FALSE)
# explore atrophy patterns
df_baseline_hydra <- merge(df_baseline, hydra_labels, by.x = "id", by.y = "participant_id")
sctx <- c(paste("left", c("accumbens_area",
                          "amygdala",
                          "caudate",
                          "hippocampus",
                          "pallidum",
                          "putamen",
                          "thalamus"),
                sep = "_"),
          paste("right", c("accumbens_area",
                          "amygdala",
                          "caudate",
                          "hippocampus",
                          "pallidum",
                          "putamen",
                          "thalamus"),
                sep = "_"))
ctx <- colnames(df_baseline)[grep("^schaefer400.*.wscore$", colnames(df_baseline))]
list <- append(ctx, paste0(sctx, "_wscore"))
atrophy_mapping_group1_cohend <- atrophy_mapping_group2_cohend <- atrophy_mapping_group1_pvalue <- atrophy_mapping_group2_pvalue <- data.frame(matrix(nrow = 1, ncol = length(list)))
colnames(atrophy_mapping_group1_cohend) <- colnames(atrophy_mapping_group2_cohend) <- gsub(pattern = "_wscore", replacement = "_cohend", list)
colnames(atrophy_mapping_group1_pvalue) <- colnames(atrophy_mapping_group2_pvalue) <- gsub(pattern = "_wscore", replacement = "_pvalue", list)
for (i in 1:length(list)) {
  d <- df_baseline_hydra[df_baseline_hydra$assignment_2=="1" | df_baseline_hydra$assignment_2=="-1", list[i]]
  f <- df_baseline_hydra[df_baseline_hydra$assignment_2=="1" | df_baseline_hydra$assignment_2=="-1", "assignment_2"]
  f <- factor(f, levels = c("-1", "1"))
  cohend <- effsize::cohen.d(d, f)
  ttest <- t.test(df_baseline_hydra[df_baseline_hydra$assignment_2=="1", list[i]], df_baseline_hydra[df_baseline_hydra$assignment_2=="-1", list[i]])
  atrophy_mapping_group1_cohend[,i] <- cohend$estimate
  atrophy_mapping_group1_pvalue[,i] <- ttest$p.value
}
for (i in 1:length(list)) {
  d <- df_baseline_hydra[df_baseline_hydra$assignment_2=="2" | df_baseline_hydra$assignment_2=="-1", list[i]]
  f <- df_baseline_hydra[df_baseline_hydra$assignment_2=="2" | df_baseline_hydra$assignment_2=="-1", "assignment_2"]
  f <- factor(f, levels = c("-1", "2"))
  cohend <- effsize::cohen.d(d, f)
  ttest <- t.test(df_baseline_hydra[df_baseline_hydra$assignment_2=="2", list[i]], df_baseline_hydra[df_baseline_hydra$assignment_2=="-1", list[i]])
  atrophy_mapping_group2_cohend[,i] <- cohend$estimate
  atrophy_mapping_group2_pvalue[,i] <- ttest$p.value
}
atrophy_mapping_group1_pvalue[1,] <- p.adjust(atrophy_mapping_group1_pvalue[1,], method = "fdr")
atrophy_mapping_group2_pvalue[1,] <- p.adjust(atrophy_mapping_group2_pvalue[1,], method = "fdr")
# write out
write.csv(atrophy_mapping_group1_cohend, here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex414Parcels_group1_cohend.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group1_pvalue, here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex414Parcels_group1_pfdr.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group2_cohend, here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex414Parcels_group2_cohend.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group2_pvalue, here::here("data/atrophy_cross/atrophy_baseline_SchaeferSubcortex414Parcels_group2_pfdr.csv"), row.names = FALSE)
```



