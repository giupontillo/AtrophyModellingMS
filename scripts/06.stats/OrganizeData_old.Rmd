---
title: "OrganizeData"
author: "Giuseppe Pontillo"
date: '2024-11'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
system("export LD_LIBRARY_PATH=/opt/aumc-apps-eb/software/Anaconda3/2024.02-1/lib")
packages <- c("dplyr", "ggplot2", "here", "corrplot", "nlme", "psych", "effsize", "janitor", "VertexWiseR", "R.matlab", "reticulate")
lapply(packages, library, character.only = TRUE)
use_condaenv("atrophymodelling")
```



```{r import/transform/merge clinical and structural MRI data - atrophy_long PrograMS}
### PrograMS clinical database
PrograMS <- read.csv(here::here("data/PrograMS_v1.9.csv"), header = TRUE, sep = ",")
PrograMS[c('ClinicalPhenotype','DMT','Clinical','BRBn','NPSother')] <- lapply(PrograMS[c('ClinicalPhenotype','DMT','Clinical','BRBn','NPSother')], factor)
PrograMS$Sex <- factor(PrograMS$Sex, levels = c("female", "male"))
PrograMS$Group <- factor(PrograMS$Group, levels = c("HC", "MS"))
PrograMS[c('DoB','DateMRI','DateOfOnset')] <- lapply(PrograMS[c('DoB','DateMRI','DateOfOnset')], as.Date, format = "%d/%m/%Y")
# standardize BRB scores
BRB_tests <- colnames(PrograMS)[grep('BRB_', colnames(PrograMS))] 
for (i in BRB_tests){
  MDL <- lm(get(i) ~ Age + Sex + Education_years, 
            data = PrograMS[PrograMS$Group=="HC" & PrograMS$Session=="ses-Y00",], 
            na.action = na.exclude)
  PrograMS[,paste0(i,'_wscore')] <- (PrograMS[,i] - predict(MDL, PrograMS)) / sd(MDL$residuals)
}
PrograMS$BRB_STROOP_wscore <- -1 * PrograMS$BRB_STROOP_wscore # flip sign for stroop
PrograMS$MissingBRBtests <- rowSums(is.na(PrograMS[,BRB_tests])) 

### sMRI derivatives
# import cortical labels
labels_schaefer100_7networks <- read.csv(here::here("data/hcp_connectivity/funcLabels_ctx_schaefer_100.csv"), header = FALSE, sep = ",")
labels_schaefer400_7networks <- read.csv(here::here("data/hcp_connectivity/funcLabels_ctx_schaefer_400.csv"), header = FALSE, sep = ",")
# import and save vertex-wise thickness
FS_subjects_dir <- "/data/anw/knw-work/g.pontillo/predictive_modelling/atrophy_long/derivatives/freesurfer/prograMS"
vertexwise_thickness <- SURFvextract(sdirpath = FS_subjects_dir, filename = here::here("data/atrophy_long_PrograMS_VertexwiseThickness.Rds"), measure="thickness", template = "fsaverage5")
# import aseg and merge FS
aseg <- fs_stats(sdirpath = FS_subjects_dir, ROImeasure = "Volume_mm3")
colnames(aseg)[1] <- "FullID"
df_thickness <- data.frame(vertexwise_thickness)
colnames(df_thickness)[1] <- "FullID"
PrograMS_FS <- merge(df_thickness, aseg, by = "FullID")
# surf to atlas
CT_schaefer100 <- surf_to_atlas(PrograMS_FS[, grep("^X+[0-9]$|^X.*.[0-9]$", colnames(PrograMS_FS))], 4, mode = "mean")
colnames(CT_schaefer100) <- paste0("schaefer100_", labels_schaefer100_7networks, "_CT")
CT_schaefer400 <- surf_to_atlas(PrograMS_FS[, grep("^X+[0-9]$|^X.*.[0-9]$", colnames(PrograMS_FS))], 6, mode = "mean")
colnames(CT_schaefer400) <- paste0("schaefer400_", labels_schaefer400_7networks, "_CT")
PrograMS_FS <- cbind(PrograMS_FS, CT_schaefer100, CT_schaefer400)
# create baseline and longitudinal
PrograMS_FS_baseline <- PrograMS_FS[grep("^sub.*ses-Y05$", PrograMS_FS$FullID),]
PrograMS_FS_long <- PrograMS_FS[grep("^sub.*ses-.*.long.sub.*", PrograMS_FS$FullID),]
PrograMS_FS_long$FullID <- gsub(".long.*$", "", PrograMS_FS_long$FullID)
# import LST
PrograMS_LST <- read.csv(here::here("data/PrograMS_FreesurferLst.csv"), header = TRUE, sep = ",")

### merge clinical and sMRI databases
df_PrograMS_baseline <- merge(PrograMS, PrograMS_FS_baseline, by = "FullID") %>% merge(PrograMS_LST[,c("FullID", "N_les", "TLV")])
df_PrograMS_baseline <- clean_names(df_PrograMS_baseline)
df_PrograMS_long <- merge(PrograMS, PrograMS_FS_long, by = "FullID") %>% merge(PrograMS_LST[,c("FullID", "N_les", "TLV")])
df_PrograMS_long <- clean_names(df_PrograMS_long)

### w score
## long
# define regions/vertices
volumes <- c(paste("left", c("accumbens_area",
                             "amygdala",
                             "caudate",
                             "hippocampus",
                             "pallidum",
                             "putamen", 
                             "thalamus"),  
                  sep = "_"), 
             paste("right", c("accumbens_area",
                              "amygdala",
                              "caudate",
                              "hippocampus",
                              "pallidum",
                              "putamen",
                              "thalamus"),
                   sep = "_"))
CT_schaefer100 <- colnames(df_PrograMS_long)[grep("^schaefer100.*.ct$", colnames(df_PrograMS_long))]
CT_schaefer400 <- colnames(df_PrograMS_long)[grep("^schaefer400.*.ct$", colnames(df_PrograMS_long))]
# w score volumes/CT based on baseline HCs
for (i in volumes){
  MDL <- lm(get(i) ~ age + sex + estimated_total_intra_cranial_vol, data = df_PrograMS_baseline[df_PrograMS_baseline$group=="HC",], na.action = na.exclude)
  df_PrograMS_long[, paste0(i, "_wscore")] <- (df_PrograMS_long[, i] - predict(MDL, df_PrograMS_long)) / sd(MDL$residuals)
}
for (i in CT_schaefer100){
  MDL <- lm(get(i) ~ age + sex, data = df_PrograMS_baseline[df_PrograMS_baseline$group=="HC",], na.action = na.exclude)
  df_PrograMS_long[, paste0(i, "_wscore")] <- (df_PrograMS_long[, i] - predict(MDL, df_PrograMS_long)) / sd(MDL$residuals)
}
for (i in CT_schaefer400){
  MDL <- lm(get(i) ~ age + sex, data = df_PrograMS_baseline[df_PrograMS_baseline$group=="HC",], na.action = na.exclude)
  df_PrograMS_long[, paste0(i, "_wscore")] <- (df_PrograMS_long[, i] - predict(MDL, df_PrograMS_long)) / sd(MDL$residuals)
}

## baseline
# define regions
volumes <- c(paste("left", c("accumbens_area",
                             "amygdala",
                             "caudate",
                             "hippocampus",
                             "pallidum",
                             "putamen", 
                             "thalamus"),  
                  sep = "_"), 
             paste("right", c("accumbens_area",
                              "amygdala",
                              "caudate",
                              "hippocampus",
                              "pallidum",
                              "putamen",
                              "thalamus"),
                   sep = "_"))
CT_schaefer100 <- colnames(df_PrograMS_baseline)[grep("^schaefer100.*.ct$", colnames(df_PrograMS_baseline))]
CT_schaefer400 <- colnames(df_PrograMS_baseline)[grep("^schaefer400.*.ct$", colnames(df_PrograMS_baseline))]
# w score volumes/CT based on baseline HCs
for (i in volumes){
  MDL <- lm(get(i) ~ age + sex + estimated_total_intra_cranial_vol, data = df_PrograMS_baseline[df_PrograMS_baseline$group=="HC",], na.action = na.exclude)
  df_PrograMS_baseline[, paste0(i, "_wscore")] <- (df_PrograMS_baseline[, i] - predict(MDL, df_PrograMS_baseline)) / sd(MDL$residuals)
}
for (i in CT_schaefer100){
  MDL <- lm(get(i) ~ age + sex, data = df_PrograMS_baseline[df_PrograMS_baseline$group=="HC",], na.action = na.exclude)
  df_PrograMS_baseline[, paste0(i, "_wscore")] <- (df_PrograMS_baseline[, i] - predict(MDL, df_PrograMS_baseline)) / sd(MDL$residuals)
}
for (i in CT_schaefer400){
  MDL <- lm(get(i) ~ age + sex, data = df_PrograMS_baseline[df_PrograMS_baseline$group=="HC",], na.action = na.exclude)
  df_PrograMS_baseline[, paste0(i, "_wscore")] <- (df_PrograMS_baseline[, i] - predict(MDL, df_PrograMS_baseline)) / sd(MDL$residuals)
}

### write out
saveRDS(df_PrograMS_long, file = here::here("data/df_PrograMS_long.Rds"))
saveRDS(df_PrograMS_baseline, file = here::here("data/df_PrograMS_baseline.Rds"))
```

```{r cross-sectional and longitudinal atrophy maps atrophy_long PrograMS}
### baseline atrophy
df_PrograMS_baseline <- readRDS(here::here("data/df_PrograMS_baseline.Rds"))
## SchaeferSubcortex 114 parcels
sctx <- c(paste("left", c("accumbens_area",
                             "amygdala",
                             "caudate",
                             "hippocampus",
                             "pallidum",
                             "putamen", 
                             "thalamus"),  
                  sep = "_"), 
             paste("right", c("accumbens_area",
                              "amygdala",
                              "caudate",
                              "hippocampus",
                              "pallidum",
                              "putamen",
                              "thalamus"),
                   sep = "_"))
ctx <- colnames(df_PrograMS_baseline)[grep("^schaefer100.*.wscore$", colnames(df_PrograMS_baseline))]
list <- append(ctx, paste0(sctx, "_wscore"))
atrophy_mapping_individuals_wscore <- df_PrograMS_baseline[df_PrograMS_baseline$group=="MS", c("id",list)]
column_index <- 2:(length(list)+1)
atrophy_mapping_individuals_wscore[column_index] <- -1*atrophy_mapping_individuals_wscore[column_index] # flip so that more positive values correspond to greater atrophy
atrophy_mapping_group_cohend <- atrophy_mapping_group_long_cohend <- data.frame(matrix(nrow = 1, ncol = length(list)))
colnames(atrophy_mapping_group_cohend) <- colnames(atrophy_mapping_group_long_cohend) <- gsub(pattern = "_wscore", replacement = "_cohend", list)
df_PrograMS_long <- readRDS(here::here("data/df_PrograMS_long.Rds"))
df_PrograMS_long <- df_PrograMS_long %>%
  dplyr::group_by(id) %>%
  dplyr::mutate(n_scans=n()) # add number of scans
df_PrograMS_long <- df_PrograMS_long[(df_PrograMS_long$n_scans>1 & df_PrograMS_long$group == "MS") | df_PrograMS_long$group == "HC",]
df_PrograMS_baseline_long <- df_PrograMS_baseline[df_PrograMS_baseline$full_id %in% df_PrograMS_long$full_id,]
for (i in 1:length(list)) {
  d <- df_PrograMS_baseline[, list[i]]
  f <- df_PrograMS_baseline[, "group"]
  cohend <- effsize::cohen.d(d, f)
  atrophy_mapping_group_cohend[,i] <- cohend$estimate
}
for (i in 1:length(list)) {
  d <- df_PrograMS_baseline_long[, list[i]]
  f <- df_PrograMS_baseline_long[, "group"]
  cohend <- effsize::cohen.d(d, f)
  atrophy_mapping_group_long_cohend[,i] <- cohend$estimate
}


# write out
write.csv(atrophy_mapping_individuals_wscore, here::here("data/atrophy_cross/PrograMS_atrophy_baseline_SchaeferSubcortex114Parcels_individuals_wscore.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_cohend, here::here("data/atrophy_cross/PrograMS_atrophy_baseline_SchaeferSubcortex114Parcels_group_cohend.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_long_cohend, here::here("data/atrophy_cross/PrograMS_atrophy_baseline_SchaeferSubcortex114Parcels_group_long_cohend.csv"), row.names = FALSE)

## SchaferSubcortex 414 parcels
sctx <- c(paste("left", c("accumbens_area",
                             "amygdala",
                             "caudate",
                             "hippocampus",
                             "pallidum",
                             "putamen", 
                             "thalamus"),  
                  sep = "_"), 
             paste("right", c("accumbens_area",
                              "amygdala",
                              "caudate",
                              "hippocampus",
                              "pallidum",
                              "putamen",
                              "thalamus"),
                   sep = "_"))
ctx <- colnames(df_PrograMS_baseline)[grep("^schaefer400.*.wscore$", colnames(df_PrograMS_baseline))]
list <- append(ctx, paste0(sctx, "_wscore"))
atrophy_mapping_individuals_wscore <- df_PrograMS_baseline[df_PrograMS_baseline$group=="MS", c("id",list)]
column_index <- 2:(length(list)+1)
atrophy_mapping_individuals_wscore[column_index] <- -1*atrophy_mapping_individuals_wscore[column_index] # flip so that more positive values correspond to greater atrophy
atrophy_mapping_group_cohend <- atrophy_mapping_group_long_cohend <- data.frame(matrix(nrow = 1, ncol = length(list)))
colnames(atrophy_mapping_group_cohend) <- colnames(atrophy_mapping_group_long_cohend) <- gsub(pattern = "_wscore", replacement = "_cohend", list)
df_PrograMS_long <- readRDS(here::here("data/df_PrograMS_long.Rds"))
df_PrograMS_long <- df_PrograMS_long %>%
  dplyr::group_by(id) %>%
  dplyr::mutate(n_scans=n()) # add number of scans
df_PrograMS_long <- df_PrograMS_long[(df_PrograMS_long$n_scans>1 & df_PrograMS_long$group == "MS") | df_PrograMS_long$group == "HC",]
df_PrograMS_baseline_long <- df_PrograMS_baseline[df_PrograMS_baseline$full_id %in% df_PrograMS_long$full_id,]
for (i in 1:length(list)) {
  d <- df_PrograMS_baseline[, list[i]]
  f <- df_PrograMS_baseline[, "group"]
  cohend <- effsize::cohen.d(d, f)
  atrophy_mapping_group_cohend[,i] <- cohend$estimate
}
for (i in 1:length(list)) {
  d <- df_PrograMS_baseline_long[, list[i]]
  f <- df_PrograMS_baseline_long[, "group"]
  cohend <- effsize::cohen.d(d, f)
  atrophy_mapping_group_long_cohend[,i] <- cohend$estimate
}

# write out
write.csv(atrophy_mapping_individuals_wscore, here::here("data/atrophy_cross/PrograMS_atrophy_baseline_SchaeferSubcortex414Parcels_individuals_wscore.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_cohend, here::here("data/atrophy_cross/PrograMS_atrophy_baseline_SchaeferSubcortex414Parcels_group_cohend.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_long_cohend, here::here("data/atrophy_cross/PrograMS_atrophy_baseline_SchaeferSubcortex414Parcels_group_long_cohend.csv"), row.names = FALSE)

### longitudinal atrophy
df_PrograMS_long <- readRDS(here::here("data/df_PrograMS_long.Rds"))
## SchaeferSubcortex 114 parcels
sctx <- c(paste("left", c("accumbens_area",
                             "amygdala",
                             "caudate",
                             "hippocampus",
                             "pallidum",
                             "putamen", 
                             "thalamus"),  
                  sep = "_"), 
             paste("right", c("accumbens_area",
                              "amygdala",
                              "caudate",
                              "hippocampus",
                              "pallidum",
                              "putamen",
                              "thalamus"),
                   sep = "_"))
ctx <- colnames(df_PrograMS_long)[grep("^schaefer100.*.ct$", colnames(df_PrograMS_baseline))]
list <- append(ctx, sctx)
# growth models
df_PrograMS_long <- df_PrograMS_long %>%
  dplyr::group_by(id) %>%
  dplyr::mutate(n_scans=n()) # add number of scans
atrophy_mapping_individuals_slope <- data.frame(matrix(nrow = length(unique(df_PrograMS_long$id[df_PrograMS_long$group=="MS" & df_PrograMS_long$n_scans!=1])), ncol = length(list)+1))
colnames(atrophy_mapping_individuals_slope) = c("id", paste0(list, "_slope")) # individual slopes of atrophy over time
atrophy_mapping_individuals_slope$id <- unique(df_PrograMS_long$id[df_PrograMS_long$group=="MS" & df_PrograMS_long$n_scans!=1])
atrophy_mapping_group_tvalue <- data.frame(matrix(nrow = 1, ncol = length(list)))
colnames(atrophy_mapping_group_tvalue) <- paste0(list, "_tvalue") # test statistic of the effect of time on volumes/CT
for (i in list){
  MDL_group <- lme(as.formula(paste0(i, " ~ fu_time")),
             data = df_PrograMS_long[df_PrograMS_long$group=="MS" & df_PrograMS_long$n_scans!=1,],
             random = ~fu_time|id, method="ML", na.action = na.exclude,
             correlation = corAR1(0, form = ~fu_time|id),
             control = list(msMaxIter = 1000, msMaxEval = 1000, opt = "optim", returnObject = TRUE))
    atrophy_mapping_group_tvalue[,paste0(i, "_tvalue")] <- coef(summary(MDL_group))["fu_time", "t-value"]
    for (l in atrophy_mapping_individuals_slope$id){
      MDL_individual <- lm(get(i) ~ fu_time, data = df_PrograMS_long[df_PrograMS_long$id==l,])
      atrophy_mapping_individuals_slope[atrophy_mapping_individuals_slope$id==l, paste0(i, "_slope")] <- (MDL_individual$coefficients[[2]] / df_PrograMS_long[df_PrograMS_long$id==l & df_PrograMS_long$session=="ses-Y05",i])*100
    }
}
atrophy_mapping_group_tvalue <- -1*atrophy_mapping_group_tvalue # flip so that more positive values correspond to greater atrophy
column_index <- 2:(length(list)+1)
atrophy_mapping_individuals_slope[column_index] <- -1*atrophy_mapping_individuals_slope[column_index] # flip so that more positive values correspond to greater atrophy

# write out
write.csv(atrophy_mapping_individuals_slope, here::here("data/atrophy_long/PrograMS_atrophy_long_SchaeferSubcortex114Parcels_individual_slopes.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_tvalue, here::here("data/atrophy_long/PrograMS_atrophy_long_SchaeferSubcortex114Parcels_group_t-values.csv"), row.names = FALSE)

## SchaeferSubcortex 414 parcels
sctx <- c(paste("left", c("accumbens_area",
                             "amygdala",
                             "caudate",
                             "hippocampus",
                             "pallidum",
                             "putamen", 
                             "thalamus"),  
                  sep = "_"), 
             paste("right", c("accumbens_area",
                              "amygdala",
                              "caudate",
                              "hippocampus",
                              "pallidum",
                              "putamen",
                              "thalamus"),
                   sep = "_"))
ctx <- colnames(df_PrograMS_long)[grep("^schaefer400.*.ct$", colnames(df_PrograMS_baseline))]
list <- append(ctx, sctx)
# growth models
df_PrograMS_long <- df_PrograMS_long %>%
  dplyr::group_by(id) %>%
  dplyr::mutate(n_scans=n()) # add number of scans
atrophy_mapping_individuals_slope <- data.frame(matrix(nrow = length(unique(df_PrograMS_long$id[df_PrograMS_long$group=="MS" & df_PrograMS_long$n_scans!=1])), ncol = length(list)+1))
colnames(atrophy_mapping_individuals_slope) = c("id", paste0(list, "_slope")) # individual slopes of atrophy over time
atrophy_mapping_individuals_slope$id <- unique(df_PrograMS_long$id[df_PrograMS_long$group=="MS" & df_PrograMS_long$n_scans!=1])
atrophy_mapping_group_tvalue <- data.frame(matrix(nrow = 1, ncol = length(list)))
colnames(atrophy_mapping_group_tvalue) <- paste0(list, "_tvalue") # test statistic of the effect of time on volumes/CT
for (i in list){
  MDL_group <- lme(as.formula(paste0(i, " ~ fu_time")),
             data = df_PrograMS_long[df_PrograMS_long$group=="MS" & df_PrograMS_long$n_scans!=1,],
             random = ~fu_time|id, method="ML", na.action = na.exclude,
             correlation = corAR1(0, form = ~fu_time|id),
             control = list(msMaxIter = 1000, msMaxEval = 1000, opt = "optim", returnObject = TRUE))
    atrophy_mapping_group_tvalue[,paste0(i, "_tvalue")] <- coef(summary(MDL_group))["fu_time", "t-value"]
    for (l in atrophy_mapping_individuals_slope$id){
      MDL_individual <- lm(get(i) ~ fu_time, data = df_PrograMS_long[df_PrograMS_long$id==l,])
      atrophy_mapping_individuals_slope[atrophy_mapping_individuals_slope$id==l, paste0(i, "_slope")] <- (MDL_individual$coefficients[[2]] / df_PrograMS_long[df_PrograMS_long$id==l & df_PrograMS_long$session=="ses-Y05",i])*100
    }
}
atrophy_mapping_group_tvalue <- -1*atrophy_mapping_group_tvalue # flip so that more positive values correspond to greater atrophy
column_index <- 2:(length(list)+1)
atrophy_mapping_individuals_slope[column_index] <- -1*atrophy_mapping_individuals_slope[column_index] # flip so that more positive values correspond to greater atrophy

# write out
write.csv(atrophy_mapping_individuals_slope, here::here("data/atrophy_long/PrograMS_atrophy_long_SchaeferSubcortex414Parcels_individual_slopes.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_tvalue, here::here("data/atrophy_long/PrograMS_atrophy_long_SchaeferSubcortex414Parcels_group_t-values.csv"), row.names = FALSE)
```

```{python plot maps}
from enigmatoolbox.utils.parcellation import parcel_to_surface
from enigmatoolbox.plotting import plot_cortical
from enigmatoolbox.plotting import plot_subcortical
import numpy as np

# import values and separate cortical and subcortical 
atrophy_map = np.loadtxt("/data/anw/knw-work/g.pontillo/predictive_modelling/code/stats/AtrophyModelling/data/atrophy_long/PrograMS_atrophy_long_SchaeferSubcortex114Parcels_group_t-values.csv", delimiter=',', skiprows=1)
atrophy_cortical = atrophy_map[0:100] # values for cortical regions ordered according to the 100 parcels 7 Networks version of the Schaefer atlas  
atrophy_subcortical = atrophy_map[100:114] # values for subcortical regions ordered alphabetically, with all left hemisphere first followed by right hemisphere 

# map parcels to vertices 
atrophy_fsa5 = parcel_to_surface(atrophy_cortical, 'schaefer_100_fsa5')

# plot 
plot_cortical(array_name=atrophy_fsa5, surface_name="fsa5", size=(800, 400), cmap='RdBu_r', color_bar=True, color_range=(-1, 4), screenshot=True, filename="atrophy_ctx.png")
plot_subcortical(array_name=atrophy_subcortical, ventricles=False, size=(800, 400), cmap='RdBu_r', color_bar=True, color_range=(-1, 5), screenshot=True, filename="atrophy_sctx.png")

```


```{r disconnection maps}
dir_lst <- "/data/anw/knw-work/g.pontillo/predictive_modelling/atrophy_long/derivatives/lst"
list_subs <- grep("^sub-PA.*.ses-Y05$",list.dirs(path = dir_lst, recursive = FALSE, full.names = FALSE), value = TRUE) # list of MS subjects at baseline  

## SchaeferSubcortex 114 parcels 
list <- list.files(path="/data/anw/knw-work/g.pontillo/predictive_modelling/atrophy_long/derivatives/lst/disconnectome_SchaeferSubcortex114Parcels", pattern=".*sub-PA.*ses-Y05.*percent_parcel_SDC.mat", full.names=TRUE, recursive=TRUE) # list of baseline disconnection matrices  
atlas <- read.csv("/data/anw/knw-work/g.pontillo/predictive_modelling/code/MRI_processing/atlases/CortexSubcortex/atlas-SchaeferSubcortex114Parcels_dseg.tsv", header = TRUE, sep = "\t") # atlas 
labels <- as.character(atlas[,"label"]) # atlas labels
labels_ctx <- labels[1:100]
labels_sctx <- labels[101:114]
roi <- length(labels)
df_disc <- data.frame(matrix(nrow = length(list_subs), ncol = ((roi*(roi-1))/2)+1))
df_disc_ctx <- data.frame(matrix(nrow = length(list_subs), ncol = ((100*(100-1))/2)+1))
df_disc_sctx <- data.frame(matrix(nrow = length(list_subs), ncol = (14*100)+1))
colnames(df_disc)[1] <- "ID"
for (i in 1:length(list_subs)) {
  disc <- readMat(list[i])[[1]]
  disc_ctx <- disc[1:100, 1:100]
  disc_sctx <- disc[101:114, 1:100]
  disc_flat <- disc[upper.tri(disc, diag = FALSE)] # this equals to using numpy.tril as R is column-major
  disc_flat_ctx <- disc_ctx[upper.tri(disc_ctx, diag = FALSE)] # this equals to using numpy.tril as R is column-major
  disc_flat_sctx <- as.vector(t(disc_sctx))
  df_disc[i,1] <- df_disc_ctx[i,1] <- df_disc_sctx[i,1] <- list_subs[i] 
  df_disc[i,2:ncol(df_disc)] <- disc_flat
  df_disc_ctx[i,2:ncol(df_disc_ctx)] <- disc_flat_ctx
  df_disc_sctx[i,2:ncol(df_disc_sctx)] <- disc_flat_sctx
} 
index <- which(upper.tri(disc, diag = FALSE), arr.ind=TRUE)
for (i in 1:dim(index)[1]){
  colnames(df_disc)[1+i] <- paste0(labels_ctx[index[i,1]], 
                                   "_to_",
                                   labels_ctx[index[i,2]]) 
}
index_ctx <- which(upper.tri(disc_ctx, diag = FALSE), arr.ind=TRUE)
for (i in 1:dim(index_ctx)[1]){
  colnames(df_disc_ctx)[1+i] <- paste0(labels_ctx[index_ctx[i,1]], 
                                   "_to_",
                                   labels_ctx[index_ctx[i,2]]) 
}
index_sctx <- which((t(disc_sctx) == t(disc_sctx)), arr.ind=TRUE)
for (i in 1:dim(index_sctx)[1]){
  colnames(df_disc_sctx)[1+i] <- paste0(labels_sctx[index_sctx[i,1]], 
                                   "_to_",
                                   labels_ctx[index_sctx[i,2]]) 
}

# average disconnectome
average_disc_MS <- colMeans(df_disc[,-1], na.rm = TRUE)
mat_MS <- matrix(nrow = roi, ncol = roi)
mat_MS[upper.tri(mat_MS)] <- as.matrix(average_disc_MS)
mat_MS <- as.matrix(Matrix::forceSymmetric(mat_MS, uplo = "U"))
diag(mat_MS) <- 0
mat_MS_ctx <- mat_MS[1:100, 1:100]
mat_MS_sctx <- mat_MS[101:114,1:100]

# average disconnectome long
df_PrograMS_long <- readRDS(here::here("data/df_PrograMS_long.Rds"))
df_PrograMS_long <- df_PrograMS_long %>%
  dplyr::group_by(id) %>%
  dplyr::mutate(n_scans=n()) # add number of scans
df_PrograMS_long <- df_PrograMS_long[df_PrograMS_long$n_scans>1 & df_PrograMS_long$group == "MS",]
df_disc_long <- df_disc[df_disc$ID %in% df_PrograMS_long$full_id,]
average_disc_MS_long <- colMeans(df_disc_long[,-1], na.rm = TRUE)
mat_MS_long <- matrix(nrow = roi, ncol = roi)
mat_MS_long[upper.tri(mat_MS_long)] <- as.matrix(average_disc_MS_long)
mat_MS_long <- as.matrix(Matrix::forceSymmetric(mat_MS_long, uplo = "U"))
diag(mat_MS_long) <- 0
mat_MS_long_ctx <- mat_MS[1:100, 1:100]
mat_MS_long_sctx <- mat_MS[101:114,1:100]

# write average and individuals disconnectomes
write.table(mat_MS, here::here("data/disc/PrograMS_disc_SchaeferSubcortex114Parcels_group.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(labels, here::here("data/disc/disc_SchaeferSubcortex114Parcels_labels.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_ctx, here::here("data/disc/PrograMS_disc_SchaeferSubcortex114Parcels_group_ctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_sctx, here::here("data/disc/PrograMS_disc_SchaeferSubcortex114Parcels_group_sctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_long, here::here("data/disc/PrograMS_disc_SchaeferSubcortex114Parcels_group_long.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_long_ctx, here::here("data/disc/PrograMS_disc_SchaeferSubcortex114Parcels_group_long_ctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_long_sctx, here::here("data/disc/PrograMS_disc_SchaeferSubcortex114Parcels_group_long_sctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.csv(df_disc_ctx, here::here("data/disc/PrograMS_disc_SchaeferSubcortex114Parcels_individuals_ctx.csv"), row.names = FALSE)
write.csv(df_disc_sctx, here::here("data/disc/PrograMS_disc_SchaeferSubcortex114Parcels_individuals_sctx.csv"), row.names = FALSE)

## SchaeferSubcortex 414 parcels 
list <- list.files(path="/data/anw/knw-work/g.pontillo/predictive_modelling/atrophy_long/derivatives/lst/disconnectome_SchaeferSubcortex414Parcels", pattern=".*sub-PA.*ses-Y05.*percent_parcel_SDC.mat", full.names=TRUE, recursive=TRUE) # list of baseline disconnection matrices  
atlas <- read.csv("/data/anw/knw-work/g.pontillo/predictive_modelling/code/MRI_processing/atlases/CortexSubcortex/atlas-SchaeferSubcortex414Parcels_dseg.tsv", header = TRUE, sep = "\t") # atlas 
labels <- as.character(atlas[,"label"]) # atlas labels
labels_ctx <- labels[1:400]
labels_sctx <- labels[401:414]
roi <- length(labels)
df_disc <- data.frame(matrix(nrow = length(list_subs), ncol = ((roi*(roi-1))/2)+1))
df_disc_ctx <- data.frame(matrix(nrow = length(list_subs), ncol = ((400*(400-1))/2)+1))
df_disc_sctx <- data.frame(matrix(nrow = length(list_subs), ncol = (14*400)+1))
colnames(df_disc)[1] <- "ID"
for (i in 1:length(list_subs)) {
  disc <- readMat(list[i])[[1]]
  disc_ctx <- disc[1:400, 1:400]
  disc_sctx <- disc[401:414, 1:400]
  disc_flat <- disc[upper.tri(disc, diag = FALSE)] # this equals to using numpy.tril as R is column-major
  disc_flat_ctx <- disc_ctx[upper.tri(disc_ctx, diag = FALSE)] # this equals to using numpy.tril as R is column-major
  disc_flat_sctx <- as.vector(t(disc_sctx))
  df_disc[i,1] <- df_disc_ctx[i,1] <- df_disc_sctx[i,1] <- list_subs[i] 
  df_disc[i,2:ncol(df_disc)] <- disc_flat
  df_disc_ctx[i,2:ncol(df_disc_ctx)] <- disc_flat_ctx
  df_disc_sctx[i,2:ncol(df_disc_sctx)] <- disc_flat_sctx
} 
index <- which(upper.tri(disc, diag = FALSE), arr.ind=TRUE)
for (i in 1:dim(index)[1]){
  colnames(df_disc)[1+i] <- paste0(labels_ctx[index[i,1]], 
                                   "_to_",
                                   labels_ctx[index[i,2]]) 
}
index_ctx <- which(upper.tri(disc_ctx, diag = FALSE), arr.ind=TRUE)
for (i in 1:dim(index_ctx)[1]){
  colnames(df_disc_ctx)[1+i] <- paste0(labels_ctx[index_ctx[i,1]], 
                                   "_to_",
                                   labels_ctx[index_ctx[i,2]]) 
}
index_sctx <- which((t(disc_sctx) == t(disc_sctx)), arr.ind=TRUE)
for (i in 1:dim(index_sctx)[1]){
  colnames(df_disc_sctx)[1+i] <- paste0(labels_sctx[index_sctx[i,1]], 
                                   "_to_",
                                   labels_ctx[index_sctx[i,2]]) 
}

# average disconnectome
average_disc_MS <- colMeans(df_disc[,-1], na.rm = TRUE)
mat_MS <- matrix(nrow = roi, ncol = roi)
mat_MS[upper.tri(mat_MS)] <- as.matrix(average_disc_MS)
mat_MS <- as.matrix(Matrix::forceSymmetric(mat_MS, uplo = "U"))
diag(mat_MS) <- 0
mat_MS_ctx <- mat_MS[1:400, 1:400]
mat_MS_sctx <- mat_MS[401:414,1:400]

# average disconnectome long
df_PrograMS_long <- readRDS(here::here("data/df_PrograMS_long.Rds"))
df_PrograMS_long <- df_PrograMS_long %>%
  dplyr::group_by(id) %>%
  dplyr::mutate(n_scans=n()) # add number of scans
df_PrograMS_long <- df_PrograMS_long[df_PrograMS_long$n_scans>1 & df_PrograMS_long$group == "MS",]
df_disc_long <- df_disc[df_disc$ID %in% df_PrograMS_long$full_id,]
average_disc_MS_long <- colMeans(df_disc_long[,-1], na.rm = TRUE)
mat_MS_long <- matrix(nrow = roi, ncol = roi)
mat_MS_long[upper.tri(mat_MS_long)] <- as.matrix(average_disc_MS_long)
mat_MS_long <- as.matrix(Matrix::forceSymmetric(mat_MS_long, uplo = "U"))
diag(mat_MS_long) <- 0
mat_MS_long_ctx <- mat_MS[1:400, 1:400]
mat_MS_long_sctx <- mat_MS[401:414,1:400]

# write average and individuals disconnectomes
write.table(mat_MS, here::here("data/disc/PrograMS_disc_SchaeferSubcortex414Parcels_group.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(labels, here::here("data/disc/disc_SchaeferSubcortex414Parcels_labels.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_ctx, here::here("data/disc/PrograMS_disc_SchaeferSubcortex414Parcels_group_ctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_sctx, here::here("data/disc/PrograMS_disc_SchaeferSubcortex414Parcels_group_sctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_long, here::here("data/disc/PrograMS_disc_SchaeferSubcortex414Parcels_group_long.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_long_ctx, here::here("data/disc/PrograMS_disc_SchaeferSubcortex414Parcels_group_long_ctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_long_sctx, here::here("data/disc/PrograMS_disc_SchaeferSubcortex414Parcels_group_long_sctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.csv(df_disc_ctx, here::here("data/disc/PrograMS_disc_SchaeferSubcortex414Parcels_individuals_ctx.csv"), row.names = FALSE)
write.csv(df_disc_sctx, here::here("data/disc/PrograMS_disc_SchaeferSubcortex414Parcels_individuals_sctx.csv"), row.names = FALSE)
```

```{r correlated gene expression matrix}
## SchaeferSubcortex 114 parcels
# load gene expression vectors
GE_vectors <- read.csv(here::here("data/ge/allgenes_stable_r0.2_schaefer_100.csv"), header = TRUE, sep = ",")
tGE_vectors <- t(GE_vectors[,-1])
colnames(tGE_vectors) <- GE_vectors$label
CGE <- cor(t(GE_vectors[,-1]))
# corrplot(CGE, method="color")
mat_CGE <- as.matrix(Matrix::forceSymmetric(CGE, uplo = "U"))
diag(mat_CGE) <- 0
mat_CGE_ctx <- mat_CGE[1:100, 1:100]
mat_CGE_sctx <- mat_CGE[101:114,1:100]
# write average matrices
write.table(mat_CGE, here::here("data/ge/CGE_SchaeferSubcortex114Parcels.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_CGE_ctx, here::here("data/ge/CGE_SchaeferSubcortex114Parcels_ctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_CGE_sctx, here::here("data/ge/CGE_SchaeferSubcortex114Parcels_sctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(GE_vectors$label, here::here("data/ge/SchaeferSubcortex114Parcels_labels.csv"), sep = ',', row.names = FALSE, col.names = FALSE)

## SchaeferSubcortex 414 parcels
# load gene expression vectors
GE_vectors <- read.csv(here::here("data/ge/allgenes_stable_r0.2_schaefer_400.csv"), header = TRUE, sep = ",")
tGE_vectors <- t(GE_vectors[,-1])
colnames(tGE_vectors) <- GE_vectors$label
CGE <- cor(t(GE_vectors[,-1]), use = "pairwise.complete.obs")
# corrplot(CGE, method="color")
mat_CGE <- as.matrix(Matrix::forceSymmetric(CGE, uplo = "U"))
diag(mat_CGE) <- 0
mat_CGE_ctx <- mat_CGE[1:400, 1:400]
mat_CGE_sctx <- mat_CGE[401:414,1:400]
# write average matrices
write.table(mat_CGE, here::here("data/ge/CGE_SchaeferSubcortex414Parcels.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_CGE_ctx, here::here("data/ge/CGE_SchaeferSubcortex414Parcels_ctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_CGE_sctx, here::here("data/ge/CGE_SchaeferSubcortex414Parcels_sctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(GE_vectors$label, here::here("data/ge/SchaeferSubcortex414Parcels_labels.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
```

```{r compute neighbour atrophy weighted by SC/FC/CGE}
### SchaeferSubcortex 114 parcels
# load normative functional/structural/CGE matrices
labels <- read.csv(here::here("data/fc/fc_SchaeferSubcortex114Parcels_labels.csv"), header = TRUE, sep = ",")
fc_ctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/funcMatrix_ctx_schaefer_100.csv"), header = FALSE, sep = ","))
fc_sctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/funcMatrix_sctx_schaefer_100.csv"), header = FALSE, sep = ","))
sc_ctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/strucMatrix_ctx_schaefer_100.csv"), header = FALSE, sep = ","))
sc_sctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/strucMatrix_sctx_schaefer_100.csv"), header = FALSE, sep = ","))
sc_sctx <- sc_sctx[,1:100] # the sctx matrix contains also subcortico-subcortical connections
cge_ctx <- as.matrix(read.csv(here::here("data/ge/CGE_SchaeferSubcortex114Parcels_ctx.csv"), header = FALSE, sep = ","))
cge_sctx <- as.matrix(read.csv(here::here("data/ge/CGE_SchaeferSubcortex114Parcels_sctx.csv"), header = FALSE, sep = ","))

## group-level
# load atrophy map
atrophy_mapping <- read.csv(here::here("data/atrophy_cross/PrograMS_atrophy_baseline_SchaeferSubcortex114Parcels_group_cohend.csv"), header = TRUE, sep = ",")
atrophy_ctx <- atrophy_mapping[,1:100]
atrophy_sctx <- atrophy_mapping[,101:114]
# compute neighbourhood atrophy
neighbourhood_atrophy_sc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_sc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(sc_ctx[i,]!=0)
  weight_vec <- sc_ctx[i,c(neighbours)]
  neighbourhood_atrophy_sc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

neighbourhood_atrophy_sc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_sc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(sc_sctx[i,]!=0)
  weight_vec <- sc_sctx[i,c(neighbours)]
  neighbourhood_atrophy_sc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

neighbourhood_atrophy_fc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_fc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(fc_ctx[i,]!=0)
  weight_vec <- fc_ctx[i,c(neighbours)]
  neighbourhood_atrophy_fc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

neighbourhood_atrophy_fc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_fc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(fc_sctx[i,]!=0)
  weight_vec <- fc_sctx[i,c(neighbours)]
  neighbourhood_atrophy_fc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

neighbourhood_atrophy_cge_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_cge_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(cge_ctx[i,]!=0 & !is.na(cge_ctx[i,]))
  weight_vec <- cge_ctx[i,c(neighbours)]
  neighbourhood_atrophy_cge_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

neighbourhood_atrophy_cge_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_cge_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(cge_sctx[i,]!=0 & !is.na(cge_sctx[i,]))
  weight_vec <- cge_sctx[i,c(neighbours)]
  neighbourhood_atrophy_cge_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

# write out
write.csv(neighbourhood_atrophy_sc_ctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_sc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_sc_sctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_sc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_ctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_fc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_sctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_fc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_ctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_cge_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_sctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_cge_sctx.csv"), row.names = FALSE)

## group-level long
# load atrophy map
atrophy_mapping <- read.csv(here::here("data/atrophy_cross/PrograMS_atrophy_baseline_SchaeferSubcortex114Parcels_group_long_cohend.csv"), header = TRUE, sep = ",")
atrophy_ctx <- atrophy_mapping[,1:100]
atrophy_sctx <- atrophy_mapping[,101:114]
# compute neighbourhood atrophy
neighbourhood_atrophy_sc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_sc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(sc_ctx[i,]!=0)
  weight_vec <- sc_ctx[i,c(neighbours)]
  neighbourhood_atrophy_sc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

neighbourhood_atrophy_sc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_sc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(sc_sctx[i,]!=0)
  weight_vec <- sc_sctx[i,c(neighbours)]
  neighbourhood_atrophy_sc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

neighbourhood_atrophy_fc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_fc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(fc_ctx[i,]!=0)
  weight_vec <- fc_ctx[i,c(neighbours)]
  neighbourhood_atrophy_fc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

neighbourhood_atrophy_fc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_fc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(fc_sctx[i,]!=0)
  weight_vec <- fc_sctx[i,c(neighbours)]
  neighbourhood_atrophy_fc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

neighbourhood_atrophy_cge_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_cge_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(cge_ctx[i,]!=0 & !is.na(cge_ctx[i,]))
  weight_vec <- cge_ctx[i,c(neighbours)]
  neighbourhood_atrophy_cge_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

neighbourhood_atrophy_cge_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_cge_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(cge_sctx[i,]!=0 & !is.na(cge_sctx[i,]))
  weight_vec <- cge_sctx[i,c(neighbours)]
  neighbourhood_atrophy_cge_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

# write out
write.csv(neighbourhood_atrophy_sc_ctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_long_sc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_sc_sctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_long_sc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_ctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_long_fc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_sctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_long_fc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_ctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_long_cge_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_sctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_group_long_cge_sctx.csv"), row.names = FALSE)

## individual-level
# load atrophy map individuals
atrophy_mapping <- read.csv(here::here("data/atrophy_cross/PrograMS_atrophy_baseline_SchaeferSubcortex114Parcels_individuals_wscore.csv"), header = TRUE, sep = ",")
atrophy_ctx <- atrophy_mapping[,2:101]
atrophy_sctx <- atrophy_mapping[,102:115]
# compute neighbourhood atrophy
neighbourhood_atrophy_sc_ctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_ctx))))
colnames(neighbourhood_atrophy_sc_ctx) <- append("id", paste0(colnames(atrophy_ctx), "_neighbours"))
neighbourhood_atrophy_sc_ctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_ctx)){
    neighbours <- which(sc_ctx[i,]!=0)
    weight_vec <- sc_ctx[i,c(neighbours)]
    neighbourhood_atrophy_sc_ctx[neighbourhood_atrophy_sc_ctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
}

neighbourhood_atrophy_sc_sctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_sctx))))
colnames(neighbourhood_atrophy_sc_sctx) <- append("id", paste0(colnames(atrophy_sctx), "_neighbours"))
neighbourhood_atrophy_sc_sctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_sctx)){
    neighbours <- which(sc_sctx[i,]!=0)
    weight_vec <- sc_sctx[i,c(neighbours)]
    neighbourhood_atrophy_sc_sctx[neighbourhood_atrophy_sc_sctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
}

neighbourhood_atrophy_fc_ctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_ctx))))
colnames(neighbourhood_atrophy_fc_ctx) <- append("id", paste0(colnames(atrophy_ctx), "_neighbours"))
neighbourhood_atrophy_fc_ctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_ctx)){
    neighbours <- which(fc_ctx[i,]!=0)
    weight_vec <- fc_ctx[i,c(neighbours)]
    neighbourhood_atrophy_fc_ctx[neighbourhood_atrophy_fc_ctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
}

neighbourhood_atrophy_fc_sctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_sctx))))
colnames(neighbourhood_atrophy_fc_sctx) <- append("id", paste0(colnames(atrophy_sctx), "_neighbours"))
neighbourhood_atrophy_fc_sctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_sctx)){
    neighbours <- which(fc_sctx[i,]!=0)
    weight_vec <- fc_sctx[i,c(neighbours)]
    neighbourhood_atrophy_fc_sctx[neighbourhood_atrophy_fc_sctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
}

neighbourhood_atrophy_cge_ctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_ctx))))
colnames(neighbourhood_atrophy_cge_ctx) <- append("id", paste0(colnames(atrophy_ctx), "_neighbours"))
neighbourhood_atrophy_cge_ctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_ctx)){
    neighbours <- which(cge_ctx[i,]!=0 & !is.na(cge_ctx[i,]))
    weight_vec <- cge_ctx[i,c(neighbours)]
    neighbourhood_atrophy_cge_ctx[neighbourhood_atrophy_cge_ctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
}

neighbourhood_atrophy_cge_sctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_sctx))))
colnames(neighbourhood_atrophy_cge_sctx) <- append("id", paste0(colnames(atrophy_sctx), "_neighbours"))
neighbourhood_atrophy_cge_sctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_sctx)){
    neighbours <- which(cge_sctx[i,]!=0 & !is.na(cge_sctx[i,]))
    weight_vec <- cge_sctx[i,c(neighbours)]
    neighbourhood_atrophy_cge_sctx[neighbourhood_atrophy_cge_sctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
}

# write out
write.csv(neighbourhood_atrophy_sc_ctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_individuals_sc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_sc_sctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_individuals_sc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_ctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_individuals_fc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_sctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_individuals_fc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_ctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_individuals_cge_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_sctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_individuals_cge_sctx.csv"), row.names = FALSE)

### SchaeferSubcortex 414 parcels
# load normative functional/structural/CGE matrices
labels <- read.csv(here::here("data/fc/fc_SchaeferSubcortex414Parcels_labels.csv"), header = TRUE, sep = ",")
fc_ctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/funcMatrix_ctx_schaefer_400.csv"), header = FALSE, sep = ","))
fc_sctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/funcMatrix_sctx_schaefer_400.csv"), header = FALSE, sep = ","))
sc_ctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/strucMatrix_ctx_schaefer_400.csv"), header = FALSE, sep = ","))
sc_sctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/strucMatrix_sctx_schaefer_400.csv"), header = FALSE, sep = ","))
sc_sctx <- sc_sctx[,1:100] # the sctx matrix contains also subcortico-subcortical connections
cge_ctx <- as.matrix(read.csv(here::here("data/ge/CGE_SchaeferSubcortex414Parcels_ctx.csv"), header = FALSE, sep = ","))
cge_sctx <- as.matrix(read.csv(here::here("data/ge/CGE_SchaeferSubcortex414Parcels_sctx.csv"), header = FALSE, sep = ","))

## group-level
# load atrophy map
atrophy_mapping <- read.csv(here::here("data/atrophy_cross/PrograMS_atrophy_baseline_SchaeferSubcortex414Parcels_group_cohend.csv"), header = TRUE, sep = ",")
atrophy_ctx <- atrophy_mapping[,1:400]
atrophy_sctx <- atrophy_mapping[,401:414]
# compute neighbourhood atrophy
neighbourhood_atrophy_sc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_sc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(sc_ctx[i,]!=0)
  weight_vec <- sc_ctx[i,c(neighbours)]
  neighbourhood_atrophy_sc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

neighbourhood_atrophy_sc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_sc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(sc_sctx[i,]!=0)
  weight_vec <- sc_sctx[i,c(neighbours)]
  neighbourhood_atrophy_sc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

neighbourhood_atrophy_fc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_fc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(fc_ctx[i,]!=0)
  weight_vec <- fc_ctx[i,c(neighbours)]
  neighbourhood_atrophy_fc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

neighbourhood_atrophy_fc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_fc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(fc_sctx[i,]!=0)
  weight_vec <- fc_sctx[i,c(neighbours)]
  neighbourhood_atrophy_fc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

neighbourhood_atrophy_cge_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_cge_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(cge_ctx[i,]!=0 & !is.na(cge_ctx[i,]))
  weight_vec <- cge_ctx[i,c(neighbours)]
  neighbourhood_atrophy_cge_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

neighbourhood_atrophy_cge_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_cge_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(cge_sctx[i,]!=0 & !is.na(cge_sctx[i,]))
  weight_vec <- cge_sctx[i,c(neighbours)]
  neighbourhood_atrophy_cge_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

# write out
write.csv(neighbourhood_atrophy_sc_ctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_sc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_sc_sctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_sc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_ctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_fc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_sctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_fc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_ctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_cge_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_sctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_cge_sctx.csv"), row.names = FALSE)

## group-level long
# load atrophy map
atrophy_mapping <- read.csv(here::here("data/atrophy_cross/PrograMS_atrophy_baseline_SchaeferSubcortex414Parcels_group_long_cohend.csv"), header = TRUE, sep = ",")
atrophy_ctx <- atrophy_mapping[,1:400]
atrophy_sctx <- atrophy_mapping[,401:414]
# compute neighbourhood atrophy
neighbourhood_atrophy_sc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_sc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(sc_ctx[i,]!=0)
  weight_vec <- sc_ctx[i,c(neighbours)]
  neighbourhood_atrophy_sc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

neighbourhood_atrophy_sc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_sc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(sc_sctx[i,]!=0)
  weight_vec <- sc_sctx[i,c(neighbours)]
  neighbourhood_atrophy_sc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

neighbourhood_atrophy_fc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_fc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(fc_ctx[i,]!=0)
  weight_vec <- fc_ctx[i,c(neighbours)]
  neighbourhood_atrophy_fc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

neighbourhood_atrophy_fc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_fc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(fc_sctx[i,]!=0)
  weight_vec <- fc_sctx[i,c(neighbours)]
  neighbourhood_atrophy_fc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

neighbourhood_atrophy_cge_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_cge_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(cge_ctx[i,]!=0 & !is.na(cge_ctx[i,]))
  weight_vec <- cge_ctx[i,c(neighbours)]
  neighbourhood_atrophy_cge_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

neighbourhood_atrophy_cge_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_cge_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(cge_sctx[i,]!=0 & !is.na(cge_sctx[i,]))
  weight_vec <- cge_sctx[i,c(neighbours)]
  neighbourhood_atrophy_cge_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(neighbours))
}

# write out
write.csv(neighbourhood_atrophy_sc_ctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_long_sc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_sc_sctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_long_sc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_ctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_long_fc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_sctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_long_fc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_ctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_long_cge_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_sctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_group_long_cge_sctx.csv"), row.names = FALSE)

## individual-level
# load atrophy map individuals
atrophy_mapping <- read.csv(here::here("data/atrophy_cross/PrograMS_atrophy_baseline_SchaeferSubcortex414Parcels_individuals_wscore.csv"), header = TRUE, sep = ",")
atrophy_ctx <- atrophy_mapping[,2:401]
atrophy_sctx <- atrophy_mapping[,402:415]
# compute neighbourhood atrophy
neighbourhood_atrophy_sc_ctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_ctx))))
colnames(neighbourhood_atrophy_sc_ctx) <- append("id", paste0(colnames(atrophy_ctx), "_neighbours"))
neighbourhood_atrophy_sc_ctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_ctx)){
    neighbours <- which(sc_ctx[i,]!=0)
    weight_vec <- sc_ctx[i,c(neighbours)]
    neighbourhood_atrophy_sc_ctx[neighbourhood_atrophy_sc_ctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
}

neighbourhood_atrophy_sc_sctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_sctx))))
colnames(neighbourhood_atrophy_sc_sctx) <- append("id", paste0(colnames(atrophy_sctx), "_neighbours"))
neighbourhood_atrophy_sc_sctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_sctx)){
    neighbours <- which(sc_sctx[i,]!=0)
    weight_vec <- sc_sctx[i,c(neighbours)]
    neighbourhood_atrophy_sc_sctx[neighbourhood_atrophy_sc_sctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
}

neighbourhood_atrophy_fc_ctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_ctx))))
colnames(neighbourhood_atrophy_fc_ctx) <- append("id", paste0(colnames(atrophy_ctx), "_neighbours"))
neighbourhood_atrophy_fc_ctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_ctx)){
    neighbours <- which(fc_ctx[i,]!=0)
    weight_vec <- fc_ctx[i,c(neighbours)]
    neighbourhood_atrophy_fc_ctx[neighbourhood_atrophy_fc_ctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
}

neighbourhood_atrophy_fc_sctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_sctx))))
colnames(neighbourhood_atrophy_fc_sctx) <- append("id", paste0(colnames(atrophy_sctx), "_neighbours"))
neighbourhood_atrophy_fc_sctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_sctx)){
    neighbours <- which(fc_sctx[i,]!=0)
    weight_vec <- fc_sctx[i,c(neighbours)]
    neighbourhood_atrophy_fc_sctx[neighbourhood_atrophy_fc_sctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
}

neighbourhood_atrophy_cge_ctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_ctx))))
colnames(neighbourhood_atrophy_cge_ctx) <- append("id", paste0(colnames(atrophy_ctx), "_neighbours"))
neighbourhood_atrophy_cge_ctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_ctx)){
    neighbours <- which(cge_ctx[i,]!=0 & !is.na(cge_ctx[i,]))
    weight_vec <- cge_ctx[i,c(neighbours)]
    neighbourhood_atrophy_cge_ctx[neighbourhood_atrophy_cge_ctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
}

neighbourhood_atrophy_cge_sctx <- data.frame(matrix(nrow = length(atrophy_mapping$id), ncol = (1+length(atrophy_sctx))))
colnames(neighbourhood_atrophy_cge_sctx) <- append("id", paste0(colnames(atrophy_sctx), "_neighbours"))
neighbourhood_atrophy_cge_sctx$id <- atrophy_mapping$id
for (l in atrophy_mapping$id){
  for (i in 1:length(atrophy_sctx)){
    neighbours <- which(cge_sctx[i,]!=0 & ! is.na(cge_sctx[i,]))
    weight_vec <- cge_sctx[i,c(neighbours)]
    neighbourhood_atrophy_cge_sctx[neighbourhood_atrophy_cge_sctx$id==l,i+1] <- sum(atrophy_ctx[atrophy_mapping$id==l,neighbours]*weight_vec)*(1/length(neighbours))
  }
}

# write out
write.csv(neighbourhood_atrophy_sc_ctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_individuals_sc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_sc_sctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_individuals_sc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_ctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_individuals_fc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_sctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_individuals_fc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_ctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_individuals_cge_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_sctx, here::here("data/neighbourhood_atrophy/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_individuals_cge_sctx.csv"), row.names = FALSE)
```

# OLD CODE
```{r import/transform/merge clinical and structural MRI data - Freesurfer cross-sectional}
### PrograMS clinical database
PrograMS <- read.csv(here::here("data/PrograMS_v1.9.csv"), header = TRUE, sep = ",")
PrograMS[c('ClinicalPhenotype','DMT','Clinical','BRBn','NPSother')] <- lapply(PrograMS[c('ClinicalPhenotype','DMT','Clinical','BRBn','NPSother')], factor)
PrograMS$Sex <- factor(PrograMS$Sex, levels = c("female", "male"))
PrograMS$Group <- factor(PrograMS$Group, levels = c("HC", "MS"))
PrograMS[c('DoB','DateMRI','DateOfOnset')] <- lapply(PrograMS[c('DoB','DateMRI','DateOfOnset')], as.Date, format = "%d/%m/%Y")
# standardize BRB scores
BRB_tests <- colnames(PrograMS)[grep('BRB_', colnames(PrograMS))] 
for (i in BRB_tests){
  MDL <- lm(get(i) ~ Age + Sex + Education_years, 
            data = PrograMS[PrograMS$Group=="HC" & PrograMS$Session=="ses-Y00",], 
            na.action = na.exclude)
  PrograMS[,paste0(i,'_wscore')] <- (PrograMS[,i] - predict(MDL, PrograMS)) / sd(MDL$residuals)
}
PrograMS$BRB_STROOP_wscore <- -1 * PrograMS$BRB_STROOP_wscore # flip sign for stroop
PrograMS$MissingBRBtests <- rowSums(is.na(PrograMS[,BRB_tests])) 

### sMRI derivatives
# import and save vertex-wise thickness
FS_subjects_dir <- "/data/anw/knw-work/g.pontillo/predictive_modelling/amsterdam/derivatives/freesurfer/cross"
vertexwise_thickness <- SURFvextract(sdirpath = FS_subjects_dir, filename = here::here("data/PrograMS_FreesurferCross_VertexwiseThickness.Rds"), measure="thickness", template = "fsaverage5")
# import aseg
aseg <- fs_stats(sdirpath = FS_subjects_dir, ROImeasure = "Volume_mm3")
aseg$FullID <- vertexwise_thickness[[1]]
# import lesions
PrograMS_sMRI <- read.csv(here::here("data/PrograMS_FreesurferLst.csv"), header = TRUE, sep = ",")
# import cortical labels
labels_schaefer100_7networks <- read.csv(here::here("data/hcp_connectivity/funcLabels_ctx_schaefer_100.csv"), header = FALSE, sep = ",")
labels_schaefer400_7networks <- read.csv(here::here("data/hcp_connectivity/funcLabels_ctx_schaefer_400.csv"), header = FALSE, sep = ",")
# merge
df_thickness <- data.frame(vertexwise_thickness)
colnames(df_thickness)[1] <- "FullID"
df_PrograMS <- merge(PrograMS, aseg, by = "FullID") %>% merge(df_thickness, by = "FullID") %>% merge(PrograMS_sMRI[,c("FullID", "N_les", "TLV")])
df_PrograMS <- clean_names(df_PrograMS)
# w score
volumes <- c(paste("left", c("accumbens_area",
                             "amygdala",
                             "caudate",
                             "hippocampus",
                             "pallidum",
                             "putamen", 
                             "thalamus"),  
                  sep = "_"), 
             paste("right", c("accumbens_area",
                              "amygdala",
                              "caudate",
                              "hippocampus",
                              "pallidum",
                              "putamen",
                              "thalamus"),
                   sep = "_"))
CT <- colnames(df_PrograMS)[grep("^x+[0-9]$|^x.*.[0-9]$", colnames(df_PrograMS))]
for (i in volumes){
  MDL <- lm(get(i) ~ age + sex + estimated_total_intra_cranial_vol, data = df_PrograMS[df_PrograMS$session=="ses-Y00" & df_PrograMS$group=="HC",], na.action = na.exclude)
  df_PrograMS[, paste0(i, "_wscore")] <- (df_PrograMS[, i] - predict(MDL, df_PrograMS)) / sd(MDL$residuals)
}
for (i in CT){
  MDL <- lm(get(i) ~ age + sex, data = df_PrograMS[df_PrograMS$session=="ses-Y00" & df_PrograMS$group=="HC",], na.action = na.exclude)
  df_PrograMS[, paste0(i, "_wscore")] <- (df_PrograMS[, i] - predict(MDL, df_PrograMS)) / sd(MDL$residuals)
}
# surf to atlas
wscore_schaefer100 <- surf_to_atlas(df_PrograMS[, grep("^x+[0-9]_wscore$|^x.*.[0-9]_wscore$", colnames(df_PrograMS))], 4, mode = "mean")
colnames(wscore_schaefer100) <- paste0("schaefer100_", labels_schaefer100_7networks, "_wscore")
wscore_schaefer400 <- surf_to_atlas(df_PrograMS[, grep("^x+[0-9]_wscore$|^x.*.[0-9]_wscore$", colnames(df_PrograMS))], 6, mode = "mean")
colnames(wscore_schaefer400) <- paste0("schaefer400_", labels_schaefer400_7networks, "_wscore")
df_PrograMS <- cbind(df_PrograMS, wscore_schaefer100, wscore_schaefer400)

### write out
saveRDS(df_PrograMS, file = here::here("data/df_PrograMS.Rds"))
```

```{r cross-sectional atrophy maps}
df_PrograMS <- readRDS(here::here("data/df_PrograMS.Rds"))
## SchaeferSubcortex 114 parcels
sctx <- c(paste("left", c("accumbens_area",
                             "amygdala",
                             "caudate",
                             "hippocampus",
                             "pallidum",
                             "putamen", 
                             "thalamus"),  
                  sep = "_"), 
             paste("right", c("accumbens_area",
                              "amygdala",
                              "caudate",
                              "hippocampus",
                              "pallidum",
                              "putamen",
                              "thalamus"),
                   sep = "_"))
ctx <- colnames(df_PrograMS)[grep("^schaefer100.*.wscore$", colnames(df_PrograMS))]
list <- append(ctx, paste0(sctx, "_wscore"))
atrophy_mapping_individuals_wscore <- df_PrograMS[df_PrograMS$session=="ses-Y00" & df_PrograMS$group=="MS", c("id",list)]
column_index <- 2:(length(list)+1)
atrophy_mapping_individuals_wscore[column_index] <- -1*atrophy_mapping_individuals_wscore[column_index] # flip so that more positive values correspond to greater atrophy
atrophy_mapping_group_cohend <- data.frame(matrix(nrow = 1, ncol = length(list)))
colnames(atrophy_mapping_group_cohend) <- gsub(pattern = "_wscore", replacement = "_cohend", list)
for (i in 1:length(list)) {
  d <- df_PrograMS[df_PrograMS$session=="ses-Y00", list[i]]
  f <- df_PrograMS[df_PrograMS$session=="ses-Y00", "group"]
  cohend <- effsize::cohen.d(d, f)
  atrophy_mapping_group_cohend[,i] <- cohend$estimate
}

# write out
write.csv(atrophy_mapping_individuals_wscore, here::here("data/atrophy_cross/PrograMS_atrophy_cross_SchaeferSubcortex114Parcels_individuals_wscore.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_cohend, here::here("data/atrophy_cross/PrograMS_atrophy_cross_SchaeferSubcortex114Parcels_group_cohend.csv"), row.names = FALSE)

## SchaferSubcortex 414 parcels
sctx <- c(paste("left", c("accumbens_area",
                             "amygdala",
                             "caudate",
                             "hippocampus",
                             "pallidum",
                             "putamen", 
                             "thalamus"),  
                  sep = "_"), 
             paste("right", c("accumbens_area",
                              "amygdala",
                              "caudate",
                              "hippocampus",
                              "pallidum",
                              "putamen",
                              "thalamus"),
                   sep = "_"))
ctx <- colnames(df_PrograMS)[grep("^schaefer400.*.wscore$", colnames(df_PrograMS))]
list <- append(ctx, paste0(sctx, "_wscore"))
atrophy_mapping_individuals_wscore <- df_PrograMS[df_PrograMS$session=="ses-Y00" & df_PrograMS$group=="MS", c("id",list)]
column_index <- 2:(length(list)+1)
atrophy_mapping_individuals_wscore[column_index] <- -1*atrophy_mapping_individuals_wscore[column_index] # flip so that more positive values correspond to greater atrophy
atrophy_mapping_group_cohend <- data.frame(matrix(nrow = 1, ncol = length(list)))
colnames(atrophy_mapping_group_cohend) <- gsub(pattern = "_wscore", replacement = "_cohend", list)
for (i in 1:length(list)) {
  d <- df_PrograMS[df_PrograMS$session=="ses-Y00", list[i]]
  f <- df_PrograMS[df_PrograMS$session=="ses-Y00", "group"]
  cohend <- effsize::cohen.d(d, f)
  atrophy_mapping_group_cohend[,i] <- cohend$estimate
}

# write out
write.csv(atrophy_mapping_individuals_wscore, here::here("data/atrophy_cross/PrograMS_atrophy_cross_SchaeferSubcortex414Parcels_individuals_wscore.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group_cohend, here::here("data/atrophy_cross/PrograMS_atrophy_cross_SchaeferSubcortex414Parcels_group_cohend.csv"), row.names = FALSE)
```




```{r functional connectomes}
dir_fmri <- "/data/anw/knw-work/g.pontillo/predictive_modelling/amsterdam/derivatives/xcpd_scrubbing"
list_subs <- grep("sub-*",list.dirs(path = dir_fmri, recursive = FALSE, full.names = FALSE), value = TRUE) # list of subjects  
## SchaeferSubcortex 114 parcels 
list_pearson <- Sys.glob(file.path(dir_fmri,"sub-*","ses-Y00","func","*SchaeferSubcortex114Parcels_stat-pearsoncorrelation_relmat.tsv")) # list of connectivity matrices 
atlas <- read.csv("/data/anw/knw-work/g.pontillo/predictive_modelling/code/MRI_processing/atlases/CortexSubcortex/atlas-SchaeferSubcortex114Parcels_dseg.tsv", header = TRUE, sep = "\t") # atlas 
labels <- as.character(atlas[,"label"]) # atlas labels
roi <- length(labels)
df_fMRI <- data.frame(matrix(nrow = length(list_subs), ncol = ((roi*(roi-1))/2)+1))
colnames(df_fMRI)[1] <- "ID"
for (i in 1:length(list_subs)) {
  pearson <- grep(list_subs[i], list_pearson, value = TRUE)
  fc <- as.matrix(read.csv(pearson, header = TRUE, row.names = 1, sep = "\t"))
  mode(fc) <- "numeric"
  fc_z <- atan(fc)
  fc_flat <- fc_z[upper.tri(fc_z, diag = FALSE)] # this equals to using numpy.tril as R is column-major 
  df_fMRI[i,1] <- list_subs[i] 
  df_fMRI[i,2:ncol(df_fMRI)] <- fc_flat
} 
index <- which(upper.tri(fc, diag = FALSE), arr.ind=TRUE)
for (i in 1:dim(index)[1]){
  colnames(df_fMRI)[1+i] <- paste0(labels[index[i,1]], 
                                   "_to_",
                                   labels[index[i,2]]) 
}

# average functional connectome
average_fc_HC <- colMeans(df_fMRI[startsWith(df_fMRI$ID, "sub-HC"),-1], na.rm = TRUE)
average_fc_HC <- abs(average_fc_HC)
mat_HC <- matrix(nrow = roi, ncol = roi)
mat_HC[upper.tri(mat_HC)] <- as.matrix(average_fc_HC)
mat_HC <- as.matrix(Matrix::forceSymmetric(mat_HC, uplo = "U"))
diag(mat_HC) <- 0
mat_HC_ctx <- mat_HC[1:100, 1:100]
mat_HC_sctx <- mat_HC[101:114,1:100]
average_fc_MS <- colMeans(df_fMRI[startsWith(df_fMRI$ID, "sub-PA"),-1], na.rm = TRUE)
average_fc_MS <- abs(average_fc_MS)
mat_MS <- matrix(nrow = roi, ncol = roi)
mat_MS[upper.tri(mat_MS)] <- as.matrix(average_fc_MS)
mat_MS <- as.matrix(Matrix::forceSymmetric(mat_MS, uplo = "U"))
diag(mat_MS) <- 0
mat_MS_ctx <- mat_MS[1:100, 1:100]
mat_MS_sctx <- mat_MS[101:114,1:100]

# write average matrices
write.table(mat_HC, here::here("data/fc/PrograMS_fc_SchaeferSubcortex114Parcels_HC.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_HC_ctx, here::here("data/fc/PrograMS_fc_SchaeferSubcortex114Parcels_HC_ctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_HC_sctx, here::here("data/fc/PrograMS_fc_SchaeferSubcortex114Parcels_HC_sctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS, here::here("data/fc/PrograMS_fc_SchaeferSubcortex114Parcels_MS.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_ctx, here::here("data/fc/PrograMS_fc_SchaeferSubcortex114Parcels_MS_ctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_sctx, here::here("data/fc/PrograMS_fc_SchaeferSubcortex114Parcels_MS_sctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(labels, here::here("data/fc/fc_SchaeferSubcortex114Parcels_labels.csv"), sep = ',', row.names = FALSE, col.names = FALSE)

# write individual matrices 
df_fMRI[is.na(df_fMRI)] <- 0 # put NA to 0
write.csv(df_fMRI[startsWith(df_fMRI$ID, "sub-PA"),], here::here("data/fc/PrograMS_fc_SchaeferSubcortex114Parcels_individuals.csv"), row.names = FALSE)

## SchaeferSubcortex 414 parcels 
list_pearson <- Sys.glob(file.path(dir_fmri,"sub-*","ses-Y00","func","*SchaeferSubcortex414Parcels_stat-pearsoncorrelation_relmat.tsv")) # list of connectivity matrices 
atlas <- read.csv("/data/anw/knw-work/g.pontillo/predictive_modelling/code/MRI_processing/atlases/CortexSubcortex/atlas-SchaeferSubcortex414Parcels_dseg.tsv", header = TRUE, sep = "\t") # atlas 
labels <- as.character(atlas[,"label"]) # atlas labels
roi <- length(labels)
df_fMRI <- data.frame(matrix(nrow = length(list_subs), ncol = ((roi*(roi-1))/2)+1))
colnames(df_fMRI)[1] <- "ID"
for (i in 1:length(list_subs)) {
  pearson <- grep(list_subs[i], list_pearson, value = TRUE)
  fc <- as.matrix(read.csv(pearson, header = TRUE, row.names = 1, sep = "\t"))
  mode(fc) <- "numeric"
  fc_z <- atan(fc)
  fc_flat <- fc_z[upper.tri(fc_z, diag = FALSE)] # this equals to using numpy.tril as R is column-major 
  df_fMRI[i,1] <- list_subs[i] 
  df_fMRI[i,2:ncol(df_fMRI)] <- fc_flat
} 
index <- which(upper.tri(fc, diag = FALSE), arr.ind=TRUE)
for (i in 1:dim(index)[1]){
  colnames(df_fMRI)[1+i] <- paste0(labels[index[i,1]], 
                                   "_to_",
                                   labels[index[i,2]]) 
}

# average functional connectome
average_fc_HC <- colMeans(df_fMRI[startsWith(df_fMRI$ID, "sub-HC"),-1], na.rm = TRUE)
average_fc_HC <- abs(average_fc_HC)
mat_HC <- matrix(nrow = roi, ncol = roi)
mat_HC[upper.tri(mat_HC)] <- as.matrix(average_fc_HC)
mat_HC <- as.matrix(Matrix::forceSymmetric(mat_HC, uplo = "U"))
diag(mat_HC) <- 0
mat_HC_ctx <- mat_HC[1:400, 1:400]
mat_HC_sctx <- mat_HC[401:414,1:400]
average_fc_MS <- colMeans(df_fMRI[startsWith(df_fMRI$ID, "sub-PA"),-1], na.rm = TRUE)
average_fc_MS <- abs(average_fc_MS)
mat_MS <- matrix(nrow = roi, ncol = roi)
mat_MS[upper.tri(mat_MS)] <- as.matrix(average_fc_MS)
mat_MS <- as.matrix(Matrix::forceSymmetric(mat_MS, uplo = "U"))
diag(mat_MS) <- 0
mat_MS_ctx <- mat_MS[1:400, 1:400]
mat_MS_sctx <- mat_MS[401:414,1:400]

# write average matrices
write.table(mat_HC, here::here("data/fc/PrograMS_fc_SchaeferSubcortex414Parcels_HC.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_HC_ctx, here::here("data/fc/PrograMS_fc_SchaeferSubcortex414Parcels_HC_ctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_HC_sctx, here::here("data/fc/PrograMS_fc_SchaeferSubcortex414Parcels_HC_sctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS, here::here("data/fc/PrograMS_fc_SchaeferSubcortex414Parcels_MS.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_ctx, here::here("data/fc/PrograMS_fc_SchaeferSubcortex414Parcels_MS_ctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(mat_MS_sctx, here::here("data/fc/PrograMS_fc_SchaeferSubcortex414Parcels_MS_sctx.csv"), sep = ',', row.names = FALSE, col.names = FALSE)
write.table(labels, here::here("data/fc/fc_SchaeferSubcortex414Parcels_labels.csv"), sep = ',', row.names = FALSE, col.names = FALSE)

# write individual matrices 
df_fMRI[is.na(df_fMRI)] <- 0 # put NA to 0
write.csv(df_fMRI[startsWith(df_fMRI$ID, "sub-PA"),], here::here("data/fc/PrograMS_fc_SchaeferSubcortex414Parcels_individuals.csv"), row.names = FALSE)
```

```{r structural connectomes}

```




```{r compute cross-sectional neighbour atrophy weighted by SC/FC/CGE}
## SchaeferSubcortex 114 parcels
# load atrophy map
atrophy_mapping <- read.csv(here::here("data/atrophy_cross/PrograMS_atrophy_cross_SchaeferSubcortex114Parcels_group_cohend.csv"), header = TRUE, sep = ",")
atrophy_ctx <- atrophy_mapping[,1:100]
atrophy_sctx <- atrophy_mapping[,101:114]
# load normative functional/structural connectivity matrices
labels <- read.csv(here::here("data/fc/fc_SchaeferSubcortex114Parcels_labels.csv"), header = TRUE, sep = ",")
fc_ctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/funcMatrix_ctx_schaefer_100.csv"), header = FALSE, sep = ","))
fc_sctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/funcMatrix_sctx_schaefer_100.csv"), header = FALSE, sep = ","))
sc_ctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/strucMatrix_ctx_schaefer_100.csv"), header = FALSE, sep = ","))
sc_sctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/strucMatrix_sctx_schaefer_100.csv"), header = FALSE, sep = ","))
sc_sctx <- sc_sctx[,1:100] # the sctx matrix contains also subcortico-subcortical connections
cge_ctx <- as.matrix(read.csv(here::here("data/ge/CGE_SchaeferSubcortex114Parcels_ctx.csv"), header = FALSE, sep = ","))
cge_sctx <- as.matrix(read.csv(here::here("data/ge/CGE_SchaeferSubcortex114Parcels_sctx.csv"), header = FALSE, sep = ","))

neighbourhood_atrophy_sc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_sc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(sc_ctx[i,]!=0)
  if(length(neighbours) == 0){
    neighbourhood_atrophy_sc_ctx[,i] <- NA
  } else {
    weight_vec <- sc_ctx[i,c(neighbours)]
    neighbourhood_atrophy_sc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(atrophy_ctx[neighbours]))
  }
}

neighbourhood_atrophy_sc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_sc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(sc_sctx[i,]!=0)
  if(length(neighbours) == 0){
    neighbourhood_atrophy_sc_sctx[,i] <- NA
  } else {
    weight_vec <- sc_sctx[i,c(neighbours)]
    neighbourhood_atrophy_sc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(atrophy_ctx[neighbours]))
  }
}

neighbourhood_atrophy_fc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_fc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(sc_ctx[i,]!=0)
  if(length(neighbours) == 0){
    neighbourhood_atrophy_fc_ctx[,i] <- NA
  } else {
    weight_vec <- fc_ctx[i,c(neighbours)]
    neighbourhood_atrophy_fc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(atrophy_ctx[neighbours]))
  }
}

neighbourhood_atrophy_fc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_fc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(sc_sctx[i,]!=0)
  if(length(neighbours) == 0){
    neighbourhood_atrophy_fc_sctx[,i] <- NA
  } else {
    weight_vec <- fc_sctx[i,c(neighbours)]
    neighbourhood_atrophy_fc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(atrophy_ctx[neighbours]))
  }
}

neighbourhood_atrophy_fc_nosc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_fc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(fc_ctx[i,]!=0)
  if(length(neighbours) == 0){
    neighbourhood_atrophy_fc_ctx[,i] <- NA
  } else {
    weight_vec <- fc_ctx[i,c(neighbours)]
    neighbourhood_atrophy_fc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(atrophy_ctx[neighbours]))
  }
}

neighbourhood_atrophy_fc_nosc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_fc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(fc_sctx[i,]!=0)
  if(length(neighbours) == 0){
    neighbourhood_atrophy_fc_sctx[,i] <- NA
  } else {
    weight_vec <- fc_sctx[i,c(neighbours)]
    neighbourhood_atrophy_fc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(atrophy_ctx[neighbours]))
  }
}

neighbourhood_atrophy_cge_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_cge_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(cge_ctx[i,]!=0)
  if(length(neighbours) == 0){
    neighbourhood_atrophy_cge_ctx[,i] <- NA
  } else {
    weight_vec <- cge_ctx[i,c(neighbours)]
    neighbourhood_atrophy_cge_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(atrophy_ctx[neighbours]))
  }
}

neighbourhood_atrophy_cge_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_fc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(cge_sctx[i,]!=0)
  if(length(neighbours) == 0){
    neighbourhood_atrophy_fc_sctx[,i] <- NA
  } else {
    weight_vec <- fc_sctx[i,c(neighbours)]
    neighbourhood_atrophy_fc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(atrophy_ctx[neighbours]))
  }
}

# write out
write.csv(neighbourhood_atrophy_sc_ctx, here::here("data/atrophy_cross/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_sc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_sc_sctx, here::here("data/atrophy_cross/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_sc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_ctx, here::here("data/atrophy_cross/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_fc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_sctx, here::here("data/atrophy_cross/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_fc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_nosc_ctx, here::here("data/atrophy_cross/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_fc_nosc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_nosc_sctx, here::here("data/atrophy_cross/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_fc_nosc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_ctx, here::here("data/atrophy_cross/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_cge_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_sctx, here::here("data/atrophy_cross/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex114Parcels_cge_sctx.csv"), row.names = FALSE)

## SchaeferSubcortex 414 parcels
# load atrophy map
atrophy_mapping <- read.csv(here::here("data/atrophy_cross/PrograMS_atrophy_cross_SchaeferSubcortex414Parcels_group_cohend.csv"), header = TRUE, sep = ",")
atrophy_ctx <- atrophy_mapping[,1:400]
atrophy_sctx <- atrophy_mapping[,401:414]
# load normative functional/structural connectivity matrices
labels <- read.csv(here::here("data/fc/fc_SchaeferSubcortex414Parcels_labels.csv"), header = TRUE, sep = ",")
fc_ctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/funcMatrix_ctx_schaefer_400.csv"), header = FALSE, sep = ","))
fc_sctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/funcMatrix_sctx_schaefer_400.csv"), header = FALSE, sep = ","))
sc_ctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/strucMatrix_ctx_schaefer_400.csv"), header = FALSE, sep = ","))
sc_sctx <- as.matrix(read.csv(here::here("data/hcp_connectivity/strucMatrix_sctx_schaefer_400.csv"), header = FALSE, sep = ","))
sc_sctx <- sc_sctx[,1:400] # the sctx matrix contains also subcortico-subcortical connections
cge_ctx <- as.matrix(read.csv(here::here("data/ge/CGE_SchaeferSubcortex414Parcels_ctx.csv"), header = FALSE, sep = ","))
cge_sctx <- as.matrix(read.csv(here::here("data/ge/CGE_SchaeferSubcortex414Parcels_sctx.csv"), header = FALSE, sep = ","))

neighbourhood_atrophy_sc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_sc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(sc_ctx[i,]!=0)
  if(length(neighbours) == 0){
    neighbourhood_atrophy_sc_ctx[,i] <- NA
  } else {
    weight_vec <- sc_ctx[i,c(neighbours)]
    neighbourhood_atrophy_sc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(atrophy_ctx[neighbours]))
  }
}

neighbourhood_atrophy_sc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_sc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(sc_sctx[i,]!=0)
  if(length(neighbours) == 0){
    neighbourhood_atrophy_sc_sctx[,i] <- NA
  } else {
    weight_vec <- sc_sctx[i,c(neighbours)]
    neighbourhood_atrophy_sc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(atrophy_ctx[neighbours]))
  }
}

neighbourhood_atrophy_fc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_fc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(sc_ctx[i,]!=0)
  if(length(neighbours) == 0){
    neighbourhood_atrophy_fc_ctx[,i] <- NA
  } else {
    weight_vec <- fc_ctx[i,c(neighbours)]
    neighbourhood_atrophy_fc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(atrophy_ctx[neighbours]))
  }
}

neighbourhood_atrophy_fc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_fc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(sc_sctx[i,]!=0)
  if(length(neighbours) == 0){
    neighbourhood_atrophy_fc_sctx[,i] <- NA
  } else {
    weight_vec <- fc_sctx[i,c(neighbours)]
    neighbourhood_atrophy_fc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(atrophy_ctx[neighbours]))
  }
}

neighbourhood_atrophy_fc_nosc_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_fc_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(fc_ctx[i,]!=0)
  if(length(neighbours) == 0){
    neighbourhood_atrophy_fc_ctx[,i] <- NA
  } else {
    weight_vec <- fc_ctx[i,c(neighbours)]
    neighbourhood_atrophy_fc_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(atrophy_ctx[neighbours]))
  }
}

neighbourhood_atrophy_fc_nosc_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_fc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(fc_sctx[i,]!=0)
  if(length(neighbours) == 0){
    neighbourhood_atrophy_fc_sctx[,i] <- NA
  } else {
    weight_vec <- fc_sctx[i,c(neighbours)]
    neighbourhood_atrophy_fc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(atrophy_ctx[neighbours]))
  }
}

neighbourhood_atrophy_cge_ctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_ctx)))
colnames(neighbourhood_atrophy_cge_ctx) <- paste0(colnames(atrophy_ctx), "_neighbours")
for (i in 1:length(atrophy_ctx)){
  neighbours <- which(cge_ctx[i,]!=0)
  if(length(neighbours) == 0){
    neighbourhood_atrophy_cge_ctx[,i] <- NA
  } else {
    weight_vec <- cge_ctx[i,c(neighbours)]
    neighbourhood_atrophy_cge_ctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(atrophy_ctx[neighbours]))
  }
}

neighbourhood_atrophy_cge_sctx <- data.frame(matrix(nrow = 1, ncol = length(atrophy_sctx)))
colnames(neighbourhood_atrophy_fc_sctx) <- paste0(colnames(atrophy_sctx), "_neighbours")
for (i in 1:length(atrophy_sctx)){
  neighbours <- which(cge_sctx[i,]!=0)
  if(length(neighbours) == 0){
    neighbourhood_atrophy_fc_sctx[,i] <- NA
  } else {
    weight_vec <- fc_sctx[i,c(neighbours)]
    neighbourhood_atrophy_fc_sctx[,i] <- sum(atrophy_ctx[neighbours]*weight_vec)*(1/length(atrophy_ctx[neighbours]))
  }
}

# write out
write.csv(neighbourhood_atrophy_sc_ctx, here::here("data/atrophy_cross/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_sc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_sc_sctx, here::here("data/atrophy_cross/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_sc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_ctx, here::here("data/atrophy_cross/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_fc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_sctx, here::here("data/atrophy_cross/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_fc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_nosc_ctx, here::here("data/atrophy_cross/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_fc_nosc_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_fc_nosc_sctx, here::here("data/atrophy_cross/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_fc_nosc_sctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_ctx, here::here("data/atrophy_cross/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_cge_ctx.csv"), row.names = FALSE)
write.csv(neighbourhood_atrophy_cge_sctx, here::here("data/atrophy_cross/PrograMS_neighbourhood_atrophy_cross_SchaeferSubcortex414Parcels_cge_sctx.csv"), row.names = FALSE)
```

```{r import/transform/merge clinical and structural MRI data}
### PrograMS clinical database
PrograMS <- read.csv(here::here("data/PrograMS_v1.9.csv"), header = TRUE, sep = ",")
PrograMS[c('Group','ClinicalPhenotype','DMT','Clinical','BRBn','NPSother')] <- lapply(PrograMS[c('Group','ClinicalPhenotype','DMT','Clinical','BRBn','NPSother')], factor)
PrograMS$Sex <- factor(PrograMS$Sex, levels = c("female", "male"))
PrograMS[c('DoB','DateMRI','DateOfOnset')] <- lapply(PrograMS[c('DoB','DateMRI','DateOfOnset')], as.Date, format = "%d/%m/%Y")
# standardize BRB scores
BRB_tests <- colnames(PrograMS)[grep('BRB_', colnames(PrograMS))] 
for (i in BRB_tests){
  MDL <- lm(get(i) ~ Age + Sex + Education_years, 
            data = PrograMS[PrograMS$Group=="HC" & PrograMS$Session=="ses-Y00",], 
            na.action = na.exclude)
  PrograMS[,paste0(i,'_wscore')] <- (PrograMS[,i] - predict(MDL, PrograMS)) / sd(MDL$residuals)
}
PrograMS$BRB_STROOP_wscore <- -1 * PrograMS$BRB_STROOP_wscore # flip sign for stroop
PrograMS$MissingBRBtests <- rowSums(is.na(PrograMS[,BRB_tests])) 

### sMRI derivatives
# import Freesurfer and LST outputs 
PrograMS_sMRI <- read.csv(here::here("data/PrograMS_FreesurferLst.csv"), header = TRUE, sep = ",")
df_PrograMS <- merge(PrograMS, PrograMS_sMRI, by = c("ID", "Session", "FullID"))
df_PrograMS <- clean_names(df_PrograMS)
## model atrophy
# w-score CT/volumes
volumes <- c(paste("left", c("accumbens_area",
                             "amygdala",
                             "caudate",
                             "hippocampus",
                             "pallidum",
                             "putamen", 
                             "thalamus"),  
                  sep = "_"), 
             paste("right", c("accumbens_area",
                              "amygdala",
                              "caudate",
                              "hippocampus",
                              "pallidum",
                              "putamen",
                              "thalamus"),
                   sep = "_"))
CT <- colnames(df_PrograMS)[grep("_thickness",colnames(df_PrograMS))]
# #################### longitudinal modelling ##############################
Normative_HC <- df_PrograMS[df_PrograMS$group=="HC" & (df_PrograMS$session=="ses-Y00" | df_PrograMS$session=="ses-Y05"),]
Normative_HC <- Normative_HC[Normative_HC$id %in% Normative_HC$id[duplicated(Normative_HC$id)],] # identify healthy controls with scans at both Y00 and Y05
for (i in volumes){
  MDL_pre <- lm(get(i) ~ poly(age, 2) + sex + estimated_total_intra_cranial_vol, data = Normative_HC[Normative_HC$session=="ses-Y00",], na.action = na.exclude)
  df_PrograMS[df_PrograMS$session=="ses-Y00", paste0(i, "_wscore")] <- (df_PrograMS[df_PrograMS$session=="ses-Y00", i] - predict(MDL_pre, df_PrograMS[df_PrograMS$session=="ses-Y00",])) / sd(MDL_pre$residuals) # model pre-upgrade
  MDL_post <- lm(get(i) ~ poly(age, 2) + sex + estimated_total_intra_cranial_vol, data = Normative_HC[Normative_HC$session=="ses-Y05",], na.action = na.exclude)
  df_PrograMS[df_PrograMS$session=="ses-Y05" | df_PrograMS$session=="ses-Y10", paste0(i, "_wscore")] <- (df_PrograMS[df_PrograMS$session=="ses-Y05" | df_PrograMS$session=="ses-Y10", i] - predict(MDL_post, df_PrograMS[df_PrograMS$session=="ses-Y05" | df_PrograMS$session=="ses-Y10",])) / sd(MDL_post$residuals) # model post-upgrade
}
for (i in CT){
  MDL_pre <- lm(get(i) ~ poly(age, 2) + sex, data = Normative_HC[Normative_HC$session=="ses-Y00",], na.action = na.exclude)
  df_PrograMS[df_PrograMS$session=="ses-Y00", paste0(i, "_wscore")] <- (df_PrograMS[df_PrograMS$session=="ses-Y00", i] - predict(MDL_pre, df_PrograMS[df_PrograMS$session=="ses-Y00",])) / sd(MDL_pre$residuals) # model pre-upgrade
  MDL_post <- lm(get(i) ~ poly(age, 2) + sex, data = Normative_HC[Normative_HC$session=="ses-Y05",], na.action = na.exclude)
  df_PrograMS[df_PrograMS$session=="ses-Y05" | df_PrograMS$session=="ses-Y10", paste0(i, "_wscore")] <- (df_PrograMS[df_PrograMS$session=="ses-Y05" | df_PrograMS$session=="ses-Y10", i] - predict(MDL_post, df_PrograMS[df_PrograMS$session=="ses-Y05" | df_PrograMS$session=="ses-Y10",])) / sd(MDL_post$residuals) # model post-upgrade
}
# growth models
df_PrograMS <- df_PrograMS %>%
  dplyr::group_by(id) %>%
  dplyr::mutate(n_scans=n()) # add number of scans
atrophy_mapping_individuals <- data.frame(matrix(nrow = length(unique(df_PrograMS$id[df_PrograMS$group=="MS" & df_PrograMS$n_scans!=1 & (df_PrograMS$session=="ses-Y00" | df_PrograMS$session=="ses-Y05")])), ncol = length(append(volumes,CT))+1))
colnames(atrophy_mapping_individuals) = c("id", append(volumes,CT)) # individual slopes of atrophy over time
atrophy_mapping_group <- data.frame(matrix(nrow = 1, ncol = length(append(volumes,CT))))
colnames(atrophy_mapping_group) = c(append(volumes,CT)) # test statistic of the effect of time on volumes/CT
for (i in append(volumes, CT)){
  MDL <- lme(as.formula(paste0(i, "_wscore ~ fu_time")),
             data = df_PrograMS[df_PrograMS$group=="MS" & df_PrograMS$n_scans!=1 & (df_PrograMS$session=="ses-Y00" | df_PrograMS$session=="ses-Y05"),],
             random = ~fu_time|id, method="ML", na.action = na.exclude,
             correlation = corAR1(0, form = ~fu_time|id),
             control = list(msMaxIter = 1000, msMaxEval = 1000, sing.tol = 1e-20))
  atrophy_mapping_individuals$id <- row.names(coef(MDL))
  atrophy_mapping_individuals[,i] <- coef(MDL)$fu_time
  atrophy_mapping_group[,i] <- coef(summary(MDL))["fu_time", "t-value"]
}
# excess atrophy
atrophy_mapping_individuals <- data.frame(matrix(nrow = length(unique(df_PrograMS$id[df_PrograMS$n_scans!=1 & (df_PrograMS$session=="ses-Y00" | df_PrograMS$session=="ses-Y05")])), ncol = length(append(volumes,CT))+1))
colnames(atrophy_mapping_individuals) = c("id", append(volumes,CT)) # individual slopes of atrophy over time
atrophy_mapping_group <- data.frame(matrix(nrow = 1, ncol = length(append(volumes,CT))))
colnames(atrophy_mapping_group) = c(append(volumes,CT)) # test statistic of the effect of time on volumes/CT
for (i in append(volumes, CT)){
  MDL <- lme(as.formula(paste0(i, " ~ fu_time + group*fu_time + poly(age, 2)*fu_time + sex*fu_time")),
             data = df_PrograMS[df_PrograMS$n_scans!=1 & (df_PrograMS$session=="ses-Y00" | df_PrograMS$session=="ses-Y05"),],
             random = ~fu_time|id, method="ML", na.action = na.exclude,
             correlation = corAR1(0, form = ~fu_time|id),
             control = list(msMaxIter = 1000, msMaxEval = 1000, sing.tol = 1e-20))
  atrophy_mapping_individuals$id <- row.names(coef(MDL))
  atrophy_mapping_individuals[,i] <- coef(MDL)$fu_time
  atrophy_mapping_group[,i] <- coef(summary(MDL))["fu_time:groupMS", "t-value"]
}
write.csv(atrophy_mapping_individuals, here::here("data/PrograMS_atrophy_long_individual_slopes.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group, here::here("data/PrograMS_atrophy_long_group_t-values.csv"), row.names = FALSE)
# ######################### longitudinal modelling ####################
for (i in volumes){
  MDL <- lm(get(i) ~ age + sex + estimated_total_intra_cranial_vol, data = df_PrograMS[df_PrograMS$session=="ses-Y00" & df_PrograMS$group=="HC",], na.action = na.exclude)
  df_PrograMS[, paste0(i, "_wscore")] <- (df_PrograMS[, i] - predict(MDL, df_PrograMS)) / sd(MDL$residuals)
}
for (i in CT){
  MDL <- lm(get(i) ~ age + sex, data = df_PrograMS[df_PrograMS$session=="ses-Y00" & df_PrograMS$group=="HC",], na.action = na.exclude)
  df_PrograMS[, paste0(i, "_wscore")] <- (df_PrograMS[, i] - predict(MDL, df_PrograMS)) / sd(MDL$residuals)
}
atrophy_mapping_individuals <- df_PrograMS[df_PrograMS$group=="MS" & df_PrograMS$session=="ses-Y00", c("id", paste0(append(CT,volumes), "_wscore"))]
atrophy_mapping_group <- as.data.frame.list(colMeans(atrophy_mapping_individuals[,-1]))
write.csv(atrophy_mapping_individuals, here::here("data/PrograMS_atrophy_baseline_individual_wscore.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group, here::here("data/PrograMS_atrophy_baseline_group_wscore.csv"), row.names = FALSE)

# import parcel disconnection from LQT
list <- list.files(path=here("./data/Schaefer100_Subcortex_nodes/"),
                   pattern="*.node", full.names=TRUE, recursive=FALSE)
disconnection_files <- lapply(list,read.table)
regions <- disconnection_files[[1]][,6]
df_node_disconnection <- data.frame(matrix(nrow = length(disconnection_files), ncol = length(regions)+1))
colnames(df_node_disconnection) = c("ID",paste0(regions,"_disc")) 
for (i in 1:length(disconnection_files)) {
  df_node_disconnection$ID[i] <- substr(basename(list[i]),1,15)
  df_node_disconnection[i,2:ncol(df_node_disconnection)] <- t(disconnection_files[[i]][,5]) 
}

## write merged dataframe
save(df_PrograMS, file = here::here("data/df_PrograMS.RData"))
write.csv(df_PrograMS, here::here("data/df_PrograMS.csv"), row.names = FALSE)

```

```{r import/transform/merge clinical and structural MRI data - Freesurfer long}
### PrograMS clinical database
PrograMS <- read.csv(here::here("data/PrograMS_v1.9.csv"), header = TRUE, sep = ",")
PrograMS[c('Group','ClinicalPhenotype','DMT','Clinical','BRBn','NPSother')] <- lapply(PrograMS[c('Group','ClinicalPhenotype','DMT','Clinical','BRBn','NPSother')], factor)
PrograMS$Sex <- factor(PrograMS$Sex, levels = c("female", "male"))
PrograMS[c('DoB','DateMRI','DateOfOnset')] <- lapply(PrograMS[c('DoB','DateMRI','DateOfOnset')], as.Date, format = "%d/%m/%Y")
# standardize BRB scores
BRB_tests <- colnames(PrograMS)[grep('BRB_', colnames(PrograMS))] 
for (i in BRB_tests){
  MDL <- lm(get(i) ~ Age + Sex + Education_years, 
            data = PrograMS[PrograMS$Group=="HC" & PrograMS$Session=="ses-Y00",], 
            na.action = na.exclude)
  PrograMS[,paste0(i,'_wscore')] <- (PrograMS[,i] - predict(MDL, PrograMS)) / sd(MDL$residuals)
}
PrograMS$BRB_STROOP_wscore <- -1 * PrograMS$BRB_STROOP_wscore # flip sign for stroop
PrograMS$MissingBRBtests <- rowSums(is.na(PrograMS[,BRB_tests])) 

### sMRI derivatives
# import Freesurfer and LST outputs 
PrograMS_sMRI <- read.csv(here::here("data/PrograMS_FreesurferLong.csv"), header = TRUE, sep = ",")
df_PrograMS <- merge(PrograMS, PrograMS_sMRI, by = c("ID", "Session", "FullID"))
df_PrograMS <- clean_names(df_PrograMS)
## model atrophy
volumes <- c(paste("left", c("accumbens_area",
                             "amygdala",
                             "caudate",
                             "hippocampus",
                             "pallidum",
                             "putamen", 
                             "thalamus"),  
                  sep = "_"), 
             paste("right", c("accumbens_area",
                              "amygdala",
                              "caudate",
                              "hippocampus",
                              "pallidum",
                              "putamen",
                              "thalamus"),
                   sep = "_"))
CT <- colnames(df_PrograMS)[grep("_thickness",colnames(df_PrograMS))]
#################### longitudinal modelling ##############################
# growth models
df_PrograMS <- df_PrograMS %>%
  dplyr::group_by(id) %>%
  dplyr::mutate(n_scans=n()) # add number of scans
atrophy_mapping_individuals <- data.frame(matrix(nrow = length(unique(df_PrograMS$id)), ncol = length(append(volumes,CT))+1))
colnames(atrophy_mapping_individuals) = c("id", append(volumes,CT)) # individual slopes of atrophy over time
atrophy_mapping_group <- data.frame(matrix(nrow = 1, ncol = length(append(volumes,CT))))
colnames(atrophy_mapping_group) = c(append(volumes,CT)) # test statistic for the excess atrophy
for (i in append(volumes, CT)){
  MDL <- lme(as.formula(paste0(i, " ~ fu_time + group*fu_time")),
             data = df_PrograMS,
             random = ~fu_time|id, method="ML", na.action = na.exclude,
             correlation = corAR1(0, form = ~fu_time|id),
             control = list(msMaxIter = 1000, msMaxEval = 1000, sing.tol = 1e-20))
  atrophy_mapping_individuals$id <- row.names(coef(MDL))
  atrophy_mapping_individuals[,i] <- coef(MDL)$fu_time
  atrophy_mapping_group[,i] <- coef(summary(MDL))["fu_time:groupMS", "t-value"]
}
write.csv(atrophy_mapping_individuals, here::here("data/PrograMS_excessatrophy_long_individual_slopes.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group, here::here("data/PrograMS_excessatrophy_long_group_t-values.csv"), row.names = FALSE)
######################### longitudinal modelling ####################
```




```{r import/transform/merge clinical and structural MRI data - Freesurfer cross-sectional}
# model atrophy
df_PrograMS <- readRDS(here::here("data/df_PrograMS.RDS"))
df_PrograMS <- cbind(df_PrograMS, surf_to_atlas(df_PrograMS[, grep("^x+[0-9]_wscore$|^x.*.[0-9]_wscore$", colnames(df_PrograMS))], 4, mode = "mean"))



atrophy_mapping_individuals <- df_PrograMS[df_PrograMS$group=="MS" & df_PrograMS$session=="ses-Y00", c("id", paste0(append(CT,volumes), "_wscore"))]
atrophy_mapping_group <- as.data.frame.list(colMeans(atrophy_mapping_individuals[,-1]))
write.csv(atrophy_mapping_individuals, here::here("data/PrograMS_atrophy_baseline_individual_wscore.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group, here::here("data/PrograMS_atrophy_baseline_group_wscore.csv"), row.names = FALSE)

# import parcel disconnection from LQT
list <- list.files(path=here("./data/Schaefer100_Subcortex_nodes/"),
                   pattern="*.node", full.names=TRUE, recursive=FALSE)
disconnection_files <- lapply(list,read.table)
regions <- disconnection_files[[1]][,6]
df_node_disconnection <- data.frame(matrix(nrow = length(disconnection_files), ncol = length(regions)+1))
colnames(df_node_disconnection) = c("ID",paste0(regions,"_disc")) 
for (i in 1:length(disconnection_files)) {
  df_node_disconnection$ID[i] <- substr(basename(list[i]),1,15)
  df_node_disconnection[i,2:ncol(df_node_disconnection)] <- t(disconnection_files[[i]][,5]) 
}

## write merged dataframe
save(df_PrograMS, file = here::here("data/df_PrograMS.RData"))
write.csv(df_PrograMS, here::here("data/df_PrograMS.csv"), row.names = FALSE)








#################### longitudinal modelling ##############################
# growth models
df_PrograMS <- df_PrograMS %>%
  dplyr::group_by(id) %>%
  dplyr::mutate(n_scans=n()) # add number of scans
atrophy_mapping_individuals <- data.frame(matrix(nrow = length(unique(df_PrograMS$id)), ncol = length(append(volumes,CT))+1))
colnames(atrophy_mapping_individuals) = c("id", append(volumes,CT)) # individual slopes of atrophy over time
atrophy_mapping_group <- data.frame(matrix(nrow = 1, ncol = length(append(volumes,CT))))
colnames(atrophy_mapping_group) = c(append(volumes,CT)) # test statistic for the excess atrophy
for (i in append(volumes, CT)){
  MDL <- lme(as.formula(paste0(i, " ~ fu_time + group*fu_time")),
             data = df_PrograMS,
             random = ~fu_time|id, method="ML", na.action = na.exclude,
             correlation = corAR1(0, form = ~fu_time|id),
             control = list(msMaxIter = 1000, msMaxEval = 1000, sing.tol = 1e-20))
  atrophy_mapping_individuals$id <- row.names(coef(MDL))
  atrophy_mapping_individuals[,i] <- coef(MDL)$fu_time
  atrophy_mapping_group[,i] <- coef(summary(MDL))["fu_time:groupMS", "t-value"]
}
write.csv(atrophy_mapping_individuals, here::here("data/PrograMS_excessatrophy_long_individual_slopes.csv"), row.names = FALSE)
write.csv(atrophy_mapping_group, here::here("data/PrograMS_excessatrophy_long_group_t-values.csv"), row.names = FALSE)
######################### longitudinal modelling ####################
```



```{r import/transorm/merge functional MRI data}
load(here::here("data/df_PrograMS.RData"))

## import fMRI derivatives
dir_fmri <- "/data/anw/knw-work/g.pontillo/predictive_modelling/amsterdam/derivatives/xcpd_scrubbing"
list_subs <- grep("sub-*", list.dirs(dir_fmri, recursive = FALSE, full.names = FALSE), value = TRUE) # list of subjects  
list_pearson <- Sys.glob(file.path(dir_fmri,"sub-*","ses-Y00","func","*seg-SchaeferSubcortex119Parcels_stat-pearsoncorrelation_relmat.tsv")) # list of connectivity matrices 
atlas <- read.csv("/data/anw/knw-work/g.pontillo/predictive_modelling/code/MRI_processing/atlases/atlas-SchaeferSubcortex119Parcels_dseg.tsv", header = TRUE, sep = "\t") # atlas 
labels <- as.character(atlas[,"label"]) # atlas labels 
roi <- length(labels)
PrograMS_fMRI <- data.frame(matrix(nrow = length(list_subs), ncol = ((roi*(roi-1))/2)+1))
colnames(PrograMS_fMRI)[1] <- "ID"
index <- which(upper.tri(fc, diag = FALSE), arr.ind=TRUE)
for (i in 1:dim(index)[1]){
  colnames(df_fMRI)[1+i] <- paste0(labels[index[i,1]], 
                                   "_to_",
                                   labels[index[i,2]]) 
}
for (i in 1:length(list_subs)) {
  fisher <- grep(list_subs[i], list_fisher, value = TRUE)
  fc <- as.matrix(read.csv(fisher, header = TRUE, row.names = 1, sep = "\t"))
  fc_flat <- fc[upper.tri(fc, diag = FALSE)] # this equals to using numpy.tril as R is column-major 
  df_fMRI[i,1] <- list_subs[i] 
  df_fMRI[i,2:ncol(df_fMRI)] <- fc_flat
} 
df_fMRI[df_fMRI=="n/a"] <- 0 # put n/a to 0   
write.csv(df_fMRI, here::here("data/df_fMRI-scrubbing_amsterdam.csv"), row.names = FALSE)

# compute centrality
renv::deactivate() # renv has a problem with igraph, do this outside of environment
library(igraph)
```

```{r import/transorm/merge diffusion MRI data}
## import dMRI derivatives

# compute centrality

```

```{r vertex-level analyses}
library(VertexWiseR)
SURFvextract(sdirpath = "/data/anw/knw-work/g.pontillo/predictive_modelling/amsterdam/derivatives/freesurfer/ses-Y00/", filename = "freesurfer_ses-Y00.rds", template = "fsaverage5", measure = "thickness", subj_ID = TRUE)
```





